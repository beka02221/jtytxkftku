
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Special Snake PvP</title>

  <!-- Шрифт, аналогичный главному -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <!-- Основной CSS (можно вынести в отдельный файл) -->
  <link id="themeStylesheet" rel="stylesheet" href="st1.css">
  
  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* Основной стиль страницы – фон, шрифт, цвета */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Press Start 2P', sans-serif;
      background-color: #000;
      color: #0f0;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #111;
      border-bottom: 2px solid #0f0;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .balances span {
      margin-right: 10px;
    }
    /* Меню дизайна (гамбургер) */
    .hamburger-line {
      display: block;
      width: 20px;
      height: 2px;
      background-color: #0f0;
      margin: 4px 0;
    }
    #design-options {
      display: none;
      position: absolute;
      background: #222;
      border: 1px solid #0f0;
      padding: 10px;
      z-index: 100;
    }
    /* Описание игры */
    .game-info-container {
      padding: 10px;
      text-align: center;
    }
    .game-info-container img {
      width: 64px;
      height: 64px;
    }
    /* Блок поиска соперника */
    .game-search-container {
      text-align: center;
      margin-top: 20px;
    }
    @keyframes searching {
      0%   { opacity: 0.2; }
      50%  { opacity: 1;   }
      100% { opacity: 0.2; }
    }
    .search-animation {
      animation: searching 1.2s infinite;
      font-size: 14px;
    }
    .countdown-container {
      font-size: 18px;
      margin-top: 15px;
      color: #f80;
    }
    /* Игровая зона – вертикальное расположение */
    .game-area {
      text-align: center;
      margin-top: 20px;
    }
    /* Вертикальный Canvas: для мобильных – 300x500, для ПК – 400x600 */
    #snakeCanvas {
      background: #333;
      border: 2px solid #0f0;
      image-rendering: pixelated;
    }
    @media (max-width: 767px) {
      #snakeCanvas {
        width: 300px;
        height: 500px;
      }
    }
    @media (min-width: 768px) {
      #snakeCanvas {
        width: 400px;
        height: 600px;
      }
    }
    /* Верхняя полоска таймера */
    .game-timer-bar {
      margin: 10px auto;
      width: 80%;
      height: 12px;
      background: #555;
      border: 1px solid #0f0;
      position: relative;
    }
    .game-timer-fill {
      background: #0f0;
      width: 100%;
      height: 100%;
      transition: width 1s linear;
    }
    /* Модальное окно результатов */
    .endgame-backdrop, .modal-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .endgame-backdrop.active, .modal-backdrop.active {
      display: flex;
    }
    .endgame-modal, .modal {
      background: #222;
      border: 2px solid #0f0;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    /* Нижняя панель навигации скрыта */
    #mainNav {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Header с информацией о пользователе -->
  <header>
    <div class="user-info">
      <img id="userPhoto" src="" alt="Avatar"/>
      <span id="username">@User</span>
    </div>
    <div class="balances">
      <span>
        <img src="https://img.icons8.com/external-kmg-design-glyph-kmg-design/64/00FF00/external-ticket-cinema-kmg-design-glyph-kmg-design.png" alt="Tickets" width="20"/>
        <span id="ticketCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/coins.png" alt="Coins" width="20"/>
        <span id="coinCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/rating.png" alt="Points" width="20"/>
        <span id="pointCount">0</span>
      </span>
    </div>
    <div class="header-left" id="design-settings">
      <button onclick="toggleDesignMenu()">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
      <div id="design-options">
        <p onclick="changeDesign('st1.css')" style="cursor: pointer; margin: 5px 0;">Дизайн (применен)</p>
        <p onclick="changeDesign('st2.css')" style="cursor: pointer; margin: 5px 0;">Ретро дизайн</p>
        <p onclick="changeDesign('st3.css')" style="cursor: pointer; margin: 5px 0;">Киберпанк дизайн</p>
      </div>
    </div>
  </header>

  <!-- Основной контент -->
  <main>
    <!-- Блок с описанием игры -->
    <div class="game-info-container">
      <h2>Special Snake PvP</h2>
      <img src="https://img.icons8.com/ios-filled/50/00FF00/flash-on.png" alt="Special Game">
      <p>Мультиплеерная змейка 1 на 1. Стоимость: <strong>1 билет</strong>.</p>
    </div>

    <!-- Блок поиска соперника -->
    <div class="game-search-container" id="searchContainer">
      <p class="search-animation" id="searchStatus">Ищем соперника...</p>
    </div>

    <!-- Блок с найденным соперником и обратным отсчётом -->
    <div class="game-search-container" id="opponentContainer" style="display: none;">
      <p>Соперник найден!</p>
      <div style="display: flex; gap: 20px; justify-content: center;">
        <div>
          <img id="opponentPhoto" src="" alt="Opponent" style="width:50px; height:50px; border-radius:50%;" />
          <p id="opponentName">@Opponent</p>
        </div>
      </div>
      <div class="countdown-container">
        Начало через <span id="countdownValue">10</span>...
      </div>
    </div>

    <!-- Игровая зона: верхняя полоска таймера и Canvas -->
    <div class="game-area" id="gameArea" style="display: none;">
      <div class="game-timer-bar">
        <div class="game-timer-fill" id="timerFill"></div>
      </div>
      <canvas id="snakeCanvas" width="300" height="500"></canvas>
      <div style="margin-top: 10px;">
        <span id="playerScoreLabel">Вы: 0</span> | 
        <span id="opponentScoreLabel">Соперник: 0</span>
      </div>
    </div>
  </main>

  <!-- Модальное окно окончания игры -->
  <div class="endgame-backdrop" id="endgameBackdrop">
    <div class="endgame-modal">
      <h2 id="endgameTitle">Результат</h2>
      <p id="endgameMessage"></p>
      <button class="close-modal" onclick="finishGame()">Продолжить</button>
    </div>
  </div>

  <!-- Скрипты: Firebase, логика онлайн-игры и синхронизации -->
  <script>
    /* ----------------------------------------------
       1. Firebase Initialization – замените параметры на свои
    ---------------------------------------------- */
   const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ----------------------------------------------
       2. Telegram Web App
    ---------------------------------------------- */
    const tg = window.Telegram.WebApp;
    tg.expand();

    /* ----------------------------------------------
       3. Глобальные переменные
    ---------------------------------------------- */
    let currentUser = null;
    let userRef = null;
    let localUserData = {
      photo: '',
      tickets: 0,
      coins: 0,
      points: 0
    };

    // Данные соперника – в реальной игре будут получаться из Firebase
    let opponentData = {
      username: '',
      photo: ''
    };

    let gameStarted = false;
    let countdownInterval = null;
    let gameTimerInterval = null;
    let timeLeft = 60; // 60 секунд раунда
    let playerScore = 0;
    let opponentScore = 0;

    // Положение и параметры змейки игрока
    let snake = {
      x: 5,
      y: 5,
      direction: 'RIGHT',
      body: [{x:5, y:5}],
      color: '#0f0'
    };
    // Положение змейки соперника (будет обновляться через Firebase)
    let snakeOpponent = {
      x: 10,
      y: 10,
      direction: 'LEFT',
      body: [{x:10, y:10}],
      color: '#f00'
    };

    // Параметры сетки и тайла
    let gridSize = 20;
    let tileSize = 25; // Размер одного блока в пикселях (игровая сетка)
    let apple = { x: 7, y: 7 };

    /* ----------------------------------------------
       4. Получение данных текущего пользователя
    ---------------------------------------------- */
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
      document.getElementById('username').textContent = '@' + currentUser.username;
      if (currentUser.photo_url) {
        document.getElementById('userPhoto').src = currentUser.photo_url;
      }
      userRef = db.ref('users/' + currentUser.username);
      userRef.once('value', snapshot => {
        if (!snapshot.exists()) {
          userRef.set({
            photo: currentUser.photo_url || '',
            tickets: 0,
            coins: 0,
            points: 0
          });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData = data;
        updateTopBar();
      });
    }

    /* ----------------------------------------------
       5. Обновление верхней панели
    ---------------------------------------------- */
    function updateTopBar() {
      document.getElementById('ticketCount').textContent = localUserData.tickets || 0;
      document.getElementById('coinCount').textContent   = localUserData.coins || 0;
      document.getElementById('pointCount').textContent  = localUserData.points || 0;
    }

    /* ----------------------------------------------
       6. Меню дизайна
    ---------------------------------------------- */
    function toggleDesignMenu() {
      const menu = document.getElementById('design-options');
      menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
    }
    function changeDesign(theme) {
      document.getElementById('themeStylesheet').setAttribute('href', theme);
      toggleDesignMenu();
    }

    /* ----------------------------------------------
       7. Старт игры: проверка билетов и поиск соперника
    ---------------------------------------------- */
    window.onload = function() {
      // Игра стоит 1 билет – проверяем наличие
      if ((localUserData.tickets || 0) < 1) {
        alert('У вас недостаточно билетов для игры.');
        window.location.href = 'index.html';
        return;
      }
      // Списываем 1 билет
      localUserData.tickets -= 1;
      updateTopBar();
      if (userRef) {
        userRef.update({ tickets: localUserData.tickets });
      }
      // Запускаем поиск соперника через Firebase (псевдокод)
      searchForOpponent();
    };

    function searchForOpponent() {
      /* 
        Здесь необходимо реализовать логику поиска реального соперника через Firebase.
        Например, можно создать узел /games/{gameId} и ждать подключения второго игрока.
        В этом примере через 3 секунды имитируется нахождение соперника.
      */
      setTimeout(() => {
        // Предположим, что данные соперника получены из Firebase:
        opponentData.username = 'cool_gamer123';
        opponentData.photo = 'https://img.icons8.com/ios-filled/50/00FF00/user-male.png';
        document.getElementById('opponentPhoto').src = opponentData.photo;
        document.getElementById('opponentName').textContent = '@' + opponentData.username;
        // Также сохраняем данные в Firebase для синхронизации (псевдокод)
        db.ref('games/currentGame/opponent').set({
          username: opponentData.username,
          photo: opponentData.photo
        });
        document.getElementById('searchContainer').style.display = 'none';
        document.getElementById('opponentContainer').style.display = 'block';
        startCountdown();
      }, 3000);
    }

    /* ----------------------------------------------
       8. Обратный отсчёт (10 сек) до начала игры
    ---------------------------------------------- */
    function startCountdown() {
      let count = 10;
      document.getElementById('countdownValue').textContent = count;
      countdownInterval = setInterval(() => {
        count--;
        document.getElementById('countdownValue').textContent = count;
        if (count <= 0) {
          clearInterval(countdownInterval);
          startGame();
        }
      }, 1000);
    }

    /* ----------------------------------------------
       9. Запуск игры
         – Отображение игровой зоны.
         – Инициализация таймера раунда (1 минута).
         – Запуск игрового цикла через requestAnimationFrame для плавности.
         – Отправка позиции змейки игрока и получение данных соперника через Firebase (псевдокод).
    ---------------------------------------------- */
    function startGame() {
      document.getElementById('opponentContainer').style.display = 'none';
      document.getElementById('gameArea').style.display = 'block';
      gameStarted = true;
      timeLeft = 60;
      updateTimerBar();
      // Запускаем таймер игрового раунда
      gameTimerInterval = setInterval(() => {
        timeLeft--;
        updateTimerBar();
        if (timeLeft <= 0) {
          clearInterval(gameTimerInterval);
          endGame();
        }
      }, 1000);
      // Запускаем игровой цикл через requestAnimationFrame
      requestAnimationFrame(gameLoop);
      // Обработчики клавиатуры для ПК
      document.addEventListener('keydown', handleKeyDown);
      // Настройка touch-событий для мобильных
      setupTouchControls();
      // Подписываемся на обновления змейки соперника из Firebase (псевдокод)
      subscribeToOpponentUpdates();
    }

    /* ----------------------------------------------
       10. Игровой цикл с использованием requestAnimationFrame
    ---------------------------------------------- */
    function gameLoop() {
      if (!gameStarted) return;
      // Обновляем положение змейки игрока и соперника
      updateSnake(snake);
      // Для соперника – обновляем данные из Firebase (функция subscribeToOpponentUpdates обновляет snakeOpponent)
      // Проверяем столкновение с яблоком
      checkApple(snake, true);
      checkApple(snakeOpponent, false);
      // Рисуем игровую сцену
      drawScene();
      // Отправляем данные о текущей позиции змейки игрока в Firebase (псевдокод)
      db.ref('games/currentGame/player').set({
        x: snake.x,
        y: snake.y,
        body: snake.body,
        direction: snake.direction
      });
      // Плавное обновление
      requestAnimationFrame(gameLoop);
    }

    function updateSnake(snk) {
      // Передвинуть голову согласно направлению
      if (snk.direction === 'LEFT')  snk.x--;
      if (snk.direction === 'RIGHT') snk.x++;
      if (snk.direction === 'UP')    snk.y--;
      if (snk.direction === 'DOWN')  snk.y++;
      // Обёртка: при выходе за край – появление с противоположной стороны
      if (snk.x < 0) snk.x = gridSize - 1;
      if (snk.x >= gridSize) snk.x = 0;
      if (snk.y < 0) snk.y = gridSize - 1;
      if (snk.y >= gridSize) snk.y = 0;
      // Добавляем новую позицию в тело
      snk.body.unshift({x: snk.x, y: snk.y});
      snk.body.pop();
    }

    function checkApple(snk, isPlayer) {
      if (snk.x === apple.x && snk.y === apple.y) {
        if (isPlayer) {
          playerScore++;
          document.getElementById('playerScoreLabel').textContent = `Вы: ${playerScore}`;
        } else {
          opponentScore++;
          document.getElementById('opponentScoreLabel').textContent = `Соперник: ${opponentScore}`;
        }
        // Перемещаем яблоко в случайное место
        apple.x = Math.floor(Math.random() * gridSize);
        apple.y = Math.floor(Math.random() * gridSize);
      }
    }

    function drawScene() {
      const canvas = document.getElementById('snakeCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Рисуем змейку игрока
      drawSnake(ctx, snake, 'You');
      // Рисуем змейку соперника
      drawSnake(ctx, snakeOpponent, opponentData.username || 'Opp');
      // Рисуем яблоко
      ctx.fillStyle = '#ff0';
      ctx.fillRect(apple.x * tileSize, apple.y * tileSize, tileSize, tileSize);
    }

    function drawSnake(ctx, snk, name) {
      ctx.fillStyle = snk.color;
      snk.body.forEach(part => {
        ctx.fillRect(part.x * tileSize, part.y * tileSize, tileSize, tileSize);
      });
      // Отображаем имя над головой змейки
      ctx.fillStyle = '#fff';
      ctx.font = '8px "Press Start 2P"';
      ctx.fillText(name, snk.body[0].x * tileSize, snk.body[0].y * tileSize - 2);
    }

    /* ----------------------------------------------
       11. Обработка клавиатурных событий и свайпов
    ---------------------------------------------- */
    function handleKeyDown(e) {
      if (e.key === 'ArrowLeft' && snake.direction !== 'RIGHT')  snake.direction = 'LEFT';
      else if (e.key === 'ArrowRight' && snake.direction !== 'LEFT')  snake.direction = 'RIGHT';
      else if (e.key === 'ArrowUp' && snake.direction !== 'DOWN')  snake.direction = 'UP';
      else if (e.key === 'ArrowDown' && snake.direction !== 'UP')  snake.direction = 'DOWN';
    }
    function setupTouchControls() {
      let touchStartX = 0, touchStartY = 0;
      document.addEventListener('touchstart', (e) => {
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
      }, false);
      document.addEventListener('touchmove', (e) => {
        e.preventDefault();
      }, { passive: false });
      document.addEventListener('touchend', (e) => {
        let touchEndX = e.changedTouches[0].clientX;
        let touchEndY = e.changedTouches[0].clientY;
        let diffX = touchEndX - touchStartX;
        let diffY = touchEndY - touchStartY;
        if (Math.abs(diffX) > Math.abs(diffY)) {
          if (diffX > 0 && snake.direction !== 'LEFT') snake.direction = 'RIGHT';
          else if (diffX < 0 && snake.direction !== 'RIGHT') snake.direction = 'LEFT';
        } else {
          if (diffY > 0 && snake.direction !== 'UP') snake.direction = 'DOWN';
          else if (diffY < 0 && snake.direction !== 'DOWN') snake.direction = 'UP';
        }
      }, false);
    }

    /* ----------------------------------------------
       12. Обновление полоски таймера
    ---------------------------------------------- */
    function updateTimerBar() {
      const percent = (timeLeft / 60) * 100;
      document.getElementById('timerFill').style.width = percent + '%';
    }

    /* ----------------------------------------------
       13. Подписка на обновления позиции змейки соперника из Firebase
         (Псевдокод – в реальном проекте обновляйте snakeOpponent через snapshot)
    ---------------------------------------------- */
    function subscribeToOpponentUpdates() {
      db.ref('games/currentGame/player2').on('value', snapshot => {
        const data = snapshot.val();
        if (data) {
          // Обновляем позицию и тело змейки соперника
          snakeOpponent.x = data.x;
          snakeOpponent.y = data.y;
          snakeOpponent.body = data.body;
          snakeOpponent.direction = data.direction;
        }
      });
    }

    /* ----------------------------------------------
       14. Окончание игры
    ---------------------------------------------- */
    function endGame() {
      gameStarted = false;
      const resultText = playerScore > opponentScore
        ? 'Вы победили!'
        : (playerScore === opponentScore ? 'Ничья!' : 'Вы проиграли...');
      document.getElementById('endgameTitle').textContent = 'Игра завершена!';
      document.getElementById('endgameMessage').textContent = `Ваш счёт: ${playerScore}, счёт соперника: ${opponentScore}. ${resultText}`;
      document.getElementById('endgameBackdrop').classList.add('active');
      // Обновляем очки игрока в Firebase (пример начисления баллов)
      let pointsEarned = (playerScore > opponentScore) ? 10 : (playerScore === opponentScore ? 5 : 2);
      localUserData.points = (localUserData.points || 0) + pointsEarned;
      if (userRef) userRef.update({ points: localUserData.points });
    }

    /* ----------------------------------------------
       15. Завершение игры и возврат на главную страницу
    ---------------------------------------------- */
    function finishGame() {
      document.getElementById('endgameBackdrop').classList.remove('active');
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
