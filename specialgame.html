<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Special Snake PvP</title>

  <!-- Шрифт (как на главной) -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <!-- Стили -->
  <link id="themeStylesheet" rel="stylesheet" href="st1.css">

  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #0f0;
      font-family: 'Press Start 2P', sans-serif;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: #111;
      border-bottom: 2px solid #0f0;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .balances span {
      margin-right: 10px;
    }
    .hamburger-line {
      display: block;
      width: 20px;
      height: 2px;
      background-color: #0f0;
      margin: 4px 0;
    }
    #design-options {
      display: none;
      position: absolute;
      background: #222;
      border: 1px solid #0f0;
      padding: 10px;
      z-index: 99;
    }
    main {
      position: relative;
      width: 100vw;
      height: calc(100vh - 58px); /* высота экрана - высота хедера */
      overflow: hidden;
    }

    /* Поиск соперника */
    .search-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    @keyframes searching {
      0%   { opacity: 0.2; }
      50%  { opacity: 1;   }
      100% { opacity: 0.2; }
    }
    .search-animation {
      animation: searching 1.2s infinite;
      font-size: 16px;
      margin-top: 10px;
    }
    .opponent-found {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .opponent-found img {
      border-radius: 50%;
      width: 60px;
      height: 60px;
    }

    /* Игровая зона */
    .game-container {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      display: none; /* Появится при старте */
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .timer-bar {
      margin: 5px 0;
      width: 80%;
      height: 12px;
      background: #555;
      border: 1px solid #0f0;
      position: relative;
    }
    .timer-fill {
      background: #0f0;
      width: 100%;
      height: 100%;
      transition: width 1s linear;
    }
    .scores {
      margin: 5px 0;
    }
    #snakeCanvas {
      flex: 1;
      width: 100%;
      height: 100%;
      background: #333;
      border-top: 2px solid #0f0;
      border-bottom: 2px solid #0f0;
      image-rendering: pixelated;
    }

    /* Модалки */
    .modal-backdrop, .endgame-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-backdrop.active, .endgame-backdrop.active {
      display: flex;
    }
    .modal, .endgame-modal {
      background: #222;
      border: 2px solid #0f0;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Шапка -->
  <header>
    <div class="user-info">
      <img id="userPhoto" src="" alt="Avatar"/>
      <span id="username">@User</span>
    </div>
    <div class="balances">
      <span>
        <img src="https://img.icons8.com/external-kmg-design-glyph-kmg-design/64/00FF00/external-ticket-cinema-kmg-design-glyph-kmg-design.png"
             alt="Tickets" width="20"/>
        <span id="ticketCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/coins.png"
             alt="Coins" width="20"/>
        <span id="coinCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/rating.png"
             alt="Points" width="20"/>
        <span id="pointCount">0</span>
      </span>
    </div>
    <div class="header-left" id="design-settings" style="position:relative;">
      <button onclick="toggleDesignMenu()">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
      <div id="design-options">
        <p onclick="changeDesign('st1.css')">Дизайн (применён)</p>
        <p onclick="changeDesign('st2.css')">Ретро дизайн</p>
        <p onclick="changeDesign('st3.css')">Киберпанк дизайн</p>
      </div>
    </div>
  </header>

  <!-- Основная часть -->
  <main>
    <!-- Экран поиска соперника -->
    <div id="searchView" class="search-container">
      <div id="searchBlock">
        <h2>Мультиплеерная Змейка (2 минуты)</h2>
        <p>Стоимость: 1 билет</p>
        <div class="search-animation">Ищем соперника...</div>
      </div>
      <div id="foundBlock" style="display:none;" class="opponent-found">
        <h2>Соперник найден!</h2>
        <img id="opponentPhoto" src="" alt="Opponent" />
        <p id="opponentName">@Opponent</p>
        <p>Начало через <span id="countdownValue">5</span>...</p>
      </div>
    </div>

    <!-- Игровая зона (Canvas) -->
    <div id="gameArea" class="game-container">
      <div class="timer-bar">
        <div class="timer-fill" id="timerFill"></div>
      </div>
      <div class="scores">
        <span id="playerScoreLabel">Вы: 0</span> |
        <span id="opponentScoreLabel">Соперник: 0</span>
      </div>
      <canvas id="snakeCanvas"></canvas>
    </div>
  </main>

  <!-- Модалка "нет билетов" -->
  <div class="modal-backdrop" id="noTicketsModal">
    <div class="modal">
      <h2>Недостаточно билетов</h2>
      <p>У вас нет билетов для участия в игре.</p>
      <button onclick="returnToMain()">Вернуться</button>
    </div>
  </div>

  <!-- Модалка окончания игры -->
  <div class="endgame-backdrop" id="endgameBackdrop">
    <div class="endgame-modal">
      <h2 id="endgameTitle">Игра завершена!</h2>
      <p id="endgameMessage"></p>
      <button onclick="finishGame()">Продолжить</button>
    </div>
  </div>

  <script>
    /* ----------------------------------------------
       1. Firebase Initialization
    ---------------------------------------------- */
   const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ----------------------------------------------
       2. Telegram Web App
    ---------------------------------------------- */
    const tg = window.Telegram.WebApp;
    tg.expand();

    /* ----------------------------------------------
       3. Глобальные переменные
    ---------------------------------------------- */
    let currentUser = null;
    let userRef = null;
    let localUserData = { tickets: 0, coins: 0, points: 0 };

    let opponentData = { username: '', photo: '' };
    let gameId = null;
    let isHost = false;

    let gameStarted = false;
    let countdownInterval = null;
    let timeLeft = 120;  // 2 минуты
    let gameTimer = null;

    let playerScore = 0;
    let opponentScore = 0;

    // Змейка игрока
    let snake = {
      x: 5, y: 5,
      direction: 'RIGHT',
      body: [{x:5,y:5}],
      color: '#0f0'
    };
    // Соперник
    let snakeOpponent = {
      x: 15, y: 15,
      direction: 'LEFT',
      body: [{x:15,y:15}],
      color: '#f00'
    };

    // Поле
    let gridCols = 20;
    let gridRows = 30;
    let tileSizeX = 0;
    let tileSizeY = 0;
    let apple = { x: 10, y: 10 };

    // Скорость (втрое медленнее, ~450мс/шаг)
    let snakeSpeed = 450;
    let lastMoveTime = 0;

    /* ----------------------------------------------
       4. Считываем данные юзера из TG и Firebase
    ---------------------------------------------- */
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
      document.getElementById('username').textContent = '@' + currentUser.username;
      if (currentUser.photo_url) {
        document.getElementById('userPhoto').src = currentUser.photo_url;
      }
      userRef = db.ref('users/' + currentUser.username);

      // Делаем matchmaking ТОЛЬКО после того,
      // как загрузим данные localUserData
      userRef.once('value').then(snap => {
        if (!snap.exists()) {
          userRef.set({
            photo: currentUser.photo_url || '',
            tickets: 0,
            coins: 0,
            points: 0
          });
          localUserData = { photo: currentUser.photo_url || '', tickets: 0, coins: 0, points: 0 };
        } else {
          localUserData = snap.val();
        }
        updateTopBar();
        // Подключаем listener на изменения баланса
        userRef.on('value', (s2) => {
          localUserData = s2.val() || {};
          updateTopBar();
        });

        // После загрузки – запускаем поиск
        startMatchmaking();
      });
    }

    /* ----------------------------------------------
       5. Функция startMatchmaking
         Если билетов нет – модалка "нет билетов"
         Иначе начинаем искать соперника
    ---------------------------------------------- */
    function startMatchmaking() {
      if ((localUserData.tickets || 0) < 1) {
        document.getElementById('noTicketsModal').classList.add('active');
        return;
      }
      // Реальная логика matchmaking (упрощённо):
      const mmRef = db.ref('matchmaking');
      mmRef.once('value', snap => {
        const data = snap.val() || {};
        const other = Object.keys(data).find(u => u !== currentUser.username);
        if (other) {
          // Нашли соперника
          gameId = currentUser.username + '_vs_' + other;
          isHost = false;
          // Удаляем записи в matchmaking
          db.ref('matchmaking/' + other).remove();
          db.ref('matchmaking/' + currentUser.username).remove();
          createGameNode(other);
        } else {
          // Становимся в очередь
          isHost = true;
          mmRef.child(currentUser.username).set({ time: Date.now() });
          // Ждём, пока кто-то придёт
          mmRef.on('value', (snap2) => {
            const d2 = snap2.val() || {};
            const partner = Object.keys(d2).find(u => u !== currentUser.username);
            if (partner) {
              // нашёлся
              gameId = currentUser.username + '_vs_' + partner;
              db.ref('matchmaking/' + partner).remove();
              db.ref('matchmaking/' + currentUser.username).remove();
              createGameNode(partner);
            }
          });
        }
      });
    }

    function createGameNode(opponentName) {
      const gRef = db.ref('games/' + gameId);
      gRef.set({
        player1: {
          username: currentUser.username,
          photo: currentUser.photo_url || '',
          snake: snake
        },
        player2: {
          username: opponentName,
          photo: '',
          snake: snakeOpponent
        },
        apple: apple,
        timeLeft: 120
      }).then(() => {
        initGameSubscriptions();
      });
    }

    /* ----------------------------------------------
       6. Подписки на узел игры (games/{gameId})
         - Получаем данные соперника, яблока и т.д.
    ---------------------------------------------- */
    function initGameSubscriptions() {
      const gRef = db.ref('games/' + gameId);

      gRef.child('player1').on('value', snap => {
        const val = snap.val() || {};
        if (val.username !== currentUser.username) {
          // Это соперник
          opponentData.username = val.username || '';
          opponentData.photo = val.photo || '';
          if (val.snake) snakeOpponent = val.snake;
        }
      });
      gRef.child('player2').on('value', snap => {
        const val = snap.val() || {};
        if (val.username !== currentUser.username) {
          opponentData.username = val.username || '';
          opponentData.photo = val.photo || '';
          if (val.snake) snakeOpponent = val.snake;
        }
      });
      gRef.child('apple').on('value', snap => {
        apple = snap.val() || apple;
      });

      // Когда известно имя соперника, грузим его фото и показываем "Opponent Found"
      gRef.once('value', full => {
        const obj = full.val() || {};
        const p1 = obj.player1 || {};
        const p2 = obj.player2 || {};
        let oppName = (p1.username !== currentUser.username) ? p1.username : p2.username;
        db.ref('users/' + oppName).once('value').then(sopp => {
          const oppVal = sopp.val() || {};
          opponentData.username = oppName;
          opponentData.photo = oppVal.photo || '';
          showOpponentFound();
        });
      });
    }

    /* ----------------------------------------------
       7. Показываем "Соперник найден", без списания билетов здесь
         Запускаем 5-сек обратный отсчёт
         Только когда действительно начинаем матч — списываем билет
    ---------------------------------------------- */
    function showOpponentFound() {
      document.getElementById('searchBlock').style.display = 'none';
      document.getElementById('foundBlock').style.display = 'block';

      document.getElementById('opponentPhoto').src = opponentData.photo || 'https://img.icons8.com/ios-filled/50/00FF00/user.png';
      document.getElementById('opponentName').textContent = '@' + opponentData.username;

      let c = 5;
      document.getElementById('countdownValue').textContent = c;
      countdownInterval = setInterval(() => {
        c--;
        document.getElementById('countdownValue').textContent = c;
        if (c <= 0) {
          clearInterval(countdownInterval);
          startGame(); // вот теперь начнётся игра
        }
      }, 1000);
    }

    /* ----------------------------------------------
       8. Старт матча
         - Только здесь тратится билет,
           потому что матч подтверждён и не прервали поиск
    ---------------------------------------------- */
    function startGame() {
      // Проверяем, остался ли у нас билет (вдруг игрок потратил пока ждали)
      if ((localUserData.tickets || 0) < 1) {
        document.getElementById('noTicketsModal').classList.add('active');
        return;
      }
      // Списываем
      localUserData.tickets -= 1;
      if (userRef) {
        userRef.update({ tickets: localUserData.tickets });
      }
      updateTopBar();

      document.getElementById('searchView').style.display = 'none';
      const gameArea = document.getElementById('gameArea');
      gameArea.style.display = 'flex';

      // Полноэкранный Canvas
      const canvas = document.getElementById('snakeCanvas');
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      tileSizeX = canvas.width / gridCols;
      tileSizeY = canvas.height / gridRows;

      gameStarted = true;
      timeLeft = 120;
      updateTimerBar();

      // Запуск 2-минутного таймера
      gameTimer = setInterval(() => {
        timeLeft--;
        db.ref('games/' + gameId + '/timeLeft').set(timeLeft);
        updateTimerBar();
        if (timeLeft <= 0) {
          clearInterval(gameTimer);
          endGame();
        }
      }, 1000);

      document.addEventListener('keydown', handleKeyDown);
      setupTouchControls();
      requestAnimationFrame(gameLoop);
    }

    /* ----------------------------------------------
       9. Игровой цикл (через rAF)
    ---------------------------------------------- */
    function gameLoop(timestamp) {
      if (!gameStarted) return;

      if (timestamp - lastMoveTime > snakeSpeed) {
        lastMoveTime = timestamp;
        // Двигаем свою змейку
        updateSnake(snake, true);
        // Проверяем яблоко
        checkApple(snake, true);
        checkApple(snakeOpponent, false);

        // Сохраняем своё состояние (player1 или player2)
        const me = isHost ? 'player1' : 'player2';
        db.ref('games/' + gameId + '/' + me + '/snake').set(snake);
        db.ref('games/' + gameId + '/apple').set(apple);
      }

      drawScene();
      requestAnimationFrame(gameLoop);
    }

    /* ----------------------------------------------
       10. Логика движения змей
    ---------------------------------------------- */
    function updateSnake(snk, isPlayer) {
      if (snk.direction === 'LEFT')  snk.x--;
      else if (snk.direction === 'RIGHT') snk.x++;
      else if (snk.direction === 'UP')    snk.y--;
      else if (snk.direction === 'DOWN')  snk.y++;

      // Обёртка
      if (snk.x < 0) snk.x = gridCols - 1;
      if (snk.x >= gridCols) snk.x = 0;
      if (snk.y < 0) snk.y = gridRows - 1;
      if (snk.y >= gridRows) snk.y = 0;

      snk.body.unshift({ x: snk.x, y: snk.y });
      snk.body.pop();
    }

    /* ----------------------------------------------
       11. Проверка яблока
    ---------------------------------------------- */
    function checkApple(snk, isPlayer) {
      if (snk.x === apple.x && snk.y === apple.y) {
        if (isPlayer) {
          playerScore++;
          document.getElementById('playerScoreLabel').textContent = `Вы: ${playerScore}`;
        } else {
          opponentScore++;
          document.getElementById('opponentScoreLabel').textContent = `Соперник: ${opponentScore}`;
        }
        // Новые координаты яблока
        apple.x = Math.floor(Math.random() * gridCols);
        apple.y = Math.floor(Math.random() * gridRows);
      }
    }

    /* ----------------------------------------------
       12. Отрисовка на Canvas
    ---------------------------------------------- */
    function drawScene() {
      const canvas = document.getElementById('snakeCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Игрок
      drawSnake(ctx, snake, 'You');
      // Соперник
      drawSnake(ctx, snakeOpponent, opponentData.username || 'Opp');

      // Яблоко
      ctx.fillStyle = '#ff0';
      ctx.fillRect(apple.x * tileSizeX, apple.y * tileSizeY, tileSizeX, tileSizeY);
    }
    function drawSnake(ctx, snk, label) {
      ctx.fillStyle = snk.color;
      snk.body.forEach(part => {
        ctx.fillRect(part.x * tileSizeX, part.y * tileSizeY, tileSizeX, tileSizeY);
      });
      // Имя над головой
      ctx.fillStyle = '#fff';
      ctx.font = '10px "Press Start 2P"';
      ctx.fillText(label, snk.body[0].x * tileSizeX, snk.body[0].y * tileSizeY - 2);
    }

    /* ----------------------------------------------
       13. Управление (клавиатура + свайпы)
    ---------------------------------------------- */
    function handleKeyDown(e) {
      if (e.key === 'ArrowLeft' && snake.direction !== 'RIGHT') snake.direction = 'LEFT';
      else if (e.key === 'ArrowRight' && snake.direction !== 'LEFT') snake.direction = 'RIGHT';
      else if (e.key === 'ArrowUp' && snake.direction !== 'DOWN') snake.direction = 'UP';
      else if (e.key === 'ArrowDown' && snake.direction !== 'UP') snake.direction = 'DOWN';
    }
    function setupTouchControls() {
      let startX = 0, startY = 0;
      document.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      }, false);
      document.addEventListener('touchmove', (e) => {
        e.preventDefault();
      }, { passive: false });
      document.addEventListener('touchend', (e) => {
        let endX = e.changedTouches[0].clientX;
        let endY = e.changedTouches[0].clientY;
        let diffX = endX - startX;
        let diffY = endY - startY;
        if (Math.abs(diffX) > Math.abs(diffY)) {
          if (diffX > 0 && snake.direction !== 'LEFT') snake.direction = 'RIGHT';
          else if (diffX < 0 && snake.direction !== 'RIGHT') snake.direction = 'LEFT';
        } else {
          if (diffY > 0 && snake.direction !== 'UP') snake.direction = 'DOWN';
          else if (diffY < 0 && snake.direction !== 'DOWN') snake.direction = 'UP';
        }
      }, false);
    }

    /* ----------------------------------------------
       14. Обновление таймера
    ---------------------------------------------- */
    function updateTimerBar() {
      const p = (timeLeft / 120) * 100;
      document.getElementById('timerFill').style.width = p + '%';
    }

    /* ----------------------------------------------
       15. Окончание матча
    ---------------------------------------------- */
    function endGame() {
      gameStarted = false;
      document.getElementById('gameArea').style.display = 'none';

      let res = '';
      if (playerScore > opponentScore) res = 'Вы победили!';
      else if (playerScore < opponentScore) res = 'Вы проиграли...';
      else res = 'Ничья!';

      document.getElementById('endgameMessage').textContent =
        `Ваш счёт: ${playerScore}, Соперник: ${opponentScore}. ${res}`;
      document.getElementById('endgameBackdrop').classList.add('active');

      // Начислим очки
      let pointsAdd = (playerScore > opponentScore)? 10 : (playerScore === opponentScore ? 5 : 2);
      localUserData.points = (localUserData.points || 0) + pointsAdd;
      if (userRef) {
        userRef.update({ points: localUserData.points });
      }

      // (Опционально) Удалим запись об игре
      db.ref('games/' + gameId).remove();
      db.ref('matchmaking/' + currentUser.username).remove();
    }

    /* ----------------------------------------------
       16. Кнопка "Продолжить"
    ---------------------------------------------- */
    function finishGame() {
      document.getElementById('endgameBackdrop').classList.remove('active');
      window.location.href = 'index.html';
    }

    /* ----------------------------------------------
       17. Модалка "нет билетов" – кнопка "Вернуться"
    ---------------------------------------------- */
    function returnToMain() {
      document.getElementById('noTicketsModal').classList.remove('active');
      window.location.href = 'index.html';
    }

    /* ----------------------------------------------
       18. Меню дизайна
    ---------------------------------------------- */
    function toggleDesignMenu() {
      const menu = document.getElementById('design-options');
      menu.style.display = (menu.style.display === '' || menu.style.display === 'none')
                           ? 'block' : 'none';
    }
    function changeDesign(theme) {
      document.getElementById('themeStylesheet').setAttribute('href', theme);
      toggleDesignMenu();
    }
  </script>
</body>
</html>
