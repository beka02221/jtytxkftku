<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Special Snake PvP</title>

  <!-- Шрифт -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Основная тема -->
  <link id="themeStylesheet" rel="stylesheet" href="st1.css">

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Press Start 2P', sans-serif;
      background-color: #000;
      color: #0f0;
      overflow: hidden;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #111;
      border-bottom: 2px solid #0f0;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-info img {
      width: 40px; height: 40px; border-radius: 50%;
    }
    .balances span { margin-right: 10px; }
    .hamburger-line {
      display: block; width: 20px; height: 2px;
      background-color: #0f0; margin: 4px 0;
    }
    #design-options {
      display: none; position: absolute;
      background: #222; border: 1px solid #0f0;
      padding: 10px; z-index: 999;
    }

    /* Описание игры */
    .game-info-container { text-align: center; padding: 10px; }
    .game-search-container {
      text-align: center; margin-top: 20px;
    }
    @keyframes searching {
      0% { opacity: 0.2; }
      50% { opacity: 1; }
      100% { opacity: 0.2; }
    }
    .search-animation {
      animation: searching 1.2s infinite;
      font-size: 14px;
    }

    /* Игровая зона */
    .game-area {
      width: 600px; height: 600px;
      margin: 0 auto; padding-bottom: 20px;
      display: none; /* показываем, когда игра начинается */
      position: relative;
    }
    #snakeCanvas {
      width: 600px; height: 600px;
      background: #333; border: 2px solid #0f0;
      image-rendering: pixelated;
    }

    .game-timer-bar {
      width: 300px; height: 12px;
      background: #555; border: 1px solid #0f0;
      margin: 10px auto; position: relative;
    }
    .game-timer-fill {
      background: #0f0;
      width: 100%; height: 100%;
      transition: width 1s linear;
    }
    .scores {
      margin-top: 10px;
      text-align: center;
      font-size: 14px;
    }

    /* Модалки */
    .modal-backdrop, .endgame-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none; justify-content: center; align-items: center;
      z-index: 9999;
    }
    .modal-backdrop.active, .endgame-backdrop.active {
      display: flex;
    }
    .modal, .endgame-modal {
      background: #222; border: 2px solid #0f0;
      padding: 20px; width: 90%; max-width: 400px; text-align: center;
    }

    /* Скрываем нижнюю панель (если была) */
    #mainNav { display: none; }
  </style>
</head>
<body>
  <!-- Шапка -->
  <header>
    <div class="user-info">
      <img id="userPhoto" src="" alt="Avatar"/>
      <span id="username">@User</span>
    </div>
    <div class="balances">
      <span>
        <img src="https://img.icons8.com/external-kmg-design-glyph-kmg-design/64/00FF00/external-ticket-cinema-kmg-design-glyph-kmg-design.png"
             alt="Tickets" width="20"/>
        <span id="ticketCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/coins.png"
             alt="Coins" width="20"/>
        <span id="coinCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/rating.png"
             alt="Points" width="20"/>
        <span id="pointCount">0</span>
      </span>
    </div>
    <div class="header-left" id="design-settings">
      <button onclick="toggleDesignMenu()">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
      <div id="design-options">
        <p onclick="changeDesign('st1.css')" style="cursor: pointer; margin: 5px 0;">Дизайн (применен)</p>
        <p onclick="changeDesign('st2.css')" style="cursor: pointer; margin: 5px 0;">Ретро дизайн</p>
        <p onclick="changeDesign('st3.css')" style="cursor: pointer; margin: 5px 0;">Киберпанк дизайн</p>
      </div>
    </div>
  </header>

  <!-- Информация об игре -->
  <div class="game-info-container">
    <h2>Special Snake PvP</h2>
    <p>Мультиплеерная змейка 1 на 1 (600×600 поле). Стоимость: <strong>1 билет</strong>.</p>
  </div>

  <!-- Поиск соперника -->
  <div class="game-search-container" id="searchContainer">
    <p class="search-animation" id="searchStatus">Ищем соперника...</p>
  </div>

  <!-- Соперник найден -->
  <div class="game-search-container" id="opponentContainer" style="display:none;">
    <p>Соперник найден!</p>
    <div style="display: flex; gap: 20px; justify-content: center;">
      <div>
        <img id="opponentPhoto" src="" alt="Opponent" style="width:50px; height:50px; border-radius:50%;" />
        <p id="opponentName">@Opponent</p>
      </div>
    </div>
    <div>
      Начало через <span id="countdownValue">10</span>...
    </div>
  </div>

  <!-- Игровая зона -->
  <div class="game-area" id="gameArea">
    <div class="game-timer-bar">
      <div class="game-timer-fill" id="timerFill"></div>
    </div>
    <canvas id="snakeCanvas" width="600" height="600"></canvas>
    <div class="scores">
      <span id="playerScoreLabel">Вы: 0</span> | 
      <span id="opponentScoreLabel">Соперник: 0</span>
    </div>
  </div>

  <!-- Модалка: Недостаточно билетов -->
  <div class="modal-backdrop" id="noTicketsModal">
    <div class="modal">
      <h2>Недостаточно билетов</h2>
      <p>У вас не хватает билетов.</p>
      <button onclick="returnToMain()">Вернуться</button>
    </div>
  </div>

  <!-- Модалка окончания игры -->
  <div class="endgame-backdrop" id="endgameBackdrop">
    <div class="endgame-modal">
      <h2 id="endgameTitle">Результат</h2>
      <p id="endgameMessage"></p>
      <button class="close-modal" onclick="finishGame()">Продолжить</button>
    </div>
  </div>

<script>
/* ----------------------------------------------
   1. Firebase Initialization
---------------------------------------------- */
const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ----------------------------------------------
   2. Telegram Web App
---------------------------------------------- */
const tg = window.Telegram.WebApp;
tg.expand();

/* ----------------------------------------------
   3. Глобальные переменные
---------------------------------------------- */
let currentUser = null;
let userRef = null;
let localUserData = { photo:'', tickets:0, coins:0, points:0 };

let gameId = null;        
let isHost = false;       

let countdownInterval = null;
let gameTimerInterval = null;
let timeLeft = 60;
let gameStarted = false;
let playerScore = 0;
let opponentScore = 0;

// Количество клеток в одном ряду/столбце
const GRID_COUNT = 30;
const CANVAS_SIZE = 600; 
const TILE_SIZE = CANVAS_SIZE / GRID_COUNT;

// Змейка игрока (растёт при яблоке)
let snake = {
  x: 5,
  y: 5,
  direction: 'RIGHT',
  body: [
    {x:5, y:5},
    {x:4, y:5},
    {x:3, y:5},
  ],
  color: '#0f0'
};
// Змейка соперника
let snakeOpponent = {
  x: 10,
  y: 10,
  direction: 'LEFT',
  body: [
    {x:10,y:10},
    {x:11,y:10},
    {x:12,y:10},
  ],
  color: '#f00'
};
let apple = { x: 15, y: 15 };

// Скорость змейки ~10 кадров в секунду
const MOVE_INTERVAL = 100;
let lastMoveTime = 0; // используется в gameLoop
let gameLoopId = null;

/* ----------------------------------------------
   4. Получаем данные пользователя
---------------------------------------------- */
if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
  currentUser = tg.initDataUnsafe.user;
  document.getElementById('username').textContent = '@' + currentUser.username;
  if (currentUser.photo_url) {
    document.getElementById('userPhoto').src = currentUser.photo_url;
  }
  userRef = db.ref('users/' + currentUser.username);
  userRef.once('value', snapshot => {
    if (!snapshot.exists()) {
      userRef.set({
        photo: currentUser.photo_url || '',
        tickets: 0,
        coins: 0,
        points: 0
      });
    }
  });
  userRef.on('value', snapshot => {
    const data = snapshot.val() || {};
    localUserData = data;
    updateTopBar();
  });
}

/* ----------------------------------------------
   5. Обновление верхней панели
---------------------------------------------- */
function updateTopBar() {
  document.getElementById('ticketCount').textContent = localUserData.tickets || 0;
  document.getElementById('coinCount').textContent   = localUserData.coins || 0;
  document.getElementById('pointCount').textContent  = localUserData.points || 0;
}

/* ----------------------------------------------
   6. Запуск matchmaking
---------------------------------------------- */
window.onload = function() {
  findOpponentInQueue();
};

/* Меню дизайна */
function toggleDesignMenu() {
  const menu = document.getElementById('design-options');
  menu.style.display = (menu.style.display==='none'||menu.style.display==='') ? 'block':'none';
}
function changeDesign(theme) {
  document.getElementById('themeStylesheet').setAttribute('href', theme);
  toggleDesignMenu();
}

/* ----------------------------------------------
   7. Ищем соперника
---------------------------------------------- */
function findOpponentInQueue() {
  const queueRef = db.ref('matchmaking/waiting');
  queueRef.once('value', snap => {
    const waiting = snap.val();
    if (!waiting) {
      // Очередь пуста – становимся хостом
      isHost = true;
      gameId = generateGameId();
      queueRef.set({
        username: currentUser.username,
        photo: currentUser.photo_url || '',
        gameId: gameId
      });
      listenForJoin(); // ждём, пока гость подключится
    } else {
      // Есть уже хост
      isHost = false;
      gameId = waiting.gameId;
      // Удаляем очередь
      queueRef.set(null);

      // Проверим билеты
      if ((localUserData.tickets||0)<1) {
        document.getElementById('noTicketsModal').classList.add('active');
        return;
      }
      // Списываем билет
      localUserData.tickets -= 1;
      userRef.update({ tickets: localUserData.tickets });

      // Записываемся в games/{gameId}/player2
      db.ref(`games/${gameId}/player2`).set({
        username: currentUser.username,
        photo: currentUser.photo_url || ''
      });

      // Соперник (хост) уже оплатил, считаем соперника найденным
      showOpponentFound(waiting.username, waiting.photo);
    }
  });
}

function generateGameId() {
  return 'game_'+Math.random().toString(36).substr(2,9);
}

/* ----------------------------------------------
   8. Хост ждёт guest
---------------------------------------------- */
function listenForJoin() {
  const gameRef = db.ref(`games/${gameId}/player2`);
  gameRef.on('value', snap=>{
    const val = snap.val();
    if(val) {
      // Пришёл гость
      if((localUserData.tickets||0)<1) {
        document.getElementById('noTicketsModal').classList.add('active');
        return;
      }
      localUserData.tickets -= 1;
      userRef.update({ tickets: localUserData.tickets });

      showOpponentFound(val.username, val.photo||'');
    }
  });
}

/* ----------------------------------------------
   9. "Соперник найден" -> 10 секунд отсчёт
---------------------------------------------- */
function showOpponentFound(opName, opPhoto) {
  document.getElementById('searchContainer').style.display='none';
  document.getElementById('opponentContainer').style.display='block';
  document.getElementById('opponentName').textContent = '@'+opName;
  document.getElementById('opponentPhoto').src = opPhoto || 'https://img.icons8.com/ios-filled/50/00FF00/user.png';

  let count=10;
  document.getElementById('countdownValue').textContent=count;
  countdownInterval=setInterval(()=>{
    count--;
    document.getElementById('countdownValue').textContent=count;
    if(count<=0) {
      clearInterval(countdownInterval);
      startGame();
    }
  },1000);
}

/* ----------------------------------------------
   10. Запуск игры
---------------------------------------------- */
function startGame() {
  document.getElementById('opponentContainer').style.display='none';
  document.getElementById('gameArea').style.display='block';

  // Запишем начальные данные в БД (хост отвечает за яблоко, snake и т.д.)
  if(isHost) {
    db.ref(`games/${gameId}/apple`).set({ x: apple.x, y: apple.y });
    db.ref(`games/${gameId}/player1State`).set( packSnakeData(snake) );
  } else {
    db.ref(`games/${gameId}/player2State`).set( packSnakeData(snake) );
  }

  timeLeft=60;
  updateTimerBar();
  gameTimerInterval=setInterval(()=>{
    timeLeft--;
    updateTimerBar();
    if(timeLeft<=0) {
      clearInterval(gameTimerInterval);
      endGame();
    }
  },1000);

  subscribeOpponentState();
  subscribeApple();

  document.addEventListener('keydown', handleKeyDown);
  setupTouchControls();

  gameStarted=true;
  lastMoveTime=Date.now();
  gameLoopId = setInterval(gameLoop, 16); // ~60 FPS отрисовка
}

/* ----------------------------------------------
   11. Игровой цикл (но движение - каждые 100ms)
---------------------------------------------- */
function gameLoop() {
  if(!gameStarted) return;

  const now = Date.now();
  if(now - lastMoveTime >= MOVE_INTERVAL) {
    updateSnake(snake);
    checkApple(snake,true);
    // Запишем состояние
    const path = isHost ? 'player1State':'player2State';
    db.ref(`games/${gameId}/${path}`).set( packSnakeData(snake) );
    lastMoveTime=now;
  }
  drawScene();
}

/* ----------------------------------------------
   12. Классическая логика Snake:
       - Сдвиг головы
       - Если не съели яблоко -> pop() хвоста
       - Если съели -> не pop()
---------------------------------------------- */
function updateSnake(snk) {
  let head = { x: snk.body[0].x, y: snk.body[0].y };

  // Новые координаты головы
  if(snk.direction==='LEFT')  head.x--;
  else if(snk.direction==='RIGHT') head.x++;
  else if(snk.direction==='UP') head.y--;
  else if(snk.direction==='DOWN') head.y++;

  // Обёртка
  if(head.x<0) head.x=GRID_COUNT-1;
  if(head.x>=GRID_COUNT) head.x=0;
  if(head.y<0) head.y=GRID_COUNT-1;
  if(head.y>=GRID_COUNT) head.y=0;

  snk.body.unshift(head);
  // Временно не pop() — сделаем в checkApple, если не было яблока
}

/* ----------------------------------------------
   13. Проверка яблока
---------------------------------------------- */
function checkApple(snk, isPlayer) {
  let head = snk.body[0];
  if(head.x===apple.x && head.y===apple.y) {
    // Съели яблоко
    if(isHost) {
      // Хост генерирует новое яблоко
      apple.x = Math.floor(Math.random()*GRID_COUNT);
      apple.y = Math.floor(Math.random()*GRID_COUNT);
      db.ref(`games/${gameId}/apple`).set({ x: apple.x, y: apple.y });
    }
    if(isPlayer) {
      playerScore++;
      document.getElementById('playerScoreLabel').textContent='Вы: '+playerScore;
    } else {
      opponentScore++;
      document.getElementById('opponentScoreLabel').textContent='Соперник: '+opponentScore;
    }
    // Не удаляем хвост -> змейка увеличивается
  } else {
    // Не съели -> убираем хвост
    snk.body.pop();
  }
}

/* ----------------------------------------------
   14. Отрисовка всего
---------------------------------------------- */
function drawScene() {
  const canvas = document.getElementById('snakeCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // Яблоко
  ctx.fillStyle='#ff0';
  ctx.fillRect(apple.x*TILE_SIZE, apple.y*TILE_SIZE, TILE_SIZE, TILE_SIZE);

  // Змейка игрока
  drawSnake(ctx, snake, 'You');
  // Змейка соперника
  drawSnake(ctx, snakeOpponent, opponentData.username||'Opp');
}

function drawSnake(ctx, snk, label) {
  ctx.fillStyle=snk.color;
  snk.body.forEach((part,i)=>{
    ctx.fillRect(part.x*TILE_SIZE, part.y*TILE_SIZE, TILE_SIZE, TILE_SIZE);
  });
  // Имя над головой
  ctx.fillStyle='#fff';
  ctx.font='8px "Press Start 2P"';
  ctx.fillText(label, snk.body[0].x*TILE_SIZE, snk.body[0].y*TILE_SIZE-2);
}

/* ----------------------------------------------
   15. Подготовка данных змейки (для записи в БД)
---------------------------------------------- */
function packSnakeData(snk) {
  return {
    x: snk.body[0].x,
    y: snk.body[0].y,
    direction: snk.direction,
    body: snk.body
  };
}
function unpackSnakeData(snk, data) {
  snk.x=data.x; snk.y=data.y;
  snk.direction=data.direction;
  snk.body=data.body||[];
}

/* ----------------------------------------------
   16. Подписка на состояние соперника
---------------------------------------------- */
function subscribeOpponentState() {
  const oppPath = isHost ? 'player2State':'player1State';
  const infoPath= isHost ? 'player2':'player1';
  // Подписываемся на изменения тела соперника
  db.ref(`games/${gameId}/${oppPath}`).on('value',snap=>{
    if(snap.val()) {
      unpackSnakeData(snakeOpponent,snap.val());
    }
  });
  // Считываем инфо о сопернике (username,photo)
  const infoRef = db.ref(`games/${gameId}/${infoPath}`);
  infoRef.once('value', snap=>{
    if(snap.val()) {
      opponentData.username = snap.val().username||'Opp';
      opponentData.photo = snap.val().photo||'';
    }
  });
}

/* ----------------------------------------------
   17. Подписка на яблоко (только хост двигает)
---------------------------------------------- */
function subscribeApple() {
  db.ref(`games/${gameId}/apple`).on('value', snap=>{
    const val = snap.val();
    if(val) {
      apple.x=val.x; apple.y=val.y;
    }
  });
}

/* ----------------------------------------------
   18. Управление клавишами
---------------------------------------------- */
function handleKeyDown(e) {
  if(e.key==='ArrowLeft' && snake.direction!=='RIGHT') snake.direction='LEFT';
  else if(e.key==='ArrowRight'&& snake.direction!=='LEFT') snake.direction='RIGHT';
  else if(e.key==='ArrowUp'   && snake.direction!=='DOWN') snake.direction='UP';
  else if(e.key==='ArrowDown' && snake.direction!=='UP')   snake.direction='DOWN';
}

/* ----------------------------------------------
   19. Управление свайпами
---------------------------------------------- */
function setupTouchControls() {
  let touchStartX=0, touchStartY=0;
  document.addEventListener('touchstart',(e)=>{
    touchStartX=e.touches[0].clientX;
    touchStartY=e.touches[0].clientY;
  },false);
  document.addEventListener('touchmove',(e)=>{
    e.preventDefault();
  }, { passive:false });
  document.addEventListener('touchend',(e)=>{
    let diffX=e.changedTouches[0].clientX - touchStartX;
    let diffY=e.changedTouches[0].clientY - touchStartY;
    if(Math.abs(diffX)>Math.abs(diffY)) {
      if(diffX>0 && snake.direction!=='LEFT') snake.direction='RIGHT';
      else if(diffX<0 && snake.direction!=='RIGHT') snake.direction='LEFT';
    } else {
      if(diffY>0 && snake.direction!=='UP') snake.direction='DOWN';
      else if(diffY<0 && snake.direction!=='DOWN') snake.direction='UP';
    }
  },false);
}

/* ----------------------------------------------
   20. Обновление полосы таймера
---------------------------------------------- */
function updateTimerBar() {
  const percent=(timeLeft/60)*100;
  document.getElementById('timerFill').style.width=percent+'%';
}

/* ----------------------------------------------
   21. Завершение игры
---------------------------------------------- */
function endGame() {
  gameStarted=false;
  if(gameLoopId) clearInterval(gameLoopId);

  const resultText = (playerScore>opponentScore)
    ? 'Вы победили!'
    : (playerScore===opponentScore?'Ничья!':'Вы проиграли...');
  document.getElementById('endgameTitle').textContent='Игра завершена!';
  document.getElementById('endgameMessage').textContent=
   `Ваш счёт: ${playerScore}, счёт соперника: ${opponentScore}. ${resultText}`;
  document.getElementById('endgameBackdrop').classList.add('active');

  let pointsEarned=(playerScore>opponentScore)?10:(playerScore===opponentScore?5:2);
  localUserData.points=(localUserData.points||0)+pointsEarned;
  if(userRef) userRef.update({ points: localUserData.points });

  // (Опционально) Удалим игру из БД, чтобы не копить мусор
  // db.ref(`games/${gameId}`).remove();
  // Или оставим для отладки
}

/* ----------------------------------------------
   22. Кнопка "Продолжить" => на главную
---------------------------------------------- */
function finishGame() {
  document.getElementById('endgameBackdrop').classList.remove('active');
  window.location.href='index.html';
}

/* ----------------------------------------------
   23. Модалка "Недостаточно билетов"
---------------------------------------------- */
function returnToMain() {
  document.getElementById('noTicketsModal').classList.remove('active');
  window.location.href='index.html';
}
</script>
</body>
</html>
