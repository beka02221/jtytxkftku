<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Special Snake PvP</title>

  <!-- Шрифт (Press Start 2P) -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <!-- Основной стиль – можно вынести в отдельный файл -->
  <link id="themeStylesheet" rel="stylesheet" href="st1.css">

  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    /* Общий стиль */
    body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #0f0;
      font-family: 'Press Start 2P', sans-serif;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: #111;
      border-bottom: 2px solid #0f0;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .balances span {
      margin-right: 10px;
    }
    main {
      position: relative;
      width: 100vw;
      height: calc(100vh - 58px); /* Высота экрана минус шапка */
      overflow: hidden;
    }
    /* Экран поиска соперника */
    .search-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    @keyframes searching {
      0%   { opacity: 0.2; }
      50%  { opacity: 1; }
      100% { opacity: 0.2; }
    }
    .search-animation {
      animation: searching 1.2s infinite;
      font-size: 16px;
      margin-top: 10px;
    }
    .opponent-found {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .opponent-found img {
      border-radius: 50%;
      width: 60px;
      height: 60px;
    }
    /* Игровая зона – Canvas занимает всё оставшееся пространство */
    .game-container {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .timer-bar {
      margin: 5px 0;
      width: 80%;
      height: 12px;
      background: #555;
      border: 1px solid #0f0;
      position: relative;
    }
    .timer-fill {
      background: #0f0;
      width: 100%;
      height: 100%;
      transition: width 1s linear;
    }
    .scores {
      margin: 5px 0;
    }
    #snakeCanvas {
      flex: 1;
      width: 100%;
      height: 100%;
      background: #333;
      border-top: 2px solid #0f0;
      border-bottom: 2px solid #0f0;
      image-rendering: pixelated;
      position: relative;
    }
    /* Отрисовка сетки – тонкие зеленые линии */
    canvas.grid-overlay {
      position: absolute;
      top: 0;
      left: 0;
      pointer-events: none;
    }
    /* Модальные окна */
    .modal-backdrop, .endgame-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-backdrop.active, .endgame-backdrop.active {
      display: flex;
    }
    .modal, .endgame-modal {
      background: #222;
      border: 2px solid #0f0;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Шапка (информация о пользователе) -->
  <header>
    <div class="user-info">
      <img id="userPhoto" src="" alt="Avatar" />
      <span id="username">@User</span>
    </div>
    <div class="balances">
      <span>
        <img src="https://img.icons8.com/external-kmg-design-glyph-kmg-design/64/00FF00/external-ticket-cinema-kmg-design-glyph-kmg-design.png" alt="Tickets" width="20" />
        <span id="ticketCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/coins.png" alt="Coins" width="20" />
        <span id="coinCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/rating.png" alt="Points" width="20" />
        <span id="pointCount">0</span>
      </span>
    </div>
  </header>

  <!-- Основная область -->
  <main>
    <!-- Экран поиска соперника -->
    <div id="searchView" class="search-container">
      <div id="searchBlock">
        <h2>Мультиплеерная Змейка (2 минуты)</h2>
        <p>Стоимость: 1 билет</p>
        <div class="search-animation">Ищем соперника...</div>
      </div>
      <div id="foundBlock" style="display: none;" class="opponent-found">
        <h2>Соперник найден!</h2>
        <img id="opponentPhoto" src="" alt="Opponent" />
        <p id="opponentName">@Opponent</p>
        <p>Начало через <span id="countdownValue">5</span>...</p>
      </div>
    </div>

    <!-- Игровая зона -->
    <div id="gameArea" class="game-container">
      <div class="timer-bar">
        <div class="timer-fill" id="timerFill"></div>
      </div>
      <div class="scores">
        <span id="playerScoreLabel">Вы: 0</span> |
        <span id="opponentScoreLabel">Соперник: 0</span>
      </div>
      <canvas id="snakeCanvas"></canvas>
    </div>
  </main>

  <!-- Модалка "Нет билетов" -->
  <div class="modal-backdrop" id="noTicketsModal">
    <div class="modal">
      <h2>Недостаточно билетов</h2>
      <p>У вас нет билетов для участия в игре.</p>
      <button onclick="returnToMain()">Вернуться</button>
    </div>
  </div>

  <!-- Модалка окончания игры -->
  <div class="endgame-backdrop" id="endgameBackdrop">
    <div class="endgame-modal">
      <h2 id="endgameTitle">Игра завершена!</h2>
      <p id="endgameMessage"></p>
      <button onclick="finishGame()">Продолжить</button>
    </div>
  </div>

  <script>
    /********** 1. Firebase Initialization **********/
  const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /********** 2. Telegram Web App **********/
    const tg = window.Telegram.WebApp;
    tg.expand();

    /********** 3. Global Variables **********/
    let currentUser = null;
    let userRef = null;
    let localUserData = { tickets: 0, coins: 0, points: 0 };

    // Opponent data and game info
    let opponentData = { username: '', photo: '' };
    let gameId = null;
    let isHost = false;

    let gameStarted = false;
    let countdownInterval = null;
    let timeLeft = 120; // 2 минуты
    let gameTimer = null;

    let playerScore = 0;
    let opponentScore = 0;

    // Змейки – изначально длина 3 клетки
    let snake = {
      x: 5, y: 5,
      direction: 'RIGHT',
      body: [
        { x: 3, y: 5 },
        { x: 4, y: 5 },
        { x: 5, y: 5 }
      ],
      color: '#0f0'
    };
    let snakeOpponent = {
      x: 15, y: 15,
      direction: 'LEFT',
      body: [
        { x: 17, y: 15 },
        { x: 16, y: 15 },
        { x: 15, y: 15 }
      ],
      color: '#f00'
    };

    // Параметры поля
    let gridCols = 20;
    let gridRows = 30;
    let tileSizeX = 0;
    let tileSizeY = 0;
    let apple = { x: 10, y: 10 };

    // Скорость – 200 мс на шаг для быстрой игры
    let snakeSpeed = 200;
    let lastMoveTime = 0;

    /********** 4. User Initialization **********/
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
      document.getElementById('username').textContent = '@' + currentUser.username;
      if (currentUser.photo_url) {
        document.getElementById('userPhoto').src = currentUser.photo_url;
      }
      // Используем username как ключ (если нужно – примените toLowerCase())
      const safeName = currentUser.username;
      userRef = db.ref('users/' + safeName);
      userRef.once('value').then((snapshot) => {
        if (!snapshot.exists()) {
          // Инициализируем, например, 10 билетами
          userRef.set({
            photo: currentUser.photo_url || '',
            tickets: 10,
            coins: 0,
            points: 0
          });
          localUserData = { photo: currentUser.photo_url || '', tickets: 10, coins: 0, points: 0 };
        } else {
          localUserData = snapshot.val();
        }
        updateTopBar();
        // Подписываемся на изменения
        userRef.on('value', (snap2) => {
          localUserData = snap2.val() || {};
          updateTopBar();
        });
        startMatchmaking();
      });
    }

    /********** 5. Update Top Bar **********/
    function updateTopBar() {
      document.getElementById('ticketCount').textContent = localUserData.tickets || 0;
      document.getElementById('coinCount').textContent = localUserData.coins || 0;
      document.getElementById('pointCount').textContent = localUserData.points || 0;
    }

    /********** 6. Matchmaking **********/
    function startMatchmaking() {
      if ((localUserData.tickets || 0) < 1) {
        document.getElementById('noTicketsModal').classList.add('active');
        return;
      }
      const mmRef = db.ref('matchmaking');
      mmRef.once('value').then(snap => {
        const data = snap.val() || {};
        const other = Object.keys(data).find(u => u !== currentUser.username);
        if (other) {
          gameId = currentUser.username + '_vs_' + other;
          isHost = false;
          db.ref('matchmaking/' + other).remove();
          db.ref('matchmaking/' + currentUser.username).remove();
          createGameNode(other);
        } else {
          isHost = true;
          mmRef.child(currentUser.username).set({ time: Date.now() });
          mmRef.on('child_added', (childSnap) => {
            if (childSnap.key !== currentUser.username) {
              gameId = currentUser.username + '_vs_' + childSnap.key;
              db.ref('matchmaking/' + childSnap.key).remove();
              db.ref('matchmaking/' + currentUser.username).remove();
              createGameNode(childSnap.key);
            }
          });
        }
      });
    }

    function createGameNode(opponentName) {
      const gRef = db.ref('games/' + gameId);
      // Если мы host – player1 = currentUser, player2 = opponent; иначе наоборот.
      gRef.set({
        player1: {
          username: isHost ? currentUser.username : opponentName,
          photo: isHost ? currentUser.photo_url || '' : '',
          snake: isHost ? snake : snakeOpponent
        },
        player2: {
          username: isHost ? opponentName : currentUser.username,
          photo: isHost ? '' : currentUser.photo_url || '',
          snake: isHost ? snakeOpponent : snake
        },
        apple: apple,
        timeLeft: 120
      }).then(() => {
        initGameSubscriptions();
      });
    }

    /********** 7. Game Subscriptions **********/
    function initGameSubscriptions() {
      const gRef = db.ref('games/' + gameId);
      // Подписываемся на изменения в обоих игроках
      gRef.child('player1').on('value', (snap) => {
        const val = snap.val() || {};
        if (val.username !== currentUser.username) {
          opponentData.username = val.username || '';
          opponentData.photo = val.photo || '';
          if (val.snake) snakeOpponent = val.snake;
        }
      });
      gRef.child('player2').on('value', (snap) => {
        const val = snap.val() || {};
        if (val.username !== currentUser.username) {
          opponentData.username = val.username || '';
          opponentData.photo = val.photo || '';
          if (val.snake) snakeOpponent = val.snake;
        }
      });
      gRef.child('apple').on('value', (snap) => {
        apple = snap.val() || apple;
      });
      // После небольшой задержки показываем "Соперник найден"
      setTimeout(() => {
        showOpponentFound();
      }, 1000);
    }

    /********** 8. Show Opponent Found **********/
    function showOpponentFound() {
      document.getElementById('searchBlock').style.display = 'none';
      document.getElementById('foundBlock').style.display = 'block';
      document.getElementById('opponentPhoto').src =
        opponentData.photo || 'https://img.icons8.com/ios-filled/50/00FF00/user.png';
      document.getElementById('opponentName').textContent = '@' + (opponentData.username || 'Opp');
      let c = 5;
      document.getElementById('countdownValue').textContent = c;
      countdownInterval = setInterval(() => {
        c--;
        document.getElementById('countdownValue').textContent = c;
        if (c <= 0) {
          clearInterval(countdownInterval);
          startGame();
        }
      }, 1000);
    }

    /********** 9. Start Game **********/
    function startGame() {
      if ((localUserData.tickets || 0) < 1) {
        document.getElementById('noTicketsModal').classList.add('active');
        return;
      }
      // Списываем билет только сейчас – когда матч реально начинается
      localUserData.tickets -= 1;
      userRef.update({ tickets: localUserData.tickets });
      updateTopBar();

      document.getElementById('searchView').style.display = 'none';
      const gameArea = document.getElementById('gameArea');
      gameArea.style.display = 'flex';

      const canvas = document.getElementById('snakeCanvas');
      canvas.width = canvas.clientWidth;
      canvas.height = canvas.clientHeight;
      tileSizeX = canvas.width / gridCols;
      tileSizeY = canvas.height / gridRows;

      gameStarted = true;
      timeLeft = 120;
      updateTimerBar();

      gameTimer = setInterval(() => {
        timeLeft--;
        db.ref('games/' + gameId + '/timeLeft').set(timeLeft);
        updateTimerBar();
        if (timeLeft <= 0) {
          clearInterval(gameTimer);
          endGame();
        }
      }, 1000);

      document.addEventListener('keydown', handleKeyDown);
      setupTouchControls();
      requestAnimationFrame(gameLoop);
    }

    /********** 10. Game Loop **********/
    function gameLoop(timestamp) {
      if (!gameStarted) return;
      if (timestamp - lastMoveTime > snakeSpeed) {
        lastMoveTime = timestamp;
        // Обновляем состояние своей змейки
        updateSnake(snake, true);
        // Отправляем состояние в Firebase
        const me = isHost ? 'player1' : 'player2';
        db.ref('games/' + gameId + '/' + me + '/snake').set(snake);
      }
      drawScene();
      requestAnimationFrame(gameLoop);
    }

    /********** 11. Update Snake **********/
    function updateSnake(snk, isPlayer) {
      let newX = snk.x, newY = snk.y;
      if (snk.direction === 'LEFT') newX--;
      else if (snk.direction === 'RIGHT') newX++;
      else if (snk.direction === 'UP') newY--;
      else if (snk.direction === 'DOWN') newY++;
      if (newX < 0) newX = gridCols - 1;
      if (newX >= gridCols) newX = 0;
      if (newY < 0) newY = gridRows - 1;
      if (newY >= gridRows) newY = 0;
      snk.x = newX;
      snk.y = newY;
      let ateApple = (newX === apple.x && newY === apple.y);
      snk.body.unshift({ x: newX, y: newY });
      if (!ateApple) {
        snk.body.pop();
      } else {
        // Если съели яблоко – увеличиваем счет и не удаляем хвост (змейка вырастает)
        if (isPlayer) {
          playerScore++;
          document.getElementById('playerScoreLabel').textContent = `Вы: ${playerScore}`;
        } else {
          opponentScore++;
          document.getElementById('opponentScoreLabel').textContent = `Соперник: ${opponentScore}`;
        }
        apple.x = Math.floor(Math.random() * gridCols);
        apple.y = Math.floor(Math.random() * gridRows);
        db.ref('games/' + gameId + '/apple').set(apple);
      }
    }

    /********** 12. Draw Scene **********/
    function drawScene() {
      const canvas = document.getElementById('snakeCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      // Рисуем сетку
      drawGrid(ctx, canvas.width, canvas.height);
      // Рисуем змейки
      drawSnake(ctx, snake, 'You');
      drawSnake(ctx, snakeOpponent, opponentData.username || 'Opp');
      // Рисуем яблоко
      ctx.fillStyle = '#ff0';
      ctx.fillRect(apple.x * tileSizeX, apple.y * tileSizeY, tileSizeX, tileSizeY);
    }
    function drawGrid(ctx, width, height) {
      ctx.strokeStyle = "rgba(0,255,0,0.3)";
      ctx.lineWidth = 1;
      for (let i = 0; i <= gridCols; i++) {
         let x = i * tileSizeX;
         ctx.beginPath();
         ctx.moveTo(x, 0);
         ctx.lineTo(x, height);
         ctx.stroke();
      }
      for (let j = 0; j <= gridRows; j++) {
         let y = j * tileSizeY;
         ctx.beginPath();
         ctx.moveTo(0, y);
         ctx.lineTo(width, y);
         ctx.stroke();
      }
    }
    function drawSnake(ctx, snk, label) {
      ctx.fillStyle = snk.color;
      snk.body.forEach(part => {
         ctx.fillRect(part.x * tileSizeX, part.y * tileSizeY, tileSizeX, tileSizeY);
      });
      ctx.fillStyle = '#fff';
      ctx.font = '10px "Press Start 2P"';
      ctx.fillText(label, snk.body[0].x * tileSizeX, snk.body[0].y * tileSizeY - 2);
    }

    /********** 13. Controls **********/
    function handleKeyDown(e) {
      if (e.key === 'ArrowLeft' && snake.direction !== 'RIGHT') snake.direction = 'LEFT';
      else if (e.key === 'ArrowRight' && snake.direction !== 'LEFT') snake.direction = 'RIGHT';
      else if (e.key === 'ArrowUp' && snake.direction !== 'DOWN') snake.direction = 'UP';
      else if (e.key === 'ArrowDown' && snake.direction !== 'UP') snake.direction = 'DOWN';
    }
    function setupTouchControls() {
      let startX = 0, startY = 0;
      document.addEventListener('touchstart', e => {
         startX = e.touches[0].clientX;
         startY = e.touches[0].clientY;
      }, false);
      document.addEventListener('touchmove', e => {
         e.preventDefault();
      }, { passive: false });
      document.addEventListener('touchend', e => {
         let endX = e.changedTouches[0].clientX;
         let endY = e.changedTouches[0].clientY;
         let diffX = endX - startX;
         let diffY = endY - startY;
         if (Math.abs(diffX) > Math.abs(diffY)) {
           if (diffX > 0 && snake.direction !== 'LEFT') snake.direction = 'RIGHT';
           else if (diffX < 0 && snake.direction !== 'RIGHT') snake.direction = 'LEFT';
         } else {
           if (diffY > 0 && snake.direction !== 'UP') snake.direction = 'DOWN';
           else if (diffY < 0 && snake.direction !== 'DOWN') snake.direction = 'UP';
         }
      }, false);
    }

    /********** 14. Timer Bar **********/
    function updateTimerBar() {
      const p = (timeLeft / 120) * 100;
      document.getElementById('timerFill').style.width = p + '%';
    }

    /********** 15. End Game **********/
    function endGame() {
      gameStarted = false;
      document.getElementById('gameArea').style.display = 'none';
      let res = '';
      if (playerScore > opponentScore) res = 'Вы победили!';
      else if (playerScore < opponentScore) res = 'Вы проиграли...';
      else res = 'Ничья!';
      document.getElementById('endgameMessage').textContent =
         `Ваш счёт: ${playerScore}, Соперник: ${opponentScore}. ${res}`;
      document.getElementById('endgameBackdrop').classList.add('active');
      let pointsAdd = (playerScore > opponentScore) ? 10 : (playerScore === opponentScore ? 5 : 2);
      localUserData.points = (localUserData.points || 0) + pointsAdd;
      userRef.update({ points: localUserData.points });
      db.ref('games/' + gameId).remove();
      db.ref('matchmaking/' + currentUser.username).remove();
    }

    /********** 16. Finish Game **********/
    function finishGame() {
      document.getElementById('endgameBackdrop').classList.remove('active');
      window.location.href = 'index.html';
    }

    /********** 17. Return to Main **********/
    function returnToMain() {
      document.getElementById('noTicketsModal').classList.remove('active');
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>

