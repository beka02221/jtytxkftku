<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Special Snake PvP</title>

  <!-- Шрифт (как на главной) -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <!-- Стили (можете вынести в отдельный файл) -->
  <link id="themeStylesheet" rel="stylesheet" href="st1.css">

  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #0f0;
      font-family: 'Press Start 2P', sans-serif;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      background: #111;
      border-bottom: 2px solid #0f0;
      z-index: 10;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
    }
    .balances span {
      margin-right: 10px;
    }

    /* Меню дизайна (гамбургер) */
    .hamburger-line {
      display: block;
      width: 20px;
      height: 2px;
      background-color: #0f0;
      margin: 4px 0;
    }
    #design-options {
      display: none;
      position: absolute;
      background: #222;
      border: 1px solid #0f0;
      padding: 10px;
      z-index: 99;
    }

    /* Основной блок под шапкой */
    main {
      position: relative;
      width: 100vw;
      height: calc(100vh - 58px); /* Высота экрана минус высота шапки */
      overflow: hidden;
    }

    /* Контейнер поиска соперника */
    .search-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    @keyframes searching {
      0%   { opacity: 0.2; }
      50%  { opacity: 1;   }
      100% { opacity: 0.2; }
    }
    .search-animation {
      animation: searching 1.2s infinite;
      font-size: 16px;
      margin-top: 10px;
    }

    /* Контейнер соперника */
    .opponent-found {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .opponent-found img {
      border-radius: 50%;
      width: 60px;
      height: 60px;
    }

    /* Игровая зона */
    .game-container {
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      display: none; /* Появится когда начнётся игра */
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .timer-bar {
      margin: 5px 0;
      width: 80%;
      height: 12px;
      background: #555;
      border: 1px solid #0f0;
      position: relative;
    }
    .timer-fill {
      background: #0f0;
      width: 100%;
      height: 100%;
      transition: width 1s linear;
    }
    .scores {
      margin: 5px 0;
    }

    /* Canvas на весь остаток экрана */
    #snakeCanvas {
      flex: 1;
      width: 100%;
      height: 100%;
      background: #333;
      border-top: 2px solid #0f0;
      border-bottom: 2px solid #0f0;
      image-rendering: pixelated;
    }

    /* Модалки */
    .modal-backdrop, .endgame-backdrop {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 999;
    }
    .modal-backdrop.active, .endgame-backdrop.active {
      display: flex;
    }
    .modal, .endgame-modal {
      background: #222;
      border: 2px solid #0f0;
      padding: 20px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Шапка (аватар, балансы) -->
  <header>
    <div class="user-info">
      <img id="userPhoto" src="" alt="Avatar"/>
      <span id="username">@User</span>
    </div>
    <div class="balances">
      <span>
        <img src="https://img.icons8.com/external-kmg-design-glyph-kmg-design/64/00FF00/external-ticket-cinema-kmg-design-glyph-kmg-design.png"
             alt="Tickets" width="20"/>
        <span id="ticketCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/coins.png"
             alt="Coins" width="20"/>
        <span id="coinCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/rating.png"
             alt="Points" width="20"/>
        <span id="pointCount">0</span>
      </span>
    </div>
    <div class="header-left" id="design-settings" style="position:relative;">
      <button onclick="toggleDesignMenu()">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>
      <div id="design-options">
        <p onclick="changeDesign('st1.css')">Дизайн (применён)</p>
        <p onclick="changeDesign('st2.css')">Ретро дизайн</p>
        <p onclick="changeDesign('st3.css')">Киберпанк дизайн</p>
      </div>
    </div>
  </header>

  <!-- Основная область -->
  <main>
    <!-- Поиск соперника / соперник найден -->
    <div id="searchView" class="search-container">
      <div id="searchBlock">
        <h2>Мультиплеерная Змейка (2 минуты)</h2>
        <p>Стоимость: 1 билет</p>
        <div class="search-animation">Ищем соперника...</div>
      </div>
      <div id="foundBlock" style="display:none;" class="opponent-found">
        <h2>Соперник найден!</h2>
        <img id="opponentPhoto" src="" alt="Opponent" />
        <p id="opponentName">@Opponent</p>
        <p>Начало через <span id="countdownValue">5</span>...</p>
      </div>
    </div>

    <!-- Основная игра (Canvas + таймер + счёт) -->
    <div id="gameArea" class="game-container">
      <div class="timer-bar">
        <div class="timer-fill" id="timerFill"></div>
      </div>
      <div class="scores">
        <span id="playerScoreLabel">Вы: 0</span> | 
        <span id="opponentScoreLabel">Соперник: 0</span>
      </div>
      <canvas id="snakeCanvas"></canvas>
    </div>
  </main>

  <!-- Модалка "Нет билетов" -->
  <div class="modal-backdrop" id="noTicketsModal">
    <div class="modal">
      <h2>Недостаточно билетов</h2>
      <p>У вас нет билетов для участия в игре.</p>
      <button onclick="returnToMain()">Вернуться</button>
    </div>
  </div>

  <!-- Модалка окончания игры -->
  <div class="endgame-backdrop" id="endgameBackdrop">
    <div class="endgame-modal">
      <h2 id="endgameTitle">Игра завершена!</h2>
      <p id="endgameMessage"></p>
      <button onclick="finishGame()">Продолжить</button>
    </div>
  </div>

  <script>
    /* ----------------------------------------------
       1. Firebase Initialization
         (Замените поля на реальные)
    ---------------------------------------------- */
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DB_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASUREMENT_ID"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ----------------------------------------------
       2. Telegram Web App
    ---------------------------------------------- */
    const tg = window.Telegram.WebApp;
    tg.expand();

    /* ----------------------------------------------
       3. Глобальные переменные
    ---------------------------------------------- */
    let currentUser = null;
    let userRef = null;
    let localUserData = { photo: '', tickets: 0, coins: 0, points: 0 };

    // Данные соперника
    let opponentData = { username: '', photo: '' };
    
    // Game ID (создадим/найдём по matchmaking)
    let gameId = null;
    let isHost = false; // флаг, кто создал игру

    // Логика игры
    let gameStarted = false;
    let countdownInterval = null;
    let timeLeft = 120; // 2 минуты = 120 сек
    let gameTimer = null;

    let playerScore = 0;
    let opponentScore = 0;

    // Змейка игрока
    let snake = {
      x: 5, y: 5,
      direction: 'RIGHT',
      body: [{x:5,y:5}],
      color: '#0f0'
    };
    // Змейка соперника
    let snakeOpponent = {
      x: 15, y: 15,
      direction: 'LEFT',
      body: [{x:15,y:15}],
      color: '#f00'
    };

    // Параметры поля
    let gridCols = 20;   // кол-во ячеек по горизонтали
    let gridRows = 30;   // кол-во ячеек по вертикали
    let tileSizeX = 0;   // вычислим динамически (зависит от canvas)
    let tileSizeY = 0;   // то же для высоты
    let apple = { x: 10, y: 10 };

    // Частота шагов змейки (втрое медленнее: ~450 мс)
    let snakeSpeed = 450;
    let lastMoveTime = 0; // время последнего шага

    /* ----------------------------------------------
       4. Получаем данные пользователя
    ---------------------------------------------- */
    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
      document.getElementById('username').textContent = '@' + currentUser.username;
      if (currentUser.photo_url) {
        document.getElementById('userPhoto').src = currentUser.photo_url;
      }
      userRef = db.ref('users/' + currentUser.username);
      userRef.once('value', snapshot => {
        if (!snapshot.exists()) {
          userRef.set({
            photo: currentUser.photo_url || '',
            tickets: 0,
            coins: 0,
            points: 0
          });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData = data;
        updateTopBar();
      });
    }

    /* ----------------------------------------------
       5. При загрузке страницы – начинаем Matchmaking
    ---------------------------------------------- */
    window.addEventListener('load', () => {
      matchmaking();
    });

    /* ----------------------------------------------
       6. Обновление верхней панели
    ---------------------------------------------- */
    function updateTopBar() {
      document.getElementById('ticketCount').textContent = localUserData.tickets || 0;
      document.getElementById('coinCount').textContent   = localUserData.coins || 0;
      document.getElementById('pointCount').textContent  = localUserData.points || 0;
    }

    /* ----------------------------------------------
       7. Меню дизайна
    ---------------------------------------------- */
    function toggleDesignMenu() {
      const menu = document.getElementById('design-options');
      menu.style.display = (menu.style.display === 'none' || menu.style.display === '') ? 'block' : 'none';
    }
    function changeDesign(theme) {
      document.getElementById('themeStylesheet').setAttribute('href', theme);
      toggleDesignMenu();
    }

    /* ----------------------------------------------
       8. Matchmaking – поиск / создание комнаты
         УПРОЩЕННЫЙ ПРИМЕР:
         1) Если есть пользователь в /matchmaking, то связываемся с ним
         2) Иначе создаём запись в /matchmaking/username
    ---------------------------------------------- */
    function matchmaking() {
      if (!currentUser) return;

      // Если у игрока вообще нет билетов
      if ((localUserData.tickets || 0) < 1) {
        // Модалка "нет билетов"
        document.getElementById('noTicketsModal').classList.add('active');
        return;
      }

      // Смотрим, есть ли кто-то в matchmaking
      const mmRef = db.ref('matchmaking');
      mmRef.once('value', snap => {
        const data = snap.val() || {};
        const otherUser = Object.keys(data).find(u => u !== currentUser.username);
        if (otherUser) {
          // Нашли другого игрока – создаём gameId
          gameId = currentUser.username + '_vs_' + otherUser;
          isHost = false;
          // Удаляем запись другого игрока из matchmaking
          db.ref('matchmaking/' + otherUser).remove();
          // Удаляем свою запись (на всякий случай)
          db.ref('matchmaking/' + currentUser.username).remove();
          // Создаём игру
          createGameNode(otherUser);
        } else {
          // Никого нет – становимся в очередь
          isHost = true;
          db.ref('matchmaking/' + currentUser.username).set({
            time: Date.now()
          });
          // Ждём, когда к нам подключатся
          mmRef.on('value', (snap2) => {
            const d2 = snap2.val() || {};
            const partner = Object.keys(d2).find(u => u !== currentUser.username);
            if (partner) {
              gameId = currentUser.username + '_vs_' + partner;
              // Удаляем записи
              db.ref('matchmaking/' + partner).remove();
              db.ref('matchmaking/' + currentUser.username).remove();
              createGameNode(partner);
            }
          });
        }
      });
    }

    function createGameNode(opponentName) {
      // Пример: создаём /games/{gameId}
      const gRef = db.ref('games/' + gameId);
      gRef.set({
        player1: {
          username: currentUser.username,
          photo: currentUser.photo_url || '',
          snake: snake
        },
        player2: {
          username: opponentName,
          photo: '',  // Заполним при получении
          snake: snakeOpponent
        },
        apple: apple,
        timeLeft: 120
      }).then(() => {
        // Подписываемся на обновления
        initGameSubscriptions();
      });
    }

    /* ----------------------------------------------
       9. Подписки на узел игры – чтобы получать
         данные соперника, яблока, таймера и т.д.
    ---------------------------------------------- */
    function initGameSubscriptions() {
      const gRef = db.ref('games/' + gameId);

      // Подписка на player1 и player2
      gRef.child('player1').on('value', (snap) => {
        const val = snap.val() || {};
        if (val.username !== currentUser.username) {
          // Значит это соперник
          opponentData.username = val.username || '';
          opponentData.photo = val.photo || '';
          // Обновляем змейку оппонента
          if (val.snake) {
            snakeOpponent = val.snake;
          }
        }
      });
      gRef.child('player2').on('value', (snap) => {
        const val = snap.val() || {};
        if (val.username !== currentUser.username) {
          // Значит это соперник
          opponentData.username = val.username || '';
          opponentData.photo = val.photo || '';
          if (val.snake) {
            snakeOpponent = val.snake;
          }
        }
      });

      // Подписка на apple
      gRef.child('apple').on('value', (snap) => {
        const val = snap.val() || {};
        apple = val;
      });

      // Как только данные соперника появились, показываем Found
      db.ref('users/' + opponentData.username).once('value', snapshot => {
        const oppVal = snapshot.val() || {};
        if (oppVal.photo) {
          opponentData.photo = oppVal.photo;
        }
        // Соперник найден – UI
        showOpponentFound();
      });
    }

    /* ----------------------------------------------
       10. Показать блок "соперник найден",
           списать билет, старт обратного отсчёта
    ---------------------------------------------- */
    function showOpponentFound() {
      // Если у нас по-прежнему нет билетов – показываем модалку
      if ((localUserData.tickets || 0) < 1) {
        document.getElementById('noTicketsModal').classList.add('active');
        return;
      }

      // Списываем билет
      localUserData.tickets -= 1;
      updateTopBar();
      userRef.update({ tickets: localUserData.tickets });

      document.getElementById('searchBlock').style.display = 'none';
      document.getElementById('foundBlock').style.display = 'block';
      document.getElementById('opponentPhoto').src = opponentData.photo || 'https://img.icons8.com/ios-filled/50/00FF00/user.png';
      document.getElementById('opponentName').textContent = '@' + opponentData.username;

      let count = 5;
      document.getElementById('countdownValue').textContent = count;
      countdownInterval = setInterval(() => {
        count--;
        document.getElementById('countdownValue').textContent = count;
        if (count <= 0) {
          clearInterval(countdownInterval);
          // Начинаем игру
          startGame();
        }
      }, 1000);
    }

    /* ----------------------------------------------
       11. Начинаем игру
         - Показываем Canvas
         - 2 минуты (120 секунд)
         - requestAnimationFrame + задержка snakeSpeed
    ---------------------------------------------- */
    function startGame() {
      document.getElementById('searchView').style.display = 'none';
      const gameArea = document.getElementById('gameArea');
      gameArea.style.display = 'flex';

      // Размер Canvas = оставшееся пространство
      const canvas = document.getElementById('snakeCanvas');
      canvas.width = canvas.clientWidth;  // занимать всю ширину
      canvas.height = canvas.clientHeight; // занимать всю высоту

      // Высчитываем размер тайла
      tileSizeX = canvas.width / gridCols;
      tileSizeY = canvas.height / gridRows;

      gameStarted = true;
      timeLeft = 120;
      updateTimerBar();

      gameTimer = setInterval(() => {
        timeLeft--;
        db.ref('games/' + gameId + '/timeLeft').set(timeLeft); // синхронизируем
        updateTimerBar();
        if (timeLeft <= 0) {
          clearInterval(gameTimer);
          endGame();
        }
      }, 1000);

      // Управление
      document.addEventListener('keydown', handleKeyDown);
      setupTouchControls();

      // Игровой цикл
      requestAnimationFrame(gameLoop);
    }

    /* ----------------------------------------------
       12. Игровой цикл через requestAnimationFrame
         - Проверяем прошло ли snakeSpeed мс
         - Если да – двигаем змейки, обновляем Firebase
         - Рисуем всё
    ---------------------------------------------- */
    function gameLoop(timestamp) {
      if (!gameStarted) return;
      
      // Проверяем, прошло ли нужное время
      if (timestamp - lastMoveTime > snakeSpeed) {
        lastMoveTime = timestamp;
        // Двигаем змею игрока
        updateSnake(snake, true);

        // Проверяем сбор яблока
        checkApple(snake, true);
        checkApple(snakeOpponent, false);

        // Сохраняем своё состояние в Firebase
        const myRole = isHost ? 'player1' : 'player2';
        db.ref('games/' + gameId + '/' + myRole + '/snake').set(snake);
        db.ref('games/' + gameId + '/apple').set(apple);
      }
      // Рисуем
      drawScene();
      requestAnimationFrame(gameLoop);
    }

    /* ----------------------------------------------
       13. Логика движения змеи
         - Обёртка по краям
    ---------------------------------------------- */
    function updateSnake(snk, isPlayer) {
      if (snk.direction === 'LEFT')  snk.x--;
      else if (snk.direction === 'RIGHT') snk.x++;
      else if (snk.direction === 'UP')    snk.y--;
      else if (snk.direction === 'DOWN')  snk.y++;

      // Обёртка
      if (snk.x < 0) snk.x = gridCols - 1;
      if (snk.x >= gridCols) snk.x = 0;
      if (snk.y < 0) snk.y = gridRows - 1;
      if (snk.y >= gridRows) snk.y = 0;

      // Двигаем тело
      snk.body.unshift({x: snk.x, y: snk.y});
      // Змейка не растёт от яблок (по ТЗ) – убираем хвост
      snk.body.pop();
    }

    /* ----------------------------------------------
       14. Проверка яблока
    ---------------------------------------------- */
    function checkApple(snk, isPlayer) {
      if (snk.x === apple.x && snk.y === apple.y) {
        // Счёт
        if (isPlayer) {
          playerScore++;
          document.getElementById('playerScoreLabel').textContent = `Вы: ${playerScore}`;
        } else {
          opponentScore++;
          document.getElementById('opponentScoreLabel').textContent = `Соперник: ${opponentScore}`;
        }
        // Новое яблоко
        apple.x = Math.floor(Math.random() * gridCols);
        apple.y = Math.floor(Math.random() * gridRows);
      }
    }

    /* ----------------------------------------------
       15. Отрисовка поля
    ---------------------------------------------- */
    function drawScene() {
      const canvas = document.getElementById('snakeCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // Рисуем змею игрока
      drawSnake(ctx, snake, 'You');
      // Рисуем змею соперника
      drawSnake(ctx, snakeOpponent, opponentData.username || 'Opp');

      // Яблоко
      ctx.fillStyle = '#ff0';
      ctx.fillRect(apple.x * tileSizeX, apple.y * tileSizeY, tileSizeX, tileSizeY);
    }

    function drawSnake(ctx, snk, label) {
      ctx.fillStyle = snk.color;
      snk.body.forEach(part => {
        ctx.fillRect(part.x * tileSizeX, part.y * tileSizeY, tileSizeX, tileSizeY);
      });
      // Пишем имя над головой
      ctx.fillStyle = '#fff';
      ctx.font = '10px "Press Start 2P"';
      ctx.fillText(label, snk.body[0].x * tileSizeX, snk.body[0].y * tileSizeY - 2);
    }

    /* ----------------------------------------------
       16. Управление (клавиатура + свайпы)
    ---------------------------------------------- */
    function handleKeyDown(e) {
      if (e.key === 'ArrowLeft' && snake.direction !== 'RIGHT')  snake.direction = 'LEFT';
      else if (e.key === 'ArrowRight' && snake.direction !== 'LEFT')  snake.direction = 'RIGHT';
      else if (e.key === 'ArrowUp' && snake.direction !== 'DOWN')  snake.direction = 'UP';
      else if (e.key === 'ArrowDown' && snake.direction !== 'UP')  snake.direction = 'DOWN';
    }

    function setupTouchControls() {
      let startX = 0, startY = 0;
      document.addEventListener('touchstart', (e) => {
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
      }, false);
      document.addEventListener('touchmove', (e) => {
        e.preventDefault();
      }, { passive: false });
      document.addEventListener('touchend', (e) => {
        let endX = e.changedTouches[0].clientX;
        let endY = e.changedTouches[0].clientY;
        let diffX = endX - startX;
        let diffY = endY - startY;
        if (Math.abs(diffX) > Math.abs(diffY)) {
          if (diffX > 0 && snake.direction !== 'LEFT') snake.direction = 'RIGHT';
          else if (diffX < 0 && snake.direction !== 'RIGHT') snake.direction = 'LEFT';
        } else {
          if (diffY > 0 && snake.direction !== 'UP') snake.direction = 'DOWN';
          else if (diffY < 0 && snake.direction !== 'DOWN') snake.direction = 'UP';
        }
      }, false);
    }

    /* ----------------------------------------------
       17. Обновление полоски таймера
    ---------------------------------------------- */
    function updateTimerBar() {
      const percent = (timeLeft / 120) * 100;
      document.getElementById('timerFill').style.width = percent + '%';
    }

    /* ----------------------------------------------
       18. Завершение матча
    ---------------------------------------------- */
    function endGame() {
      gameStarted = false;
      document.getElementById('gameArea').style.display = 'none';

      let result = '';
      if (playerScore > opponentScore) result = 'Вы победили!';
      else if (playerScore < opponentScore) result = 'Вы проиграли...';
      else result = 'Ничья!';

      document.getElementById('endgameMessage').textContent =
        `Ваш счёт: ${playerScore}, Соперник: ${opponentScore}. ${result}`;
      document.getElementById('endgameBackdrop').classList.add('active');

      // Начислим очки
      let earnedPoints = (playerScore > opponentScore)
        ? 10 : (playerScore === opponentScore ? 5 : 2);
      localUserData.points = (localUserData.points || 0) + earnedPoints;
      if (userRef) {
        userRef.update({ points: localUserData.points });
      }

      // Очистим game-узел (по желанию)
      db.ref('games/' + gameId).remove();
    }

    /* ----------------------------------------------
       19. Кнопка "Продолжить" – возвращение на главную
    ---------------------------------------------- */
    function finishGame() {
      document.getElementById('endgameBackdrop').classList.remove('active');
      window.location.href = 'index.html';
    }

    /* ----------------------------------------------
       20. Модалка "нет билетов" – кнопка "Вернуться"
    ---------------------------------------------- */
    function returnToMain() {
      document.getElementById('noTicketsModal').classList.remove('active');
      window.location.href = 'index.html';
    }
  </script>
</body>
</html>
