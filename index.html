<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Mobile Games Site</title>

  <!-- Font: Press Start 2P -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <!-- Default theme -->
  <link id="themeStylesheet" rel="stylesheet" href="st1.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon/0.6.2/cannon.min.js"></script>

  <!-- Additional CSS for Loot Box block -->
  <style>
    .case-container {
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-top: -60px;
      text-align: center;
      position: relative;
      top: 50px;
      display: inline-block;
      transition: top 0.5s ease;
    }
    .case-container.open {
      top: 20px;
    }
    .case-container img {
      display: block;
      margin: 0 auto;
      width: 330px;
      height: 330px;
      transition: width 0.5s ease, height 0.5s ease, transform 0.5s ease;
    }
    .case-container.open img {
      width: 500px;
      height: 500px;
      transform: translateY(-30px);
    }
    .explode {
      animation: explode 0.8s ease-out forwards;
    }
    @keyframes explode {
      0% {
        transform: scale(1) rotate(0deg);
        opacity: 1;
        filter: brightness(1);
      }
      50% {
        transform: scale(1.3) rotate(20deg);
        opacity: 0.8;
        filter: brightness(1.2);
      }
      70% {
        transform: scale(1.1) rotate(10deg);
        opacity: 0.9;
        filter: brightness(1.1);
      }
      100% {
        transform: scale(2.5) rotate(45deg);
        opacity: 0;
        filter: brightness(0.5);
      }
    }
    .case-container p {
      position: absolute;
      bottom: 420px;
      left: 50%;
      transform: translateX(-50%);
      font-weight: bold;
      margin: 0;
      pointer-events: none;
      z-index: 1;
    }
    .lootbox-buttons {
      position: relative;
      z-index: 10;
      transition: opacity 0.5s ease;
      display: flex;
      gap: 10px;
      margin-top: 80px;
    }
    .case-container.open .lootbox-buttons {
      opacity: 0;
      pointer-events: none;
    }
  </style>

  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/gifler@0.1.0/gifler.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <!-- Header -->
  <header>
    <a href="buy.html" id="walletLink" class="walletLink" style="position: absolute; top: 5px; left: 10px;">
      <img src="https://raw.githubusercontent.com/qnexst/404token/main/wallet.png" alt="Wallet" width="45" height="45"/>
    </a>
    <div class="user-info">
      <img id="userPhoto" src="" alt="Avatar"/>
      <span id="username">@User</span>
    </div>
    <div class="balances">
      <span>
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png"
             alt="Tickets" width="20"/>
        <span id="ticketCount">0</span>
      </span>
      <span>
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/token.png"
             alt="Coins" width="20"/>
        <span id="coinCount">0</span>
      </span>
      <span>
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/star.png"
             alt="Points" width="20"/>
        <span id="pointCount">0</span>
      </span>
    </div>
  </header>

  <!-- Main Content -->
  <main>
    <!-- PLAY SECTION -->
    <section id="playSection" class="section active">
      <div class="games-section">
        <h3>
          <span id="mainOnlineHeaderText">Main Online Games</span>
          <button id="mainOnlineInfoBtn" class="info-button" onclick="openMainOnlineInfoModal()">Info</button>
        </h3>
        <div class="games-gallery">
          <div class="game-card">
            <img src="https://raw.githubusercontent.com/qnexst/404token/main/1.jpg" alt="Special Game">
            <p id="gameCard1Title">Online snake</p>
            <button id="gameCard1Button" onclick="window.location.href='specialgame.html'">More Details</button>
          </div>
        </div>
      </div>

      <div class="games-section">
        <h3>
          <span id="miniGamesHeaderText">Mini Games</span>
          <button id="miniGamesInfoBtn" class="info-button" onclick="openMiniGamesInfoModal()">Info</button>
        </h3>
        <div class="games-gallery">
          <div class="game-card">
            <img src="https://raw.githubusercontent.com/qnexst/404token/main/1.jpg" alt="Match-3">
            <p id="gameCard2Title">Match-3</p>
            <button id="gameCard2Button" onclick="openGameInfoModal({
              gameId: 'game2',
              title: 'Match-3',
              img: 'https://img.icons8.com/external-icongeek26-glyph-icongeek26/64/00FF00/external-candy-alimentation-icongeek26-glyph-icongeek26.png',
              desc: 'Connect three or more candies to pass levels.',
              cost: 1
            })">More Details</button>
          </div>
          <div class="game-card">
            <img src="https://raw.githubusercontent.com/qnexst/404token/main/tetris.jpg" alt="Game 3">
            <p id="gameCard3Title">Game 3</p>
            <button id="gameCard3Button" onclick="openGameInfoModal({
              gameId: 'game3',
              title: 'Game 3',
              img: 'https://raw.githubusercontent.com/qnexst/404token/main/tetris.jpg',
              desc: 'Description of Game 3...',
              cost: 1
            })">More Details</button>
          </div>
          <div class="game-card">
            <img src="https://raw.githubusercontent.com/qnexst/404token/main/breakout.jpg" alt="Space Explorer">
            <p id="gameCard4Title">Space Explorer</p>
            <button id="gameCard4Button" onclick="openGameInfoModal({
              gameId: 'game4',
              title: 'Space Explorer',
              img: 'https://raw.githubusercontent.com/qnexst/404token/main/breakout.jpg',
              desc: 'Explore space, avoid asteroids, and collect stars.',
              cost: 1
            })">More Details</button>
          </div>
        </div>
      </div>

      <div class="games-section">
        <h3>
          <span id="partnerGamesHeaderText">Partner Games</span>
          <button id="partnerInfoBtn" class="info-button" onclick="openPartnerInfoModal()">Info</button>
        </h3>
        <div class="games-gallery">
          <div class="game-card">
            <img src="https://img.icons8.com/ios-filled/50/00FF00/handshake.png" alt="Partner Game">
            <p id="gameCard5Title">Partner Game</p>
            <button id="gameCard5Button" onclick="openGameInfoModal({
              gameId: 'partnergame1',
              title: 'soon',
              img: 'https://img.icons8.com/ios-filled/50/00000/handshake.png',
              desc: 'Game from our partner.',
              cost: 1
            })">More Details</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TICKETS SECTION -->
    <section id="ticketsSection" class="section">
      <!-- Tickets section content -->
    </section>

    <!-- LEADERBOARD SECTION -->
    <section id="leaderboardSection" class="section">
      <!-- Leaderboard content -->
    </section>

    <!-- LOOT BOX SECTION -->
    <section id="referralSection" class="section">
      <!-- Loot box content -->
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav id="mainNav">
    <button onclick="showSection('playSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/playing.png" alt="Play" id="navPlayAlt"/>
    </button>
    <button onclick="showSection('ticketsSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/ticket.png" alt="Tickets" id="navTicketsAlt"/>
    </button>
    <button onclick="showSection('leaderboardSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/trophy.png" alt="Leaderboard" id="navLeaderboardAlt"/>
    </button>
    <button onclick="showSection('referralSection')">
      <img src="https://img.icons8.com/ios-filled/50/question-mark.png" alt="Cyber Case" id="navReferralAlt"/>
    </button>
  </nav>

  <!-- Global Modal -->
  <div class="modal-backdrop" id="globalModalBackdrop">
    <div class="modal">
      <h2 id="globalModalTitle">Message</h2>
      <p id="globalModalMessage"></p>
      <button class="close-modal" onclick="closeGlobalModal()">OK</button>
    </div>
  </div>

  <!-- Season Info Modal -->
  <div class="modal-backdrop" id="seasonModalBackdrop">
    <div class="modal modal-season">
      <h2 id="seasonModalTitle">Season Information</h2>
      <p id="seasonModalDesc">Season 1. The season lasts 1 week. At the end of the season, each of the top 10 players automatically receives one case.</p>
      <button class="close-modal" onclick="closeSeasonModal()">Close</button>
    </div>
  </div>

  <!-- Modal for Loot Box Info -->
  <div class="modal-backdrop" id="lootBoxInfoModal">
    <div class="modal">
      <h2 id="lootBoxInfoTitle">Loot Box Info</h2>
      <p id="lootBoxInfoDesc">You can spin the loot box using coins or data chip.</p>
      <button class="close-modal" onclick="closeLootBoxInfoModal()">Close</button>
    </div>
  </div>

  <!-- Game Info Modal -->
  <div class="modal-backdrop" id="gameInfoModal">
    <div class="modal">
      <img id="gameInfoImg" src="" alt="Game Image" style="max-width:100px; display:block; margin:0 auto 10px;" />
      <h2 id="gameInfoTitle" style="text-align:center;"></h2>
      <p id="gameInfoDesc"></p>
      <button id="gameInfoPlayBtn">Play</button>
      <button class="close-modal" onclick="closeGameInfoModal()">Close</button>
    </div>
  </div>

  <!-- Spin Result Modal -->
  <div class="modal-backdrop" id="spinModalBackdrop">
    <div class="modal">
      <h2 id="spinModalTitle">You won <span id="wheelTicketCount"></span> tickets!</h2>
      <button class="close-modal" onclick="closeSpinModal()">OK</button>
    </div>
  </div>

  <!-- Fullscreen Game Modal -->
  <div class="game-modal-backdrop" id="gameModalBackdrop">
    <div class="game-modal-content">
      <div class="game-canvas">
         <canvas id="gameCanvas" width="400" height="740" style="display: block; position: relative; top: -0px;"></canvas>
         <canvas id="match3Canvas" width="400" height="740" style="display: block; position: relative; top: -0px;"></canvas>
         <canvas id="partnerGameCanvas" width="400" height="740" style="display: block; position: relative; top: -0px;"></canvas>
         <canvas id="game3Canvas" width="400" height="740" style="display: block; position: relative; top: -0px;"></canvas>
         <canvas id="game4Canvas" width="400" height="740" style="display: block; position: relative; top: -0px;"></canvas>
         <canvas id="game5Canvas" width="400" height="740" style="display: block; position: relative; top: -0px;"></canvas>
         <canvas id="game6Canvas" width="400" height="740" style="display: block; position: relative; top: -0px;"></canvas>
      </div>
    </div>
  </div>

  <!-- Endgame Modal -->
  <div class="endgame-backdrop" id="endgameBackdrop">
    <div class="endgame-modal">
      <h2 id="endgameTitle">Result</h2>
      <p id="endgameMessage"></p>
      <button class="close-modal" onclick="finishGame()">Close</button>
    </div>
  </div>

  <!-- Modal for Main Online Games Info -->
  <div class="modal-backdrop" id="mainOnlineInfoModal">
    <div class="modal">
      <h2 id="mainOnlineInfoTitle">Main Online Games Info</h2>
      <p id="mainOnlineInfoDesc">This section includes 2 main games: Dino Runner and Special Game.</p>
      <button class="close-modal" onclick="closeMainOnlineInfoModal()">Close</button>
    </div>
  </div>

  <!-- Modal for Mini Games Info -->
  <div class="modal-backdrop" id="miniGamesInfoModal">
    <div class="modal">
      <h2 id="miniGamesInfoTitle">Mini Games Info</h2>
      <p id="miniGamesInfoDesc">Players participate in mini games, earning points for their activity. Every 3 days, top 10 players receive reward cases.</p>
      <button class="close-modal" onclick="closeMiniGamesInfoModal()">Close</button>
    </div>
  </div>

  <!-- Modal for Partner Games Info -->
  <div class="modal-backdrop" id="partnerInfoModal">
    <div class="modal">
      <h2 id="partnerInfoTitle">Partner Games Info</h2>
      <p id="partnerInfoDesc">Partner game from our partner.</p>
      <button class="close-modal" onclick="closePartnerInfoModal()">Close</button>
    </div>
  </div>

  <!-- Modal for Deposit -->
  <div class="modal-backdrop" id="depositModal">
    <div class="modal">
      <h2 id="depositModalTitle">Not enough coins</h2>
      <p id="depositModalDesc">You do not have enough coins to play. Please top up your balance.</p>
      <button class="close-modal" onclick="closeDepositModal()">Close</button>
    </div>
  </div>

  <!-- Include game scripts and main script -->
  <script src="game1.js"></script>
  <script src="game2.js"></script>
  <script src="partnergame1.js"></script>
  <script src="game3.js"></script>
  <!-- Inline исправленный game4.js -->
  <script>
    /* game4.js – 3D Breakout/Arkanoid Игра
       Современный минималистичный стиль с динамичным градиентным фоном и яркими элементами.
    */

    // ------------------------- Константы и настройки -------------------------
    const PADDLE_WIDTH = 150;
    const PADDLE_HEIGHT = 20;
    const PADDLE_DEPTH = 20;

    const BALL_RADIUS = 10;

    const BRICK_ROWS = 5;
    const BRICK_COLUMNS = 10;
    const BRICK_WIDTH = 60;
    const BRICK_HEIGHT = 20;
    const BRICK_DEPTH = 20;
    const BRICK_PADDING = 10;
    const BRICK_OFFSET_TOP = 50;
    const BRICK_OFFSET_LEFT = 30;

    // Границы игрового поля (в мировых координатах)
    const GAME_LEFT = -400;
    const GAME_RIGHT = 400;
    const GAME_TOP = 500;
    const GAME_BOTTOM = 0;

    // ------------------------- Глобальные переменные -------------------------
    let scene, camera, renderer;
    let breakoutCanvas; // теперь будет ссылаться на canvas с id "game4Canvas"
    let animationFrameId;
    let gameRunning = false;

    let score = 0;
    let lives = 3;

    let paddle, ball, bricks = [];
    let ballVelocity = new THREE.Vector3(2, -2, 2); // начальная скорость шарика

    // Переменные для динамичного фона
    let bgCanvas, bgContext, bgTexture;

    // ------------------------- Функции фона -------------------------
    function createBackgroundTexture() {
      bgCanvas = document.createElement("canvas");
      bgCanvas.width = 16;
      bgCanvas.height = 256;
      bgContext = bgCanvas.getContext("2d");
      bgTexture = new THREE.CanvasTexture(bgCanvas);
      return bgTexture;
    }
    function updateBackground() {
      let t = Date.now() * 0.001;
      let offset = (Math.sin(t / 10) + 1) / 2;
      let color1 = "#000000";
      let color2 = "#121212";
      let color3 = "#1E1E2F";
      let color4 = "#2C2C3E";
      let grad = bgContext.createLinearGradient(0, 0, 0, bgCanvas.height);
      grad.addColorStop(0, color1);
      grad.addColorStop(0.4 + 0.1 * offset, color2);
      grad.addColorStop(0.7 + 0.1 * offset, color3);
      grad.addColorStop(1, color4);
      bgContext.fillStyle = grad;
      bgContext.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
      bgTexture.needsUpdate = true;
    }

    // ------------------------- Инициализация Three.js -------------------------
    function initThree() {
      scene = new THREE.Scene();
      scene.background = createBackgroundTexture();

      camera = new THREE.PerspectiveCamera(60, breakoutCanvas.width / breakoutCanvas.height, 1, 2000);
      camera.position.set(0, 300, 800);
      camera.lookAt(new THREE.Vector3(0, 300, 0));
      camera.updateProjectionMatrix();

      renderer = new THREE.WebGLRenderer({ canvas: breakoutCanvas, antialias: true });
      renderer.setSize(breakoutCanvas.width, breakoutCanvas.height);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;

      let ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
      scene.add(ambientLight);

      let directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
      directionalLight.position.set(100, 200, 100);
      directionalLight.castShadow = true;
      scene.add(directionalLight);
    }

    // ------------------------- Создание игровых объектов -------------------------
    function createPaddle() {
      const geometry = new THREE.BoxGeometry(PADDLE_WIDTH, PADDLE_HEIGHT, PADDLE_DEPTH);
      const material = new THREE.MeshLambertMaterial({ color: 0x0095DD });
      let paddleMesh = new THREE.Mesh(geometry, material);
      paddleMesh.position.set(0, PADDLE_HEIGHT / 2, -250);
      paddleMesh.castShadow = true;
      paddleMesh.receiveShadow = true;
      scene.add(paddleMesh);
      return paddleMesh;
    }
    function createBall() {
      const geometry = new THREE.SphereGeometry(BALL_RADIUS, 32, 32);
      const material = new THREE.MeshLambertMaterial({ color: 0xFF4500 });
      let ballMesh = new THREE.Mesh(geometry, material);
      ballMesh.position.set(0, BALL_RADIUS + 200, -240);
      ballMesh.castShadow = true;
      ballMesh.receiveShadow = true;
      scene.add(ballMesh);
      return ballMesh;
    }
    function createBricks() {
      let brickArray = [];
      for (let r = 0; r < BRICK_ROWS; r++) {
        brickArray[r] = [];
        for (let c = 0; c < BRICK_COLUMNS; c++) {
          const geometry = new THREE.BoxGeometry(BRICK_WIDTH, BRICK_HEIGHT, BRICK_DEPTH);
          const material = new THREE.MeshLambertMaterial({ color: getRandomBrickColor() });
          let brickMesh = new THREE.Mesh(geometry, material);
          let x = c * (BRICK_WIDTH + BRICK_PADDING) - ((BRICK_COLUMNS * (BRICK_WIDTH + BRICK_PADDING)) / 2) + BRICK_WIDTH / 2 + BRICK_OFFSET_LEFT;
          let y = GAME_TOP - r * (BRICK_HEIGHT + BRICK_PADDING) - BRICK_OFFSET_TOP;
          brickMesh.position.set(x, y, 0);
          brickMesh.castShadow = true;
          brickMesh.receiveShadow = true;
          scene.add(brickMesh);
          brickArray[r][c] = { mesh: brickMesh, status: 1 };
        }
      }
      return brickArray;
    }
    function getRandomBrickColor() {
      const colors = [0xff5733, 0xffbd33, 0x75ff33, 0x33ffbd, 0x3375ff, 0xbd33ff];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    // ------------------------- Обработка столкновений -------------------------
    function checkCollisionSphereBox(sphere, box) {
      let boxPos = box.position;
      let boxSize = new THREE.Vector3();
      box.geometry.computeBoundingBox();
      box.geometry.boundingBox.getSize(boxSize);
      let halfExtents = boxSize.multiplyScalar(0.5);
      let closestPoint = new THREE.Vector3(
        THREE.MathUtils.clamp(sphere.position.x, boxPos.x - halfExtents.x, boxPos.x + halfExtents.x),
        THREE.MathUtils.clamp(sphere.position.y, boxPos.y - halfExtents.y, boxPos.y + halfExtents.y),
        THREE.MathUtils.clamp(sphere.position.z, boxPos.z - halfExtents.z, boxPos.z + halfExtents.z)
      );
      let distance = sphere.position.distanceTo(closestPoint);
      return distance < BALL_RADIUS;
    }
    function checkCollisionSpherePlane(sphere, planeY) {
      return (sphere.position.y - BALL_RADIUS) < planeY;
    }

    // ------------------------- Управление и обновление игры -------------------------
    function updateGame() {
      updateBackground();
      ball.position.add(ballVelocity);

      if (ball.position.x + BALL_RADIUS > GAME_RIGHT) {
        ball.position.x = GAME_RIGHT - BALL_RADIUS;
        ballVelocity.x = -ballVelocity.x;
      }
      if (ball.position.x - BALL_RADIUS < GAME_LEFT) {
        ball.position.x = GAME_LEFT + BALL_RADIUS;
        ballVelocity.x = -ballVelocity.x;
      }
      if (ball.position.y + BALL_RADIUS > GAME_TOP) {
        ball.position.y = GAME_TOP - BALL_RADIUS;
        ballVelocity.y = -ballVelocity.y;
      }
      if (ball.position.y - BALL_RADIUS < GAME_BOTTOM) {
        lives--;
        if (lives <= 0) {
          gameOver();
          return;
        } else {
          resetBallAndPaddle();
        }
      }
      if (checkCollisionSphereBox(ball, paddle)) {
        ballVelocity.y = Math.abs(ballVelocity.y);
        let hitPoint = (ball.position.x - paddle.position.x) / (PADDLE_WIDTH / 2);
        ballVelocity.x = hitPoint * 5;
      }
      for (let r = 0; r < bricks.length; r++) {
        for (let c = 0; c < bricks[r].length; c++) {
          let brick = bricks[r][c];
          if (brick.status === 1 && checkCollisionSphereBox(ball, brick.mesh)) {
            scene.remove(brick.mesh);
            brick.status = 0;
            score += 10;
            ballVelocity.y = -ballVelocity.y;
          }
        }
      }
    }
    function resetBallAndPaddle() {
      ball.position.set(0, BALL_RADIUS + 200, -240);
      ballVelocity.set(2, -2, 2);
      paddle.position.set(0, PADDLE_HEIGHT / 2, -250);
    }
    function gameLoop() {
      if (!gameRunning) return;
      updateGame();
      renderer.render(scene, camera);
      animationFrameId = requestAnimationFrame(gameLoop);
    }
    function gameOver() {
      gameRunning = false;
      cancelAnimationFrame(animationFrameId);
      window.removeEventListener("mousemove", onMouseMove);
      alert("Game Over! Score: " + score);
    }

    // ------------------------- Управление платформой -------------------------
    function onMouseMove(event) {
      let rect = breakoutCanvas.getBoundingClientRect();
      let mouseX = event.clientX - rect.left;
      let normalizedX = (mouseX / rect.width) * 2 - 1;
      paddle.position.x = normalizedX * (GAME_RIGHT - 50);
    }

    // ------------------------- Инициализация игры -------------------------
    function initGame4() {
      breakoutCanvas = document.getElementById("game4Canvas"); // Исправлено: ищем "game4Canvas"
      if (!breakoutCanvas) {
        console.error("Элемент canvas с id 'game4Canvas' не найден.");
        return;
      }
      initThree();
      paddle = createPaddle();
      ball = createBall();
      bricks = createBricks();
      score = 0;
      lives = 3;
      gameRunning = true;
      window.addEventListener("mousemove", onMouseMove);
      gameLoop();
    }
    function resetGame4() {
      cancelAnimationFrame(animationFrameId);
      window.removeEventListener("mousemove", onMouseMove);
      if (renderer) {
        renderer.clear();
      }
    }
  </script>
  <script src="game5.js"></script>
  <script src="game6.js"></script>
  <script src="case.js"></script>

  <script>
    /* ----------------------------------------------
       Firebase Initialization
    ---------------------------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ----------------------------------------------
       Telegram Web App
    ---------------------------------------------- */
    const tg = window.Telegram.WebApp;
    tg.expand();

    /* ----------------------------------------------
       Global Variables & User Data
    ---------------------------------------------- */
    let currentUser = null;
    let userRef = null;
    let localUserData = {
      photo: '',
      tickets: 0,
      coins: 0,
      points: 0,
      lastSpinTime: 0,
      dataChip: false,
      cyberCase: 0
    };
    let gameInProgress = false;
    let isSpinning = false;

    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
      document.getElementById('username').textContent = '@' + currentUser.username;
      if (currentUser.photo_url) {
        document.getElementById('userPhoto').src = currentUser.photo_url;
      }
      userRef = db.ref('users/' + currentUser.username);
      userRef.once('value', snapshot => {
        if (!snapshot.exists()) {
          userRef.set({
            photo: currentUser.photo_url || '',
            tickets: 0,
            coins: 0,
            points: 0,
            lastSpinTime: 0,
            dataChip: false,
            cyberCase: 0
          });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData = {
          photo: data.photo || '',
          tickets: data.tickets || 0,
          coins: data.coins || 0,
          points: data.points || 0,
          lastSpinTime: data.lastSpinTime || 0,
          dataChip: data.dataChip || false,
          cyberCase: data.cyberCase || 0
        };
        updateTopBar();
        updateSpinButton();
        updateCaseCount();
      });
    }

    /* ----------------------------------------------
       Update Top Bar & Case Count
    ---------------------------------------------- */
    function updateTopBar() {
      document.getElementById('ticketCount').textContent = localUserData.tickets || 0;
      document.getElementById('coinCount').textContent   = localUserData.coins || 0;
      document.getElementById('pointCount').textContent  = localUserData.points || 0;
    }
    function updateCaseCount() {
      document.getElementById('openBtn').textContent = `Decrypt data (${localUserData.cyberCase})`;
    }

    /* ----------------------------------------------
       Section Switching
    ---------------------------------------------- */
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('.modal-backdrop').forEach(modal => modal.classList.remove('active'));
      document.getElementById('gameModalBackdrop').classList.remove('active');
      document.getElementById('endgameBackdrop').classList.remove('active');
      document.getElementById(sectionId).classList.add('active');
    }

    /* ----------------------------------------------
       Global Modal
    ---------------------------------------------- */
    function showGlobalModal(title, message) {
      document.getElementById('globalModalTitle').textContent = title;
      document.getElementById('globalModalMessage').textContent = message;
      document.getElementById('globalModalBackdrop').classList.add('active');
    }
    function closeGlobalModal() {
      document.getElementById('globalModalBackdrop').classList.remove('active');
    }

    /* ----------------------------------------------
       Game Info Modal
    ---------------------------------------------- */
    function openGameInfoModal(gameData) {
      document.getElementById('gameInfoImg').src = gameData.img;
      document.getElementById('gameInfoTitle').textContent = gameData.title;
      document.getElementById('gameInfoDesc').textContent = gameData.desc;
      const playBtn = document.getElementById('gameInfoPlayBtn');
      playBtn.textContent = "Play (" + gameData.cost + " ticket)";
      playBtn.onclick = function() {
        closeGameInfoModal();
        handleStartGame(gameData.gameId, gameData.cost);
      };
      document.getElementById('gameInfoModal').classList.add('active');
    }
    function closeGameInfoModal() {
      document.getElementById('gameInfoModal').classList.remove('active');
    }

    /* ----------------------------------------------
       Start Game
    ---------------------------------------------- */
    let currentGame = null;
    function handleStartGame(gameName, ticketCost) {
      document.querySelector('.user-info').style.display = 'none';
      if (!currentUser || !userRef) {
        showGlobalModal("Error", "No user data available!");
        return;
      }
      if ((localUserData.tickets || 0) < ticketCost) {
        showGlobalModal("Not enough tickets", "You do not have enough tickets to play!");
        return;
      }
      localUserData.tickets -= ticketCost;
      updateTopBar();
      userRef.update({ tickets: localUserData.tickets });
      currentGame = gameName;
      gameInProgress = true;
      document.getElementById('mainNav').classList.add('hidden');

      document.getElementById('gameCanvas').style.display = 'none';
      document.getElementById('match3Canvas').style.display = 'none';
      document.getElementById('partnerGameCanvas').style.display = 'none';
      document.getElementById('game3Canvas').style.display = 'none';
      document.getElementById('game4Canvas').style.display = 'none';
      document.getElementById('game5Canvas').style.display = 'none';
      document.getElementById('game6Canvas').style.display = 'none';

      document.getElementById('gameModalBackdrop').classList.add('active');

      if (gameName === 'game1') {
        document.getElementById('gameCanvas').style.display = 'block';
        initGame1();
      } else if (gameName === 'game2') {
        document.getElementById('match3Canvas').style.display = 'block';
        initGame2();
      } else if (gameName === 'partnergame1') {
        document.getElementById('partnerGameCanvas').style.display = 'block';
        initPartnerGame1();
      } else if (gameName === 'game3') {
        document.getElementById('game3Canvas').style.display = 'block';
        initGame3();
      } else if (gameName === 'game4') {
        document.getElementById('game4Canvas').style.display = 'block';
        initGame4();
      } else if (gameName === 'game5') {
        document.getElementById('game5Canvas').style.display = 'block';
        initGame5();
      } else if (gameName === 'game6') {
        document.getElementById('game6Canvas').style.display = 'block';
        initGame6();
      }
    }

    /* ----------------------------------------------
       End Game Modal
    ---------------------------------------------- */
    function showEndGameModal(title, message) {
      document.getElementById('endgameTitle').textContent = "Result";
      document.getElementById('endgameMessage').textContent = message;
      document.getElementById('endgameBackdrop').classList.add('active');
    }
    function finishGame() {
      document.querySelector('.user-info').style.display = '';
      document.getElementById('endgameBackdrop').classList.remove('active');
      closeGameModal();
    }
    function closeGameModal() {
      document.getElementById('gameModalBackdrop').classList.remove('active');
      document.getElementById('mainNav').classList.remove('hidden');
      if (userRef && currentGame) {
        userRef.update({ points: localUserData.points });
      }
      if (currentGame === 'game1') {
        resetGame1();
      } else if (currentGame === 'game2') {
        resetGame2();
      } else if (currentGame === 'partnergame1') {
        resetPartnerGame1();
      } else if (currentGame === 'game3') {
        resetGame3();
      } else if (currentGame === 'game4') {
        resetGame4();
      } else if (currentGame === 'game5') {
        resetGame5();
      } else if (currentGame === 'game6') {
        resetGame6();
      }
      currentGame = null;
      gameInProgress = false;
    }

    /* ----------------------------------------------
       Wheel of Fortune / Tickets
    ---------------------------------------------- */
    let spinDuration = 4000;
    function spinWheel() {
      if (!currentUser) return;
      const now = Date.now();
      if (now - (localUserData.lastSpinTime || 0) < 24 * 60 * 60 * 1000) {
        showGlobalModal("Wheel of Fortune", "Free spin available once every 24 hours!");
        return;
      }
      localUserData.lastSpinTime = now;
      userRef.update({ lastSpinTime: now });
      updateSpinButton();
      let randomRotation = 1080 + Math.floor(Math.random() * 360);
      const wheelEl = document.getElementById('wheel');
      wheelEl.style.transform = `rotate(${randomRotation}deg)`;
      setTimeout(() => {
        let finalDeg = randomRotation % 360;
        let wonTickets = 0;
        if (finalDeg < 60) {
          wonTickets = 5;
        } else if (finalDeg < 120) {
          wonTickets = 10;
        } else if (finalDeg < 180) {
          wonTickets = 15;
        } else if (finalDeg < 240) {
          wonTickets = 20;
        } else if (finalDeg < 300) {
          wonTickets = 25;
        } else {
          wonTickets = 30;
        }
        localUserData.tickets += wonTickets;
        updateTopBar();
        userRef.update({ tickets: localUserData.tickets });
        showSpinModal(wonTickets);
      }, spinDuration);
    }
    function showSpinModal(amount) {
      document.getElementById("wheelTicketCount").textContent = amount;
      document.getElementById("spinModalTitle").innerHTML = "You won <span id='wheelTicketCount'>" + amount + "</span> tickets!";
      document.getElementById("spinModalBackdrop").classList.add("active");
    }
    function closeSpinModal() {
      document.getElementById("spinModalBackdrop").classList.remove("active");
    }
    function updateSpinButton() {
      const btn = document.getElementById('spinButton');
      const now = Date.now();
      const last = localUserData.lastSpinTime || 0;
      const diff = now - last;
      const wait = 24 * 60 * 60 * 1000 - diff;
      if(wait <= 0) {
         btn.textContent = "Spin";
         btn.disabled = false;
      } else {
         const seconds = Math.floor(wait / 1000) % 60;
         const minutes = Math.floor(wait / (1000 * 60)) % 60;
         const hours = Math.floor(wait / (1000 * 60 * 60));
         btn.textContent = "Spin (" + hours.toString().padStart(2,'0') + ":" + minutes.toString().padStart(2,'0') + ":" + seconds.toString().padStart(2,'0') + ")";
         btn.disabled = true;
      }
    }
    setInterval(updateSpinButton, 1000);

    /* ----------------------------------------------
       Leaderboard
    ---------------------------------------------- */
    let leaderboardRef = db.ref('users');
    leaderboardRef.on('value', snapshot => {
      const usersData = snapshot.val() || {};
      const usersArray = Object.entries(usersData).map(([uname, obj]) => ({
        username: uname,
        points: obj.points || 0
      }));
      usersArray.sort((a, b) => b.points - a.points);
      const top10Body = document.getElementById('leaderboardTop10');
      const restBody = document.getElementById('leaderboardRest');
      top10Body.innerHTML = '';
      restBody.innerHTML = '';
      usersArray.forEach((user, i) => {
        const tr = document.createElement('tr');
        if (currentUser && user.username === currentUser.username) {
          tr.classList.add('current-user');
        }
        if (i < 10) {
          tr.innerHTML = `<td>${i + 1}</td>
                          <td>@${user.username}</td>
                          <td>${user.points}</td>
                          <td><img src="https://raw.githubusercontent.com/qnexst/404token/main/case.png" alt="Prize Icon" width="40" height="40"></td>`;
          top10Body.appendChild(tr);
        } else {
          tr.innerHTML = `<td>${i + 1}</td>
                          <td>@${user.username}</td>
                          <td>${user.points}</td>
                          <td></td>`;
          restBody.appendChild(tr);
        }
      });
    });

    function openSeasonInfoModal() {
      document.getElementById('seasonModalBackdrop').classList.add('active');
    }
    function closeSeasonModal() {
      document.getElementById('seasonModalBackdrop').classList.remove('active');
    }

    /* ----------------------------------------------
       Buy Tickets
    ---------------------------------------------- */
    function buyTickets() {
      window.location.href = 'buyticket.html';
    }

    /* ----------------------------------------------
       Lootbox in Cyber Case Section
    ---------------------------------------------- */
    const lootboxPrizes = [
      { name: '3 tickets', image: 'https://raw.githubusercontent.com/qnexst/404token/main/ticket.png', chance: 60 },
      { name: '5 tickets', image: 'https://raw.githubusercontent.com/qnexst/404token/main/ticket.png', chance: 25 },
      { name: 'One case', image: 'https://raw.githubusercontent.com/qnexst/404token/main/case.png', chance: 5 },
      { name: '1000 points', image: 'https://raw.githubusercontent.com/qnexst/404token/main/star.png', chance: 5 },
      { name: '5000 points', image: 'https://raw.githubusercontent.com/qnexst/404token/main/star.png', chance: 4.989 },
      { name: '1M tokens', image: 'https://raw.githubusercontent.com/qnexst/404token/main/token.png', chance: 0.01 },
      { name: '5M tokens', image: 'https://raw.githubusercontent.com/qnexst/404token/main/token.png', chance: 0.001 }
    ];

    let referralInitialized = false;
    function initReferralLootbox() {
      if (referralInitialized) return;
      referralInitialized = true;
      const rouletteContainer = document.getElementById('lootboxRoulette');
      rouletteContainer.innerHTML = '';
      for (let cycle = 0; cycle < 6; cycle++) {
        lootboxPrizes.forEach(item => {
          const prizeEl = document.createElement('div');
          prizeEl.className = 'lootbox-prize';
          prizeEl.innerHTML = `<img src="${item.image}" alt="${item.name}">
                               <span>${item.name}</span>`;
          rouletteContainer.appendChild(prizeEl);
        });
      }
    }
    function getWeightedRandomIndex(prizes) {
      let total = 0;
      prizes.forEach(prize => total += prize.chance);
      let randomNum = Math.random() * total;
      for (let i = 0; i < prizes.length; i++) {
        if (randomNum < prizes[i].chance) {
          return i;
        }
        randomNum -= prizes[i].chance;
      }
      return prizes.length - 1;
    }
    function parsePrizeAmount(prizeName) {
      if (prizeName.includes("M")) {
        let num = parseFloat(prizeName);
        return num * 1000000;
      } else {
        return parseInt(prizeName);
      }
    }
    function addPrizeToUser(prize) {
      if (prize.name.toLowerCase().includes("token")) {
         let amount = parsePrizeAmount(prize.name);
         localUserData.coins += amount;
         userRef.update({ coins: localUserData.coins });
         updateTopBar();
      } else if (prize.name.toLowerCase().includes("case")) {
         localUserData.cyberCase += 1;
         userRef.update({ cyberCase: localUserData.cyberCase });
         updateCaseCount();
      } else if (prize.name.toLowerCase().includes("progress") || prize.name.toLowerCase().includes("star")) {
         let amount = parsePrizeAmount(prize.name);
         localUserData.points += amount;
         userRef.update({ points: localUserData.points });
         updateTopBar();
      } else {
         let amount = parsePrizeAmount(prize.name);
         localUserData.tickets += amount;
         userRef.update({ tickets: localUserData.tickets });
         updateTopBar();
      }
    }
    function spinLootBoxForTokens() {
      if (!currentUser) return;
      if (isSpinning) return;
      if (localUserData.coins < 5000000) {
        showGlobalModal("Not enough coins", "You do not have enough coins to play. Please top up your balance.");
        return;
      }
      isSpinning = true;
      localUserData.coins -= 5000000;
      updateTopBar();
      userRef.update({ coins: localUserData.coins });

      const caseImage = document.getElementById('caseImage');
      caseImage.classList.add('explode');

      caseImage.addEventListener('animationend', () => {
        document.querySelector('.case-container').style.display = 'none';
        document.getElementById('lootboxContainer').style.display = 'block';
        spinRoulette();
      }, { once: true });
    }
    function openLootBox() {
      if (!currentUser) return;
      if (isSpinning) return;
      if (localUserData.cyberCase <= 0) {
        showGlobalModal('Error', 'You have no Cyber Case to open!');
        return;
      }
      isSpinning = true;
      localUserData.cyberCase -= 1;
      updateCaseCount();
      userRef.update({ cyberCase: localUserData.cyberCase });

      const caseImage = document.getElementById('caseImage');
      caseImage.classList.add('explode');

      caseImage.addEventListener('animationend', () => {
        document.querySelector('.case-container').style.display = 'none';
        document.getElementById('lootboxContainer').style.display = 'block';
        spinRoulette();
      }, { once: true });
    }
    function spinRoulette() {
      initReferralLootbox();
      const roulette = document.getElementById('lootboxRoulette');
      const prizeWidth = 136;
      const count = lootboxPrizes.length;
      const visibleCenter = roulette.parentElement.offsetWidth / 2;
      const fullCycles = 5;
      const randomIndex = getWeightedRandomIndex(lootboxPrizes);
      const finalIndex = randomIndex + fullCycles * count;
      const finalOffset = -(finalIndex * prizeWidth) + visibleCenter - (prizeWidth / 2);

      roulette.style.transition = 'transform 10s cubic-bezier(0.25, 0.1, 0.25, 1)';
      roulette.style.transform = `translateX(${finalOffset}px)`;

      setTimeout(() => {
        const remainder = finalIndex % count;
        const newOffset = -(remainder * prizeWidth) + visibleCenter - (prizeWidth / 2);
        roulette.style.transition = 'none';
        roulette.style.transform = `translateX(${newOffset}px)`;
        isSpinning = false;
        const prize = lootboxPrizes[randomIndex];
        addPrizeToUser(prize);
        showGlobalModal('Congratulations!', `Your prize: ${prize.name}`);

        document.getElementById('lootboxContainer').style.display = 'none';
        const caseContainer = document.querySelector('.case-container');
        caseContainer.style.display = 'block';
        const caseImage = document.getElementById('caseImage');
        caseImage.classList.remove('explode');
        caseImage.style.opacity = 1;
      }, 10200);
    }
    function openLootBoxInfoModal() {
      document.getElementById('lootBoxInfoModal').classList.add('active');
    }
    function closeLootBoxInfoModal() {
      document.getElementById('lootBoxInfoModal').classList.remove('active');
    }
    function openMainOnlineInfoModal() {
      document.getElementById('mainOnlineInfoModal').classList.add('active');
    }
    function closeMainOnlineInfoModal() {
      document.getElementById('mainOnlineInfoModal').classList.remove('active');
    }
    function openMiniGamesInfoModal() {
      document.getElementById('miniGamesInfoModal').classList.add('active');
    }
    function closeMiniGamesInfoModal() {
      document.getElementById('miniGamesInfoModal').classList.remove('active');
    }
    function openPartnerInfoModal() {
      document.getElementById('partnerInfoModal').classList.add('active');
    }
    function closePartnerInfoModal() {
      document.getElementById('partnerInfoModal').classList.remove('active');
    }
    function closeDepositModal() {
      document.getElementById('depositModal').classList.remove('active');
    }
  </script>
  <script>
    // Hidden key combination for admin panel access: Ctrl+Shift+A
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && e.shiftKey && e.key === 'A') {
        window.location.href = 'admin.html';
      }
    });
  </script>
</body>
</html>
