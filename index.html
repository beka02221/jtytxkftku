<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>Mobile Games Site</title>

  <!-- Font: Press Start 2P -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <!-- Подключение темы (по умолчанию st1.css) -->
  <link id="themeStylesheet" rel="stylesheet" href="st1.css">

  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/gifler@0.1.0/gifler.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
  <!-- Header -->
  <header>
    <!-- Иконка кошелька в левом верхнем углу -->
   <a href="buy.html" id="walletLink" class="walletLink" style="position: absolute; top: 0px; left: 3px;">
  <img src="wallet.png" alt="Wallet" width="50" height="50"/>
</a>


    <div class="user-info">
      <img id="userPhoto" src="" alt="Avatar"/>
      <span id="username">@User</span>
    </div>
    <div class="balances">
      <span>
        <img src="https://img.icons8.com/external-kmg-design-glyph-kmg-design/64/00FF00/external-ticket-cinema-kmg-design-glyph-kmg-design.png"
             alt="Tickets" width="20"/>
        <span id="ticketCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/coins.png"
             alt="Coins" width="20"/>
        <span id="coinCount">0</span>
      </span>
      <span>
        <img src="https://img.icons8.com/ios-filled/50/00FF00/rating.png"
             alt="Points" width="20"/>
        <span id="pointCount">0</span>
      </span>
    </div>
    <!-- Кнопка переключения языка -->
    <button id="languageSwitchBtn" style="position: absolute; top: 10px; right: 10px;" onclick="toggleLanguage()">Русский</button>
  </header>

  <!-- Main Content -->
  <main>
    <!-- PLAY SECTION (Галерея игр) -->
    <section id="playSection" class="section active">
      <!-- Main Online Games Section -->
      <div class="games-section">
        <h3>
          <span id="mainOnlineHeaderText">Main Online Games</span>
          <button id="mainOnlineInfoBtn" class="info-button" onclick="openMainOnlineInfoModal()">Info</button>
        </h3>
        <div class="games-gallery">
          <!-- Game Card 1: Dino Runner -->
          <div class="game-card">
            <img src="1.jpg" alt="Special Game">
            <p id="gameCard1Title">Online snake</p>
            <button id="gameCard1Button" onclick="window.location.href='specialgame.html'">More Details</button>
          </div>
        </div>
      </div>
      
      <!-- Mini Games Section -->
      <div class="games-section">
        <h3>
          <span id="miniGamesHeaderText">Mini Games</span>
          <button id="miniGamesInfoBtn" class="info-button" onclick="openMiniGamesInfoModal()">Info</button>
        </h3>
        <div class="games-gallery">
          <!-- Game Card: Match-3 -->
          <div class="game-card">
            <img src="https://img.icons8.com/external-icongeek26-glyph-icongeek26/64/00FF00/external-candy-alimentation-icongeek26-glyph-icongeek26.png" alt="Match-3">
            <p id="gameCard2Title">Match-3</p>
            <button id="gameCard2Button" onclick="openGameInfoModal({
              gameId: 'game2',
              title: 'Match-3',
              img: 'https://img.icons8.com/external-icongeek26-glyph-icongeek26/64/00FF00/external-candy-alimentation-icongeek26-glyph-icongeek26.png',
              desc: 'Connect three or more candies to pass levels.',
              cost: 1
            })">More Details</button>
          </div>
          
          <!-- Game Card: Game 3 -->
          <div class="game-card">
            <img src="https://img.icons8.com/ios-filled/50/00FF00/controller.png" alt="Game 3">
            <p id="gameCard3Title">Game 3</p>
            <button id="gameCard3Button" onclick="openGameInfoModal({
              gameId: 'game3',
              title: 'Game 3',
              img: 'https://img.icons8.com/ios-filled/50/00FF00/controller.png',
              desc: 'Description of Game 3...',
              cost: 1
            })">More Details</button>
          </div>
          
          <!-- Game Card: Space Explorer -->
          <div class="game-card">
            <img src="https://img.icons8.com/ios-filled/64/00FF00/rocket.png" alt="Space Explorer">
            <p id="gameCard4Title">Space Explorer</p>
            <button id="gameCard4Button" onclick="openGameInfoModal({
              gameId: 'game4',
              title: 'Space Explorer',
              img: 'https://img.icons8.com/ios-filled/64/00FF00/rocket.png',
              desc: 'Explore space, avoid asteroids, and collect stars.',
              cost: 1
            })">More Details</button>
          </div>
        </div>
      </div>
      
      <!-- Partner Games Section -->
      <div class="games-section">
        <h3>
          <span id="partnerGamesHeaderText">Partner Games</span>
          <button id="partnerInfoBtn" class="info-button" onclick="openPartnerInfoModal()">Info</button>
        </h3>
        <div class="games-gallery">
          <!-- Game Card: Partner Game -->
          <div class="game-card">
            <img src="https://img.icons8.com/ios-filled/50/00FF00/handshake.png" alt="Partner Game">
            <p id="gameCard5Title">Partner Game</p>
            <button id="gameCard5Button" onclick="openGameInfoModal({
              gameId: 'partnergame1',
              title: 'Partner Game',
              img: 'https://img.icons8.com/ios-filled/50/00FF00/handshake.png',
              desc: 'Game from our partner.',
              cost: 1
            })">More Details</button>
          </div>
        </div>
      </div>
    </section>

    <!-- TICKETS SECTION (Колесо) -->
    <section id="ticketsSection" class="section">
      <h2 id="ticketsHeader">Tickets</h2>
      <div class="wheel-container">
        <div class="wheel" id="wheel">
          <div class="slice slice1">
            <img width="24" height="32" src="https://img.icons8.com/forma-thin/24/ticket.png" alt="ticket"/>
            <span>5</span>
          </div>
          <div class="slice slice2">
            <img width="24" height="32" src="https://img.icons8.com/forma-thin/24/ticket.png" alt="ticket"/>
            <span>10</span>
          </div>
          <div class="slice slice3">
            <img width="24" height="32" src="https://img.icons8.com/forma-thin/24/ticket.png" alt="ticket"/>
            <span>15</span>
          </div>
          <div class="slice slice4">
            <img width="24" height="32" src="https://img.icons8.com/forma-thin/24/ticket.png" alt="ticket"/>
            <span>20</span>
          </div>
          <div class="slice slice5">
            <img width="24" height="32" src="https://img.icons8.com/forma-thin/24/ticket.png" alt="ticket"/>
            <span>25</span>
          </div>
          <div class="slice slice6">
            <img width="24" height="32" src="https://img.icons8.com/forma-thin/24/ticket.png" alt="ticket"/>
            <span>30</span>
          </div>
        </div>
        <div class="wheel-pointer"></div>
        <div class="tickets-actions">
          <button id="spinButton" onclick="spinWheel()">Spin</button>
          <button id="buyTicketsBtn" onclick="buyTickets()">Buy Tickets</button>
        </div>
        <div class="spin-result" id="spinResult"></div>
      </div>
    </section>

    <!-- Leaderboard Section -->
    <section id="leaderboardSection" class="section">
      <h2 id="leaderboardHeader">Leaderboard</h2>
      <button class="info-button" onclick="openSeasonInfoModal()">Info</button>
      <div class="leaderboard-container">
        <table id="leaderboardTable">
          <thead>
            <tr>
              <th></th>
              <th></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="leaderboardBody">
            <!-- Данные лидерборда обновляются динамически -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Referral Section -->
    <section id="referralSection" class="section">
      <h2 id="referralHeader">Referral</h2>
      <div class="referral-container">
        <p id="referralText">Invite your friends using the link and earn bonuses!</p>
        <div class="referral-link" id="referralLink">
          Link will appear after login...
        </div>
        <button id="copyInviteBtn" class="copy-button" onclick="copyReferralLink()">Copy Link</button>
      </div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav id="mainNav">
    <button onclick="showSection('playSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/playing.png" alt="Play" id="navPlayAlt"/>
    </button>
    <button onclick="showSection('ticketsSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/ticket.png" alt="Tickets" id="navTicketsAlt"/>
    </button>
    <button onclick="showSection('leaderboardSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/trophy.png" alt="Leaderboard" id="navLeaderboardAlt"/>
    </button>
    <button onclick="showSection('referralSection')">
      <img src="https://img.icons8.com/ios-filled/50/ffffff/share.png" alt="Referral" id="navReferralAlt"/>
    </button>
  </nav>

  <!-- Global Modal -->
  <div class="modal-backdrop" id="globalModalBackdrop">
    <div class="modal">
      <h2 id="globalModalTitle">Message</h2>
      <p id="globalModalMessage"></p>
      <button class="close-modal" onclick="closeGlobalModal()">OK</button>
    </div>
  </div>

  <!-- Season Info Modal -->
  <div class="modal-backdrop" id="seasonModalBackdrop">
    <div class="modal modal-season">
      <h2 id="seasonModalTitle">Season Information</h2>
      <p id="seasonModalDesc">Details about the season, prizes, deadlines, etc.</p>
      <button class="close-modal" onclick="closeSeasonModal()">Close</button>
    </div>
  </div>

  <!-- Game Info Modal -->
  <div class="modal-backdrop" id="gameInfoModal">
    <div class="modal">
      <img id="gameInfoImg" src="" alt="Game Image" style="max-width:100px; display:block; margin:0 auto 10px;" />
      <h2 id="gameInfoTitle" style="text-align:center;"></h2>
      <p id="gameInfoDesc"></p>
      <button id="gameInfoPlayBtn">Play</button>
      <button class="close-modal" onclick="closeGameInfoModal()">Close</button>
    </div>
  </div>

  <!-- Spin Result Modal -->
  <div class="modal-backdrop" id="spinModalBackdrop">
    <div class="modal">
      <h2 id="spinModalTitle">You won <span id="wheelTicketCount"></span> tickets!</h2>
      <button class="close-modal" onclick="closeSpinModal()">OK</button>
    </div>
  </div>

  <!-- Fullscreen Game Modal -->
  <div class="game-modal-backdrop" id="gameModalBackdrop">
    <div class="game-modal-content">
      <div class="game-canvas">
        <canvas id="gameCanvas" width="400" height="650" style="display: block; position: relative; top: -50px;"></canvas>
        <canvas id="match3Canvas" width="400" height="650" style="display: block; position: relative; top: -50px;"></canvas>
        <canvas id="partnerGameCanvas" width="400" height="650" style="display: block; position: relative; top: -50px;"></canvas>
        <canvas id="game3Canvas" width="400" height="650" style="display: block; position: relative; top: -50px;"></canvas>
        <canvas id="game4Canvas" width="400" height="650" style="display: block; position: relative; top: -50px;"></canvas>
        <canvas id="game5Canvas" width="400" height="650" style="display: block; position: relative; top: -50px;"></canvas>
        <canvas id="game6Canvas" width="400" height="650" style="display: block; position: relative; top: -50px;"></canvas>
      </div>
    </div>
  </div>

  <!-- Endgame Modal -->
  <div class="endgame-backdrop" id="endgameBackdrop">
    <div class="endgame-modal">
      <h2 id="endgameTitle">Result</h2>
      <p id="endgameMessage"></p>
      <button class="close-modal" onclick="finishGame()">Close</button>
    </div>
  </div>

  <!-- Modal for Main Online Games Info -->
  <div class="modal-backdrop" id="mainOnlineInfoModal">
    <div class="modal">
      <h2 id="mainOnlineInfoTitle">Main Online Games Info</h2>
      <p id="mainOnlineInfoDesc">This section includes 2 main games: Dino Runner and Special Game.</p>
      <button class="close-modal" onclick="closeMainOnlineInfoModal()">Close</button>
    </div>
  </div>

  <!-- Modal for Mini Games Info -->
  <div class="modal-backdrop" id="miniGamesInfoModal">
    <div class="modal">
      <h2 id="miniGamesInfoTitle">Mini Games Info</h2>
      <p id="miniGamesInfoDesc">Players participate in mini games, earning points for their activity. Every 3 days, top 10 players receive reward cases.</p>
      <button class="close-modal" onclick="closeMiniGamesInfoModal()">Close</button>
    </div>
  </div>

  <!-- Modal for Partner Games Info -->
  <div class="modal-backdrop" id="partnerInfoModal">
    <div class="modal">
      <h2 id="partnerInfoTitle">Partner Games Info</h2>
      <p id="partnerInfoDesc">Partner game from our partner.</p>
      <button class="close-modal" onclick="closePartnerInfoModal()">Close</button>
    </div>
  </div>

  <!-- Modal for Deposit -->
  <div class="modal-backdrop" id="depositModal">
    <div class="modal">
      <h2 id="depositModalTitle">Not enough coins</h2>
      <p id="depositModalDesc">You do not have enough coins to play. Please top up your balance.</p>
      <button class="close-modal" onclick="closeDepositModal()">Close</button>
    </div>
  </div>

  <!-- Подключаем скрипты игр и основной скрипт -->
  <script src="game1.js"></script>
  <script src="game2.js"></script>
  <script src="partnergame1.js"></script>
  <!-- Файл specialgame1.js удалён – Special Game теперь на отдельной странице -->
  <script src="game3.js"></script>
  <script src="game4.js"></script>
  <script src="game5.js"></script>
  <script src="game6.js"></script>
  <script src="case.js"></script>

  <script>
    /* ----------------------------------------------
       1. Translation Settings
    ---------------------------------------------- */
    let currentLanguage = 'en';
    const translations = {
      en: {
        pageTitle: "Mobile Games Site",
        languageButton: "rus",
        mainOnlineGames: "Main Online Games",
        miniGames: "Mini Games",
        partnerGames: "Partner Games",
        tickets: "Tickets",
        spinButton: "Spin",
        buyTickets: "Buy Tickets",
        leaderboard: "Leaderboard",
        referral: "Referral",
        copyLink: "Copy Link",
        info: "Info",
        play: "Play",
        moreDetails: "More Details",
        error: "Error",
        noUserData: "No user data available!",
        notEnoughTickets: "Not enough tickets",
        notEnoughTicketsMsg: "You do not have enough tickets to play!",
        wheelModalTitle: "Wheel of Fortune",
        wheelModalMsg: "Free spin available once every 24 hours!",
        youWon: "You won",
        ticketsPlural: "tickets",
        result: "Result",
        close: "Close",
        seasonInfoTitle: "Season Information",
        seasonInfoDesc: "Details about the season, prizes, deadlines, etc.",
        depositModalTitle: "Not enough coins",
        depositModalDesc: "You do not have enough coins to play. Please top up your balance.",
        copied: "Copied",
        copiedMsg: "Copied to clipboard!",
        inviteLink: "Invite your friends using the link and earn bonuses!",
        mainOnlineGamesInfo: "This section includes 2 main games: Dino Runner and Special Game.",
        miniGamesInfo: "Players participate in mini games, earning points for their activity. Every 3 days, top 10 players receive reward cases.",
        partnerGamesInfo: "Partner game from our partner.",
        // Game Cards
        gameCard1Title: "Online snake",
        gameCard1Button: "More Details",
        gameCard2Title: "Match-3",
        gameCard2Button: "More Details",
        gameCard3Title: "Game 3",
        gameCard3Button: "More Details",
        gameCard4Title: "Space Explorer",
        gameCard4Button: "More Details",
        gameCard5Title: "Partner Game",
        gameCard5Button: "More Details"
      },
      ru: {
        pageTitle: "Мобильные игры",
        languageButton: "Eng",
        mainOnlineGames: "Основные онлайн игры",
        miniGames: "Мини игры",
        partnerGames: "Партнерские игры",
        tickets: "Билеты",
        spinButton: "Крутить",
        buyTickets: "Купить билеты",
        leaderboard: "Таблица лидеров",
        referral: "Реферальная программа",
        copyLink: "Скопировать ссылку",
        info: "Инфо",
        play: "Играть",
        moreDetails: "Подробнее",
        error: "Ошибка",
        noUserData: "Данные пользователя недоступны!",
        notEnoughTickets: "Недостаточно билетов",
        notEnoughTicketsMsg: "У вас недостаточно билетов для игры!",
        wheelModalTitle: "Колесо фортуны",
        wheelModalMsg: "Бесплатный спин доступен раз в 24 часа!",
        youWon: "Вы выиграли",
        ticketsPlural: "билетов",
        result: "Результат",
        close: "Закрыть",
        seasonInfoTitle: "Информация о сезоне",
        seasonInfoDesc: "Детали о сезоне, призы, сроки и т.д.",
        depositModalTitle: "Недостаточно монет",
        depositModalDesc: "У вас недостаточно монет для игры. Пожалуйста, пополните баланс.",
        copied: "Скопировано",
        copiedMsg: "Ссылка скопирована в буфер обмена!",
        inviteLink: "Пригласите друзей по ссылке и зарабатывайте бонусы!",
        mainOnlineGamesInfo: "В этом разделе представлены 2 основные игры: Dino Runner и Special Game.",
        miniGamesInfo: "Игроки участвуют в мини играх, зарабатывая очки за активность. Каждые 3 дня топ-10 игроков получают кейсы с наградами.",
        partnerGamesInfo: "Партнерская игра от нашего партнёра.",
        // Game Cards
        gameCard1Title: "Онлайн змейка",
        gameCard1Button: "Подробнее",
        gameCard2Title: "Match-3",
        gameCard2Button: "Подробнее",
        gameCard3Title: "Игра 3",
        gameCard3Button: "Подробнее",
        gameCard4Title: "Космический исследователь",
        gameCard4Button: "Подробнее",
        gameCard5Title: "Партнерская игра",
        gameCard5Button: "Подробнее"
      }
    };

    function updateLanguage() {
      document.title = translations[currentLanguage].pageTitle;
      document.getElementById('languageSwitchBtn').textContent = translations[currentLanguage].languageButton;
      document.getElementById('ticketsHeader').textContent = translations[currentLanguage].tickets;
      document.getElementById('leaderboardHeader').textContent = translations[currentLanguage].leaderboard;
      document.getElementById('referralHeader').textContent = translations[currentLanguage].referral;
      document.getElementById('mainOnlineHeaderText').textContent = translations[currentLanguage].mainOnlineGames;
      document.getElementById('miniGamesHeaderText').textContent = translations[currentLanguage].miniGames;
      document.getElementById('partnerGamesHeaderText').textContent = translations[currentLanguage].partnerGames;
      if (!document.getElementById('spinButton').disabled) {
        document.getElementById('spinButton').textContent = translations[currentLanguage].spinButton;
      }
      document.getElementById('buyTicketsBtn').textContent = translations[currentLanguage].buyTickets;
      document.getElementById('copyInviteBtn').textContent = translations[currentLanguage].copyLink;
      
      // Обновление навигационных кнопок (alt-атрибуты)
      document.getElementById('navPlayAlt').alt = translations[currentLanguage].play;
      document.getElementById('navTicketsAlt').alt = translations[currentLanguage].tickets;
      document.getElementById('navLeaderboardAlt').alt = translations[currentLanguage].leaderboard;
      document.getElementById('navReferralAlt').alt = translations[currentLanguage].referral;
      
      // Обновление текстов игровых карточек
      document.getElementById('gameCard1Title').textContent = translations[currentLanguage].gameCard1Title;
      document.getElementById('gameCard1Button').textContent = translations[currentLanguage].gameCard1Button;
      document.getElementById('gameCard2Title').textContent = translations[currentLanguage].gameCard2Title;
      document.getElementById('gameCard2Button').textContent = translations[currentLanguage].gameCard2Button;
      document.getElementById('gameCard3Title').textContent = translations[currentLanguage].gameCard3Title;
      document.getElementById('gameCard3Button').textContent = translations[currentLanguage].gameCard3Button;
      document.getElementById('gameCard4Title').textContent = translations[currentLanguage].gameCard4Title;
      document.getElementById('gameCard4Button').textContent = translations[currentLanguage].gameCard4Button;
      document.getElementById('gameCard5Title').textContent = translations[currentLanguage].gameCard5Title;
      document.getElementById('gameCard5Button').textContent = translations[currentLanguage].gameCard5Button;
      
      // Обновление модальных окон
      document.getElementById('seasonModalTitle').textContent = translations[currentLanguage].seasonInfoTitle;
      document.getElementById('seasonModalDesc').textContent = translations[currentLanguage].seasonInfoDesc;
      document.getElementById('depositModalTitle').textContent = translations[currentLanguage].depositModalTitle;
      document.getElementById('depositModalDesc').textContent = translations[currentLanguage].depositModalDesc;
      document.getElementById('mainOnlineInfoTitle').textContent = translations[currentLanguage].mainOnlineGamesInfo;
      document.getElementById('mainOnlineInfoDesc').textContent = translations[currentLanguage].mainOnlineGamesInfo;
      document.getElementById('miniGamesInfoTitle').textContent = translations[currentLanguage].miniGamesInfo;
      document.getElementById('miniGamesInfoDesc').textContent = translations[currentLanguage].miniGamesInfo;
      document.getElementById('partnerInfoTitle').textContent = translations[currentLanguage].partnerGamesInfo;
      document.getElementById('partnerInfoDesc').textContent = translations[currentLanguage].partnerGamesInfo;
      document.getElementById('endgameTitle').textContent = translations[currentLanguage].result;
      
      // Обновление всех кнопок закрытия
      document.querySelectorAll('.close-modal').forEach(btn => {
        btn.textContent = translations[currentLanguage].close;
      });
    }

    function toggleLanguage() {
      currentLanguage = (currentLanguage === 'en') ? 'ru' : 'en';
      updateLanguage();
    }

    /* ----------------------------------------------
       2. Firebase Initialization
    ---------------------------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev3fJRDKmn64hLTJaWjVjpHQtMjhLg",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    /* ----------------------------------------------
       3. Telegram Web App
    ---------------------------------------------- */
    const tg = window.Telegram.WebApp;
    tg.expand();

    /* ----------------------------------------------
       4. Global Variables & User Data
    ---------------------------------------------- */
    let currentUser = null;
    let userRef = null;
    let localUserData = {
      photo: '',
      tickets: 0,
      coins: 0,
      points: 0,
      lastSpinTime: 0
    };
    let gameInProgress = false;

    if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
      document.getElementById('username').textContent = '@' + currentUser.username;
      if (currentUser.photo_url) {
        document.getElementById('userPhoto').src = currentUser.photo_url;
      }
      userRef = db.ref('users/' + currentUser.username);
      userRef.once('value', snapshot => {
        if (!snapshot.exists()) {
          userRef.set({
            photo: currentUser.photo_url || '',
            tickets: 0,
            coins: 0,
            points: 0,
            lastSpinTime: 0
          });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData = {
          photo: data.photo || '',
          tickets: data.tickets || 0,
          coins: data.coins || 0,
          points: data.points || 0,
          lastSpinTime: data.lastSpinTime || 0
        };
        updateTopBar();
        updateSpinButton();
      });
    }

    /* ----------------------------------------------
       5. Update Top Bar
    ---------------------------------------------- */
    function updateTopBar() {
      document.getElementById('ticketCount').textContent = localUserData.tickets || 0;
      document.getElementById('coinCount').textContent   = localUserData.coins || 0;
      document.getElementById('pointCount').textContent  = localUserData.points || 0;
    }

    /* ----------------------------------------------
       6. Section Switching
       Обновлённая функция: при переключении разделов закрываются все модальные окна и игровые оверлеи,
       чтобы основной контент не был перекрыт.
    ---------------------------------------------- */
    function showSection(sectionId) {
      // Скрываем все секции
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      // Закрываем все модальные окна и оверлеи
      document.querySelectorAll('.modal-backdrop').forEach(modal => modal.classList.remove('active'));
      document.getElementById('gameModalBackdrop').classList.remove('active');
      document.getElementById('endgameBackdrop').classList.remove('active');
      // Отображаем выбранную секцию
      document.getElementById(sectionId).classList.add('active');
    }

    /* ----------------------------------------------
       7. Global Modal
    ---------------------------------------------- */
    function showGlobalModal(title, message) {
      document.getElementById('globalModalTitle').textContent = title;
      document.getElementById('globalModalMessage').textContent = message;
      document.getElementById('globalModalBackdrop').classList.add('active');
    }
    function closeGlobalModal() {
      document.getElementById('globalModalBackdrop').classList.remove('active');
    }

    /* ----------------------------------------------
       8. Game Info Modal (Подробнее)
    ---------------------------------------------- */
    function openGameInfoModal(gameData) {
      document.getElementById('gameInfoImg').src = gameData.img;
      document.getElementById('gameInfoTitle').textContent = gameData.title;
      document.getElementById('gameInfoDesc').textContent = gameData.desc;
      const playBtn = document.getElementById('gameInfoPlayBtn');
      playBtn.textContent = translations[currentLanguage].play + ` (${gameData.cost} ticket)`;
      playBtn.onclick = function() {
        closeGameInfoModal();
        handleStartGame(gameData.gameId, gameData.cost);
      };
      document.getElementById('gameInfoModal').classList.add('active');
    }
    function closeGameInfoModal() {
      document.getElementById('gameInfoModal').classList.remove('active');
    }

    /* ----------------------------------------------
       9. Start Game
    ---------------------------------------------- */
    let currentGame = null;
    function handleStartGame(gameName, ticketCost) {
      document.querySelector('.user-info').style.display = 'none';
      if (!currentUser || !userRef) {
        showGlobalModal(translations[currentLanguage].error, translations[currentLanguage].noUserData);
        return;
      }
      if ((localUserData.tickets || 0) < ticketCost) {
        showGlobalModal(translations[currentLanguage].notEnoughTickets, translations[currentLanguage].notEnoughTicketsMsg);
        return;
      }
      localUserData.tickets -= ticketCost;
      updateTopBar();
      userRef.update({ tickets: localUserData.tickets });
      currentGame = gameName;
      gameInProgress = true;
      document.getElementById('mainNav').classList.add('hidden');

      document.getElementById('gameCanvas').style.display = 'none';
      document.getElementById('match3Canvas').style.display = 'none';
      document.getElementById('partnerGameCanvas').style.display = 'none';
      document.getElementById('game3Canvas').style.display = 'none';
      document.getElementById('game4Canvas').style.display = 'none';
      document.getElementById('game5Canvas').style.display = 'none';
      document.getElementById('game6Canvas').style.display = 'none';

      document.getElementById('gameModalBackdrop').classList.add('active');

      if (gameName === 'game1') {
        document.getElementById('gameCanvas').style.display = 'block';
        initGame1();
      } else if (gameName === 'game2') {
        document.getElementById('match3Canvas').style.display = 'block';
        initGame2();
      } else if (gameName === 'partnergame1') {
        document.getElementById('partnerGameCanvas').style.display = 'block';
        initPartnerGame1();
      } else if (gameName === 'game3') {
        document.getElementById('game3Canvas').style.display = 'block';
        initGame3();
      } else if (gameName === 'game4') {
        document.getElementById('game4Canvas').style.display = 'block';
        initGame4();
      } else if (gameName === 'game5') {
        document.getElementById('game5Canvas').style.display = 'block';
        initGame5();
      } else if (gameName === 'game6') {
        document.getElementById('game6Canvas').style.display = 'block';
        initGame6();
      }
    }

    /* ----------------------------------------------
       10. End Game Modal
    ---------------------------------------------- */
    function showEndGameModal(title, message) {
      document.getElementById('endgameTitle').textContent = title;
      document.getElementById('endgameMessage').textContent = message;
      document.getElementById('endgameBackdrop').classList.add('active');
    }
    function finishGame() {
      document.querySelector('.user-info').style.display = '';
      document.getElementById('endgameBackdrop').classList.remove('active');
      closeGameModal();
    }
    function closeGameModal() {
      document.getElementById('gameModalBackdrop').classList.remove('active');
      document.getElementById('mainNav').classList.remove('hidden');
      if (userRef && currentGame) {
        userRef.update({ points: localUserData.points });
      }
      if (currentGame === 'game1') {
        resetGame1();
      } else if (currentGame === 'game2') {
        resetGame2();
      } else if (currentGame === 'partnergame1') {
        resetPartnerGame1();
      } else if (currentGame === 'game3') {
        resetGame3();
      } else if (currentGame === 'game4') {
        resetGame4();
      } else if (currentGame === 'game5') {
        resetGame5();
      } else if (currentGame === 'game6') {
        resetGame6();
      }
      currentGame = null;
      gameInProgress = false;
    }

    /* ----------------------------------------------
       11. Wheel of Fortune / Tickets
    ---------------------------------------------- */
    let spinDuration = 4000;
    function spinWheel() {
      if (!currentUser) return;
      const now = Date.now();
      if (now - (localUserData.lastSpinTime || 0) < 24 * 60 * 60 * 1000) {
        showGlobalModal(translations[currentLanguage].wheelModalTitle, translations[currentLanguage].wheelModalMsg);
        return;
      }
      // Обновляем время последнего спина
      localUserData.lastSpinTime = now;
      userRef.update({ lastSpinTime: now });
      updateSpinButton();
      let randomRotation = 1080 + Math.floor(Math.random() * 360);
      const wheelEl = document.getElementById('wheel');
      wheelEl.style.transform = `rotate(${randomRotation}deg)`;
      setTimeout(() => {
        let finalDeg = randomRotation % 360;
        let wonTickets = 0;
        if (finalDeg < 60) {
          wonTickets = 5;
        } else if (finalDeg < 120) {
          wonTickets = 10;
        } else if (finalDeg < 180) {
          wonTickets = 15;
        } else if (finalDeg < 240) {
          wonTickets = 20;
        } else if (finalDeg < 300) {
          wonTickets = 25;
        } else {
          wonTickets = 30;
        }
        localUserData.tickets += wonTickets;
        updateTopBar();
        userRef.update({ tickets: localUserData.tickets });
        showSpinModal(wonTickets);
      }, spinDuration);
    }
    function showSpinModal(amount) {
      document.getElementById("wheelTicketCount").textContent = amount;
      document.getElementById("spinModalTitle").innerHTML = translations[currentLanguage].youWon + " <span id='wheelTicketCount'>" + amount + "</span> " + translations[currentLanguage].ticketsPlural + "!";
      document.getElementById("spinModalBackdrop").classList.add("active");
    }
    function closeSpinModal() {
      document.getElementById("spinModalBackdrop").classList.remove("active");
    }
    // Обновление кнопки спина с обратным отсчетом
    function updateSpinButton() {
      const btn = document.getElementById('spinButton');
      const now = Date.now();
      const last = localUserData.lastSpinTime || 0;
      const diff = now - last;
      const wait = 24 * 60 * 60 * 1000 - diff;
      if(wait <= 0) {
         btn.textContent = translations[currentLanguage].spinButton;
         btn.disabled = false;
      } else {
         const seconds = Math.floor(wait / 1000) % 60;
         const minutes = Math.floor(wait / (1000 * 60)) % 60;
         const hours = Math.floor(wait / (1000 * 60 * 60));
         btn.textContent = `${translations[currentLanguage].spinButton} (${hours.toString().padStart(2,'0')}:${minutes.toString().padStart(2,'0')}:${seconds.toString().padStart(2,'0')})`;
         btn.disabled = true;
      }
    }
    setInterval(updateSpinButton, 1000);

    /* ----------------------------------------------
       12. Leaderboard (Показываем всех пользователей)
    ---------------------------------------------- */
    let leaderboardRef = db.ref('users');
    leaderboardRef.on('value', snapshot => {
      const usersData = snapshot.val() || {};
      const usersArray = Object.entries(usersData).map(([uname, obj]) => ({
        username: uname,
        points: obj.points || 0
      }));
      usersArray.sort((a, b) => b.points - a.points);
      const tbody = document.getElementById('leaderboardBody');
      tbody.innerHTML = '';
      usersArray.forEach((user, i) => {
        const tr = document.createElement('tr');
        if (currentUser && user.username === currentUser.username) {
          tr.classList.add('current-user');
        }
        tr.innerHTML = `
          <td>${i + 1}</td>
          <td>@${user.username}</td>
          <td>${user.points}</td>
        `;
        tbody.appendChild(tr);
      });
    });

    function openSeasonInfoModal() {
      document.getElementById('seasonModalBackdrop').classList.add('active');
    }
    function closeSeasonModal() {
      document.getElementById('seasonModalBackdrop').classList.remove('active');
    }

    /* ----------------------------------------------
       13. Referral
    ---------------------------------------------- */
    function copyReferralLink() {
      const link = document.getElementById('referralLink').textContent;
      navigator.clipboard.writeText(link).then(() => {
        showGlobalModal(translations[currentLanguage].copied, translations[currentLanguage].copiedMsg);
      });
    }

    /* ----------------------------------------------
       14. Buy Tickets
       Изменено: при нажатии происходит переход на buyticket.html
    ---------------------------------------------- */
    function buyTickets() {
      window.location.href = 'buyticket.html';
    }

    /* ----------------------------------------------
       15. Копирование ссылки приглашения
    ---------------------------------------------- */
    function copyInviteLink() {
      const link = window.location.href;
      navigator.clipboard.writeText(link).then(() => {
        showGlobalModal(translations[currentLanguage].copied, translations[currentLanguage].copiedMsg);
      });
    }

    // Инициализация языка при загрузке страницы
    updateLanguage();

    function openMainOnlineInfoModal() {
      document.getElementById('mainOnlineInfoModal').classList.add('active');
    }

    function closeMainOnlineInfoModal() {
      document.getElementById('mainOnlineInfoModal').classList.remove('active');
    }

    function openMiniGamesInfoModal() {
      document.getElementById('miniGamesInfoModal').classList.add('active');
    }

    function closeMiniGamesInfoModal() {
      document.getElementById('miniGamesInfoModal').classList.remove('active');
    }

    function openPartnerInfoModal() {
      document.getElementById('partnerInfoModal').classList.add('active');
    }

    function closePartnerInfoModal() {
      document.getElementById('partnerInfoModal').classList.remove('active');
    }
  </script>
</body>
</html>
