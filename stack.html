<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Для мобильных устройств -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stack Game</title>
  
  <!-- Font: Comfortaa & Press Start 2P -->
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Comfortaa&family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <!-- Three.js и TweenLite (GSAP) для Stack Game -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenLite.min.js"></script>
  
  <!-- Стили Stack Game (можно подключить внешний файл, здесь приведён инлайн вариант для примера) -->
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      height: 100%;
      width: 100%;
      position: relative;
      font-family: "Comfortaa", cursive;
      background: #00103c;
    }
    /* Header с информацией */
    #header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: #6d4fba;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #info {
      display: flex;
      gap: 20px;
      font-size: 10px;
      color: #fff;
      align-items: center;
    }
    #info span {
      white-space: nowrap;
    }
    .balance {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .balance img {
      width: 16px;
      height: 16px;
    }
    /* Кнопка Back */
    #backContainer {
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 1000;
    }
    #backBtn {
      font-size: 10px;
      padding: 5px 10px;
      background: #06B6D1;
      color: #262626;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }
    /* Модальное окно (для Game Over и при отсутствии билетов) */
    #end {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      z-index: 1200;
      background: rgba(0,0,0,0.7);
    }
    #end .modal {
      background: #222;
      border: 2px solid #0f0;
      border-radius: 8px;
      padding: 20px;
      width: 80%;
      max-width: 400px;
      text-align: center;
      color: #FF00FF;
      font-size: 14px;
    }
    #end .modal button {
      margin-top: 10px;
      font-size: 12px;
      padding: 6px 12px;
      background: #06B6D1;
      color: #262626;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }
    /* Контейнер Stack Game (изначально скрыт до старта) */
    #container {
      width: 100%;
      height: 100%;
      display: none;
      position: relative;
      z-index: 1;
    }
    /* Стили для Stack Game (копия вашего stack.css, можно доработать) */
    #game {
      position: absolute;
      top: 0;
      right: 0;
      bottom: 0;
      left: 0;
    }
    #score {
      position: absolute;
      top: 20px;
      width: 100%;
      text-align: center;
      font-size: 10vh;
      transition: transform 0.5s ease;
      color: #333344;
      transform: translateY(-200px) scale(1);
    }
    #instructions {
      position: absolute;
      width: 100%;
      top: 16vh;
      left: 0;
      text-align: center;
      transition: opacity 0.5s ease, transform 0.5s ease;
      opacity: 0;
    }
    .game-over {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 85%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .game-over * {
      transition: opacity 0.5s ease, transform 0.5s ease;
      opacity: 0;
      transform: translateY(-50px);
      color: #333344;
    }
    .game-over h2 {
      margin: 0;
      padding: 0;
      font-size: 40px;
    }
    .game-ready {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-around;
    }
    .game-ready #start-button {
      display: none; /* скроем встроенную кнопку Stack Game */
    }
    /* Наш интегрированный startBtn */
    #startBtn {
      position: absolute;
      z-index: 1100;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 30px;
      padding: 10px 20px;
      background: #06B6D1;
      color: #262626;
      border: 3px solid #333344;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
      display: block;
    }
  </style>
</head>
<body>
  <!-- Header с информацией о пользователе -->
  <div id="header">
    <div id="info">
      <span id="username">@User</span>
      <div class="balance">
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="Ticket">
        <span id="ticketCount">0</span>
      </div>
      <div class="balance">
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/star.png" alt="Points">
        <span id="pointCount">0</span>
      </div>
    </div>
  </div>

  <!-- Кнопка Back -->
  <div id="backContainer">
    <button id="backBtn" onclick="goBack()">Back</button>
  </div>

  <!-- Интегрированная кнопка Start (появляется до старта игры) -->
  <div id="gameWrapper">
    <button id="startBtn">Start (1 Ticket)</button>
  </div>

  <!-- Контейнер Stack Game -->
  <div id="container">
    <div id="game"></div>
    <div id="score">0</div>
    <div id="instructions">Click (or press the spacebar) to place the block</div>
    <div class="game-over">
      <h2>Game Over</h2>
      <p>You did great, you're the best.</p>
      <p>Click or spacebar to start again</p>
    </div>
    <div class="game-ready">
      <div id="start-button">Start</div>
      <div></div>
    </div>
  </div>

  <!-- Модальное окно для окончания игры/уведомлений -->
  <div id="end">
    <div class="modal">
      <h2 id="endTitle"></h2>
      <p id="endMessage"></p>
      <button id="endBtn">OK</button>
    </div>
  </div>

  <!-- Звуки -->
  <audio id="bgSound" src="background.mp3" loop></audio>
  <audio id="moveSound" src="move.mp3"></audio>
  <audio id="deathSound" src="death.mp3"></audio>

  <!-- Stack Game скрипты -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenLite.min.js"></script>
  <script src="stack.js"></script>
  
  <!-- Интеграция с Firebase и управление игрой -->
  <script>
    "use strict";
    /* ----------------------------------------
       1. Firebase и Telegram инициализация
    ---------------------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev-ex",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let tg = null;
    if (window.Telegram && window.Telegram.WebApp) {
      tg = window.Telegram.WebApp;
      tg.expand();
    }

    let currentUser = null;
    let userRef = null;
    let localUserData = { tickets: 0, points: 0 };
    // Флаг, что данные загружены
    let dataLoaded = false;
    // Если данные не загрузились за 3 секунды, dataLoaded станет true
    setTimeout(() => { dataLoaded = true; }, 3000);

    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
      document.getElementById('username').textContent = '@' + currentUser.username;
      userRef = db.ref('users/' + currentUser.username);
      userRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          userRef.set({ tickets: 5, points: 0 });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData.tickets = data.tickets || 0;
        localUserData.points = data.points || 0;
        updateHeader();
        dataLoaded = true;
      });
    } else {
      currentUser = { username: 'TestUser' };
      document.getElementById('username').textContent = '@TestUser';
      userRef = db.ref('users/TestUser');
      userRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          userRef.set({ tickets: 5, points: 0 });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData.tickets = data.tickets || 0;
        localUserData.points = data.points || 0;
        updateHeader();
        dataLoaded = true;
      });
    }

    function updateHeader() {
      document.getElementById('ticketCount').textContent = localUserData.tickets;
      document.getElementById('pointCount').textContent = localUserData.points;
    }

    function goBack() {
      window.location.href = 'index.html';
    }
    // Для модального окна: если modalType = "gameOver", OK перенаправляет; если "noTickets", скрывает модал
    let modalType = "gameOver";
    document.getElementById('endBtn').addEventListener('click', function() {
      if (modalType === "gameOver") {
        goToIndex();
      } else if (modalType === "noTickets") {
        document.getElementById('end').style.visibility = 'hidden';
      }
    });
    function goToIndex() {
      window.location.href = 'index.html';
    }

    /* ----------------------------------------
       2. Интеграция Stack Game
    ---------------------------------------- */
    // Предполагается, что в stack.js создается глобальный объект game (new Game())
    // Через setTimeout ждём загрузки stack.js (примерно 1 секунда), затем переопределяем встроенную кнопку старта
    setTimeout(() => {
      // Скрываем встроенную кнопку старта Stack Game
      let builtInStart = document.getElementById("start-button");
      if (builtInStart) {
        builtInStart.style.display = "none";
      }
      // Наша интегрированная кнопка (с id="startBtn") уже видна в #gameWrapper
      document.getElementById("startBtn").addEventListener("click", () => {
        // Если данные не загружены или билетов недостаточно, показываем модальное окно
        if (!dataLoaded || localUserData.tickets < 1) {
          modalType = "noTickets";
          document.getElementById('endTitle').textContent = 'Not enough tickets!';
          document.getElementById('endMessage').textContent = 'Please come back later.';
          document.getElementById('end').style.visibility = 'visible';
          return;
        }
        // Вычитаем билет
        localUserData.tickets--;
        if (userRef) userRef.update({ tickets: localUserData.tickets });
        updateHeader();
        // Скрываем меню (header, back, стартовая кнопка)
        document.getElementById('header').style.display = 'none';
        document.getElementById('backContainer').style.display = 'none';
        document.getElementById('startBtn').style.display = 'none';
        // Показываем контейнер игры и контролы (если они используются в Stack Game, можно их оставить скрытыми, так как Stack Game управляется по клику/пробел)
        document.getElementById('container').style.display = 'block';
        // Если в Stack Game предусмотрен метод startGame, вызываем его:
        if (game && game.startGame) {
          game.startGame();
        }
      });
      // Переопределяем метод endGame глобального объекта game, чтобы добавить обновление баланса
      if (game) {
        let originalEndGame = game.endGame;
        game.endGame = function() {
          originalEndGame.apply(game);
          // Получаем очки из элемента #score (предполагается, что они обновляются в Stack Game)
          let scoreValue = parseInt(document.getElementById("score").innerHTML) || 0;
          localUserData.points += scoreValue;
          if (userRef) userRef.update({ points: localUserData.points });
          modalType = "gameOver";
          document.getElementById('endTitle').textContent = 'Game Over!';
          document.getElementById('endMessage').textContent = 'Your score: ' + scoreValue;
          document.getElementById('end').style.visibility = 'visible';
        };
      }
    }, 1000);
  </script>
</body>
</html>
