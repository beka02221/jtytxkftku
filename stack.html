<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pure CSS Stack с меню, таймером и баллами</title>

  <!-- Font: Press Start 2P -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* Общие стили для интеграции */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #00103c;
      font-family: 'Press Start 2P', monospace;
    }
    /* Header с информацией о пользователе */
    #header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: #6d4fba;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #info {
      display: flex;
      gap: 20px;
      font-size: 10px;
      color: #fff;
      align-items: center;
    }
    #info span {
      white-space: nowrap;
    }
    .balance {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .balance img {
      width: 16px;
      height: 16px;
    }
    /* Кнопка Back */
    #backContainer {
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 1000;
    }
    #backBtn {
      font-size: 10px;
      padding: 5px 10px;
      background: #06B6D1;
      color: #262626;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }
    /* Меню игры */
    #gameWrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }
    /* Кнопка Start – по центру меню */
    #startBtn {
      position: absolute;
      z-index: 1100;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      padding: 10px 20px;
      background: #06B6D1;
      color: #262626;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }
    /* Временной индикатор – появляется только после старта игры */
    #timeBarContainer {
      position: absolute;
      top: 20px; /* поднят выше */
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 5px;
      background: #555;
      z-index: 1100;
      display: none;
    }
    #timeBar {
      width: 100%;
      height: 100%;
      background: #ff66cc; /* розовый */
    }
    /* Игровой счётчик */
    #counter {
      position: absolute;
      top: 40px; /* ниже тайм-бара */
      right: 20px;
      z-index: 1000;
    }
    /* Модальное окно */
    #end {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      z-index: 1200;
      background: rgba(0,0,0,0.7);
    }
    #end .modal {
      background: #222;
      border: 2px solid #0f0;
      border-radius: 8px;
      padding: 20px;
      width: 80%;
      max-width: 400px;
      text-align: center;
      color: #FF00FF;
      font-size: 14px;
    }
    #end .modal button {
      margin-top: 10px;
      font-size: 12px;
      padding: 6px 12px;
      background: #06B6D1;
      color: #262626;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }

    /* ==================== PURE CSS STACK GAME СТИЛИ ==================== */
    /* Эти стили взяты из вашего примера игры */
    body {
      margin: 0;
      background-color: black;
      counter-reset: points;
    }
    .screen {
      position: relative;
      margin: 0 auto;
      max-width: 100vw;
      width: 75vh;
      height: 100vh;
      overflow: hidden;
    }
    /* Sky */
    .sky {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      pointer-events: none;
    }
    .sky > div {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
    }
    .sky > div::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      display: block;
      height: 1000vh;
    }
    .sky > div + div {
      animation: opacity 30s linear infinite forwards paused;
    }
    .sky > div::before {
      background: linear-gradient(
        #f12711,
        #f5af19 10%,
        #91eae4 11%,
        #86a8e7,
        #7f7fd5 21%,
        #f64f59 22%,
        #c471ed,
        #12c2e9 32%,
        #f7797d 33%,
        #fbd786,
        #c6ffdd 43%,
        #8a2387 44%,
        #e94057,
        #f27121 54%,
        #3a1c71 55%,
        #d76d77,
        #fdbb2d 65%,
        #22c1c3 66%,
        #fdbb2d 76%,
        #1a2a6c 77%,
        #b21f1f,
        #fdbb2d 87%
      );
      animation: sky 240s steps(8, end) infinite forwards paused;
    }
    .sky > div + div::before {
      background: linear-gradient(
        #ff0080,
        #ff8c00,
        #40e0d0 10%,
        #1d2671 11%,
        #c33764 21%,
        #78ffd6 22%,
        #a8ff78 32%,
        #4b1248 33%,
        #f0c27b 43%,
        #2980b9 44%,
        #6dd5fa,
        #fff 54%,
        #03001e 55%,
        #7303c0,
        #ec38bc,
        #fdeff9 65%,
        #56ccf2 66%,
        #2f80ed 76%,
        #0c0510 77%,
        #160b3e,
        #5f4282,
        #cecc99 87%
      );
      animation: sky 240s steps(8, end) -15s infinite forwards paused;
    }
    /* Обратите внимание, что ниже изменены id игровых чекбоксов, чтобы не конфликтовать с модальным окном */
    <style>
      input,
      .last {
        z-index: 1;
        position: absolute;
        display: none;
        width: 300vh;
        height: 300vh;
        opacity: 0;
        cursor: pointer;
        pointer-events: auto;
        transform: translate(-150vh, -150vh);
        -webkit-touch-callout: none;
        -webkit-tap-highlight-color: transparent;
      }
      /* Изменяем id: start → gameStart, end → gameEnd, last → gameLast */
    </style>
  </style>
</head>
<body>
  <!-- Header и меню -->
  <div id="header">
    <div id="info">
      <span id="username">@User</span>
      <div class="balance">
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="Ticket">
        <span id="ticketCount">0</span>
      </div>
      <div class="balance">
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/star.png" alt="Points">
        <span id="pointCount">0</span>
      </div>
    </div>
  </div>
  <!-- Временной индикатор (скрыт до старта) -->
  <div id="timeBarContainer">
    <div id="timeBar"></div>
  </div>
  <!-- Кнопка Back -->
  <div id="backContainer">
    <button id="backBtn" onclick="goBack()">Back</button>
  </div>
  <!-- Меню игры -->
  <div id="gameWrapper">
    <button id="startBtn" onclick="startGame()">Start (1 Ticket)</button>
    <!-- Здесь размещается игра (PURE CSS STACK) -->
    <form class="screen" novalidate>
      <!-- Переименованные игровые чекбоксы -->
      <input id="gameStart" type="checkbox" tabindex="-1">
      <input id="gameEnd" type="checkbox" tabindex="-1">
      <input id="gameLast" type="checkbox" tabindex="-1">
      <div class="sky">
        <div></div>
        <div></div>
      </div>
      <div class="base">
        <input type="checkbox" tabindex="-1" required>
        <div class="container horizontal">
          <div class="block floating horizontal"></div>
          <div class="block horizontal">
            <input type="checkbox" tabindex="-1">
            <div class="container vertical">
              <div class="block floating vertical"></div>
              <div class="block vertical">
                <input type="checkbox" tabindex="-1">
                <div class="container horizontal">
                  <div class="block floating horizontal"></div>
                  <div class="block horizontal">
                    <input type="checkbox" tabindex="-1">
                    <div class="container vertical">
                      <div class="block floating vertical"></div>
                      <div class="block vertical">
                        <input type="checkbox" tabindex="-1">
                        <div class="container horizontal">
                          <div class="block floating horizontal"></div>
                          <div class="block horizontal">
                            <input type="checkbox" tabindex="-1">
                            <div class="container vertical">
                              <div class="block floating vertical"></div>
                              <div class="block vertical">
                                <input type="checkbox" tabindex="-1">
                                <div class="container horizontal">
                                  <div class="block floating horizontal"></div>
                                  <div class="block horizontal">
                                    <input type="checkbox" tabindex="-1">
                                    <div class="container vertical">
                                      <div class="block floating vertical"></div>
                                      <div class="block vertical">
                                        <input type="checkbox" tabindex="-1">
                                        <div class="container horizontal">
                                          <div class="block floating horizontal"></div>
                                          <div class="block horizontal">
                                            <input type="checkbox" tabindex="-1">
                                            <div class="container vertical">
                                              <div class="block floating vertical"></div>
                                              <div class="block vertical">
                                                <input type="checkbox" tabindex="-1">
                                                <div class="container horizontal">
                                                  <div class="block floating horizontal"></div>
                                                  <div class="block horizontal">
                                                    <input type="checkbox" tabindex="-1">
                                                    <div class="container vertical">
                                                      <div class="block floating vertical"></div>
                                                      <div class="block vertical">
                                                        <input type="checkbox" tabindex="-1">
                                                        <div class="container horizontal">
                                                          <div class="block floating horizontal"></div>
                                                          <div class="block horizontal">
                                                            <input type="checkbox" tabindex="-1">
                                                            <div class="container vertical">
                                                              <div class="block floating vertical"></div>
                                                              <div class="block vertical">
                                                                <input type="checkbox" tabindex="-1">
                                                                <div class="container horizontal">
                                                                  <div class="block floating horizontal"></div>
                                                                  <div class="block horizontal">
                                                                    <input type="checkbox" tabindex="-1">
                                                                    <div class="container vertical">
                                                                      <div class="block floating vertical"></div>
                                                                      <div class="block vertical">
                                                                        <input type="checkbox" tabindex="-1">
                                                                        <div class="container horizontal">
                                                                          <div class="block floating horizontal"></div>
                                                                          <div class="block horizontal">
                                                                            <input type="checkbox" tabindex="-1">
                                                                            <div class="container vertical">
                                                                              <div class="block floating vertical"></div>
                                                                              <div class="block vertical">
                                                                                <input type="checkbox" tabindex="-1">
                                                                                <div class="container horizontal">
                                                                                  <div class="block floating horizontal"></div>
                                                                                  <div class="block horizontal">
                                                                                    <input type="checkbox" tabindex="-1">
                                                                                    <div class="container vertical">
                                                                                      <div class="block floating vertical"></div>
                                                                                      <div class="block vertical">
                                                                                        <input type="checkbox" tabindex="-1">
                                                                                        <div class="container horizontal">
                                                                                          <div class="block floating horizontal"></div>
                                                                                          <div class="block horizontal">
                                                                                            <input type="checkbox" tabindex="-1">
                                                                                            <div class="container vertical">
                                                                                              <div class="block floating vertical"></div>
                                                                                              <div class="block vertical">
                                                                                                <input type="checkbox" tabindex="-1">
                                                                                                <div class="container horizontal">
                                                                                                  <div class="block floating horizontal"></div>
                                                                                                  <div class="block horizontal">
                                                                                                    <input type="checkbox" tabindex="-1">
                                                                                                    <div class="container vertical">
                                                                                                      <div class="block floating vertical"></div>
                                                                                                      <div class="block vertical">
                                                                                                        <input type="checkbox" tabindex="-1">
                                                                                                        <div class="container horizontal">
                                                                                                          <div class="block floating horizontal"></div>
                                                                                                          <div class="block horizontal">
                                                                                                            <input type="checkbox" tabindex="-1">
                                                                                                            <div class="container vertical">
                                                                                                              <div class="block floating vertical"></div>
                                                                                                              <div class="block vertical">
                                                                                                                <input type="checkbox" tabindex="-1">
                                                                                                                <div class="container horizontal">
                                                                                                                  <div class="block floating horizontal"></div>
                                                                                                                  <div class="block horizontal">
                                                                                                                    <input type="checkbox" tabindex="-1">
                                                                                                                    <div class="container vertical">
                                                                                                                      <div class="block floating vertical"></div>
                                                                                                                      <div class="block vertical">
                                                                                                                        <input type="checkbox" tabindex="-1">
                                                                                                                        <div class="container horizontal">
                                                                                                                          <div class="block floating horizontal"></div>
                                                                                                                          <div class="block horizontal">
                                                                                                                            <input type="checkbox" tabindex="-1">
                                                                                                                            <div class="container vertical">
                                                                                                                              <div class="block floating vertical"></div>
                                                                                                                              <div class="block vertical">
                                                                                                                                <input type="checkbox" tabindex="-1">
                                                                                                                                <div class="container horizontal">
                                                                                                                                  <div class="block floating horizontal"></div>
                                                                                                                                  <div class="block horizontal">
                                                                                                                                    <input type="checkbox" tabindex="-1">
                                                                                                                                    <div class="container vertical">
                                                                                                                                      <div class="block floating vertical"></div>
                                                                                                                                      <div class="block vertical">
                                                                                                                                        <input type="checkbox" tabindex="-1">
                                                                                                                                        <div class="container horizontal">
                                                                                                                                          <div class="block floating horizontal"></div>
                                                                                                                                          <div class="block horizontal">
                                                                                                                                            <label class="last" for="gameLast" tabindex="-1"></label>
                                                                                                                                            <div class="container vertical">
                                                                                                                                              <div class="block floating vertical"></div>
                                                                                                                                              <div class="block vertical">
                                                                                                                                                <label class="end horizontal" for="gameEnd"></label>
                                                                                                                                                <label class="end vertical" for="gameEnd"></label>
                                                                                                                                              </div>
                                                                                                                                            </div>
                                                                                                                                          </div>
                                                                                                                                        </div>
                                                                                                                                      </div>
                                                                                                                                    </div>
                                                                                                                                  </div>
                                                                                                                                </div>
                                                                                                                              </div>
                                                                                                                            </div>
                                                                                                                          </div>
                                                                                                                        </div>
                                                                                                                      </div>
                                                                                                                    </div>
                                                                                                                  </div>
                                                                                                                </div>
                                                                                                              </div>
                                                                                                            </div>
                                                                                                          </div>
                                                                                                        </div>
                                                                                                      </div>
                                                                                                    </div>
                                                                                                  </div>
                                                                                                </div>
                                                                                              </div>
                                                                                            </div>
                                                                                          </div>
                                                                                        </div>
                                                                                      </div>
                                                                                    </div>
                                                                                  </div>
                                                                                </div>
                                                                              </div>
                                                                            </div>
                                                                          </div>
                                                                        </div>
                                                                      </div>
                                                                    </div>
                                                                  </div>
                                                                </div>
                                                              </div>
                                                            </div>
                                                          </div>
                                                        </div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>
    <!-- Конец кода игры -->
  </div>

  <!-- Модальное окно для окончания игры/уведомлений -->
  <div id="end">
    <div class="modal">
      <h2 id="endTitle"></h2>
      <p id="endMessage"></p>
      <button id="endBtn">OK</button>
    </div>
  </div>

  <!-- Звуки -->
  <audio id="bgSound" src="background.mp3" loop></audio>
  <audio id="moveSound" src="move.mp3"></audio>
  <audio id="deathSound" src="death.mp3"></audio>

  <script>
    /* ----------------------------------------
       1. Firebase и Telegram инициализация
    ---------------------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev-ex",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let tg = null;
    if (window.Telegram && window.Telegram.WebApp) {
      tg = window.Telegram.WebApp;
      tg.expand();
    }

    let currentUser = null;
    let userRef = null;
    let localUserData = { tickets: 0, points: 0 };
    // Флаг, что данные загружены (ожидаем примерно 3 секунды)
    let dataLoaded = false;
    setTimeout(() => { dataLoaded = true; }, 3000);

    let modalType = "gameOver"; // "gameOver" или "noTickets"

    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
      document.getElementById('username').textContent = '@' + currentUser.username;
      userRef = db.ref('users/' + currentUser.username);
      userRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          userRef.set({ tickets: 5, points: 0 });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData.tickets = data.tickets || 0;
        localUserData.points = data.points || 0;
        updateHeader();
        dataLoaded = true;
      });
    } else {
      currentUser = { username: 'TestUser' };
      document.getElementById('username').textContent = '@TestUser';
      userRef = db.ref('users/TestUser');
      userRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          userRef.set({ tickets: 5, points: 0 });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData.tickets = data.tickets || 0;
        localUserData.points = data.points || 0;
        updateHeader();
        dataLoaded = true;
      });
    }

    function updateHeader() {
      document.getElementById('ticketCount').textContent = localUserData.tickets;
      document.getElementById('pointCount').textContent = localUserData.points;
    }

    function goBack() {
      window.location.href = 'index.html';
    }
    function goToIndex() {
      window.location.href = 'index.html';
    }
    document.getElementById('endBtn').addEventListener('click', function() {
      if (modalType === "gameOver") {
        goToIndex();
      } else if (modalType === "noTickets") {
        document.getElementById('end').style.visibility = 'hidden';
      }
    });

    /* ----------------------------------------
       2. Игровой код – логика завершения Pure CSS STACK
          Мы будем считать очки как количество отмеченных (checked) input внутри формы .screen.
    ---------------------------------------- */
    let gameStartTime = null;
    const gameDuration = 300000; // 5 минут
    let gameEnded = false;

    // Функция подсчёта очков: количество поставленных кубов (отмеченных input)
    function getScore() {
      // Получаем все input внутри .screen, исключая те, что используются для управления (gameStart, gameEnd, gameLast)
      const inputs = document.querySelectorAll('.screen input[type="checkbox"]');
      let score = 0;
      inputs.forEach(input => {
        // Если id не равен gameStart, gameEnd, gameLast, считаем как куб (при условии, что он отмечен)
        if (input.id !== 'gameStart' && input.id !== 'gameEnd' && input.id !== 'gameLast') {
          if (input.checked) score++;
        }
      });
      return score;
    }

    // Функция завершения игры – вызывается либо по истечении времени, либо при срабатывании состояния проигрыша
    function endGame(timestamp) {
      if (gameEnded) return;
      gameEnded = true;
      document.getElementById('deathSound').play().catch(err => console.log(err));
      const score = getScore();
      localUserData.points += score;
      if (userRef) userRef.update({ points: localUserData.points });
      modalType = "gameOver";
      document.getElementById('endTitle').textContent = 'Game Over!';
      document.getElementById('endMessage').textContent = 'Your score: ' + score;
      document.getElementById('end').style.visibility = 'visible';
    }

    // Если билетов нет или данные не загружены – показываем модальное окно
    function showNoTicketsModal() {
      modalType = "noTickets";
      document.getElementById('endTitle').textContent = 'Not enough tickets!';
      document.getElementById('endMessage').textContent = 'Please come back later.';
      document.getElementById('end').style.visibility = 'visible';
    }

    /* ----------------------------------------
       3. Таймер игры
    ---------------------------------------- */
    function updateTimer(timestamp) {
      if (gameStartTime) {
        let elapsed = timestamp - gameStartTime;
        let remaining = gameDuration - elapsed;
        let timeBar = document.getElementById('timeBar');
        if (remaining <= 0) {
          timeBar.style.width = "0%";
          if (!gameEnded) {
            endGame(timestamp);
          }
        } else {
          timeBar.style.width = (remaining / gameDuration * 100) + "%";
        }
      }
    }

    /* ----------------------------------------
       4. Главный игровой цикл (только таймер)
    ---------------------------------------- */
    let previousTimestamp = null;
    function animate(timestamp) {
      requestAnimationFrame(animate);
      if (!previousTimestamp) previousTimestamp = timestamp;
      updateTimer(timestamp);
      previousTimestamp = timestamp;
    }
    requestAnimationFrame(animate);

    /* ----------------------------------------
       5. Функция старта игры
    ---------------------------------------- */
    document.body.addEventListener('click', () => {
      const bgSound = document.getElementById('bgSound');
      if (bgSound.paused) {
        bgSound.play().catch(err => console.log(err));
      }
    }, { once: true });

    function startGame() {
      // Если данные ещё не загружены или билетов недостаточно – показываем модальное окно
      if (!dataLoaded || localUserData.tickets < 1) {
        showNoTicketsModal();
        return;
      }
      localUserData.tickets--;
      if (userRef) userRef.update({ tickets: localUserData.tickets });
      updateHeader();
      // Скрываем меню (header, back, startBtn)
      document.getElementById('header').style.display = 'none';
      document.getElementById('backContainer').style.display = 'none';
      document.getElementById('startBtn').style.display = 'none';
      // Показываем область игры и таймер
      document.getElementById('gameWrapper').style.display = 'block';
      document.getElementById('timeBarContainer').style.display = 'block';
      // Устанавливаем время старта игры для таймера
      gameStartTime = performance.now();
    }
  </script>
</body>
</html>

