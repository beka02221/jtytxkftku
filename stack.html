<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <!-- Для мобильных устройств -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pure CSS STACK с меню и таймером</title>
  
  <!-- Font: Press Start 2P -->
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  
  <!-- Telegram Web App API -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <style>
    /* Общие стили интерфейса */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #00103c;
      font-family: 'Press Start 2P', monospace;
    }
    /* Header с информацией о пользователе */
    #header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 50px;
      background: #6d4fba;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #info {
      display: flex;
      gap: 20px;
      font-size: 10px;
      color: #fff;
      align-items: center;
    }
    #info span {
      white-space: nowrap;
    }
    .balance {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .balance img {
      width: 16px;
      height: 16px;
    }
    /* Кнопка Back */
    #backContainer {
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 1000;
    }
    #backBtn {
      font-size: 10px;
      padding: 5px 10px;
      background: #06B6D1;
      color: #262626;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }
    /* Меню игры – изначально видимо */
    #gameWrapper {
      position: relative;
      width: 100%;
      height: 100%;
    }
    /* Кнопка Start – по центру меню */
    #startBtn {
      position: absolute;
      z-index: 1100;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      padding: 10px 20px;
      background: #06B6D1;
      color: #262626;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }
    /* Временной индикатор – появляется после старта игры */
    #timeBarContainer {
      position: absolute;
      top: 20px; /* поднят выше */
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      height: 5px;
      background: #555;
      z-index: 1100;
      display: none;
    }
    #timeBar {
      width: 100%;
      height: 100%;
      background: #ff66cc;
    }
    /* Игровой счётчик */
    #counter {
      position: absolute;
      top: 40px; /* ниже time bar */
      right: 20px;
      z-index: 1000;
    }
    /* Модальное окно для окончания игры/уведомлений */
    #end {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      z-index: 1200;
      background: rgba(0,0,0,0.7);
    }
    #end .modal {
      background: #222;
      border: 2px solid #0f0;
      border-radius: 8px;
      padding: 20px;
      width: 80%;
      max-width: 400px;
      text-align: center;
      color: #FF00FF;
      font-size: 14px;
    }
    #end .modal button {
      margin-top: 10px;
      font-size: 12px;
      padding: 6px 12px;
      background: #06B6D1;
      color: #262626;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }
    /* Если используется canvas – он ниже (здесь не используется) */
    canvas {
      position: absolute;
      z-index: 1;
    }
    /* ------------------ Стили Pure CSS STACK игры ------------------ */
    .screen {
      position: relative;
      margin: 0 auto;
      max-width: 100vw;
      width: 75vh;
      height: 100vh;
      overflow: hidden;
    }
    .sky {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      pointer-events: none;
    }
    .sky > div {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
    }
    .sky > div::before {
      content: "";
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      display: block;
      height: 1000vh;
    }
    .sky > div + div {
      animation: opacity 30s linear infinite forwards;
    }
    .sky > div::before {
      background: linear-gradient(
        #f12711,
        #f5af19 10%,
        #91eae4 11%,
        #86a8e7,
        #7f7fd5 21%,
        #f64f59 22%,
        #c471ed,
        #12c2e9 32%,
        #f7797d 33%,
        #fbd786,
        #c6ffdd 43%,
        #8a2387 44%,
        #e94057,
        #f27121 54%,
        #3a1c71 55%,
        #d76d77,
        #fdbb2d 65%,
        #22c1c3 66%,
        #fdbb2d 76%,
        #1a2a6c 77%,
        #b21f1f,
        #fdbb2d 87%
      );
      animation: sky 240s steps(8, end) infinite forwards;
    }
    input,
    .last {
      z-index: 1;
      position: absolute;
      display: none;
      width: 300vh;
      height: 300vh;
      opacity: 0;
      cursor: pointer;
      pointer-events: auto;
      transform: translate(-150vh, -150vh);
      -webkit-touch-callout: none;
      -webkit-tap-highlight-color: transparent;
    }
    #last {
      display: initial;
      pointer-events: none;
    }
    input:checked,
    #last:checked {
      display: none !important;
    }
    .base {
      position: relative;
      left: calc(50% - 15vh);
      top: 50vh;
      width: 30vh;
      height: 30vh;
      background-color: red;
      pointer-events: none;
      transform: rotateX(45deg) rotateZ(45deg);
      transform-style: preserve-3d;
      transition: transform 0.5s ease-in-out;
    }
    .base::before,
    .base::after {
      content: "";
      z-index: -1;
      position: absolute;
      display: block;
    }
    .base::before {
      right: 0;
      width: 50vh;
      height: 100%;
      background: linear-gradient(to left, #d00, rgba(221, 0, 0, 0));
      transform: rotateY(-90deg);
      transform-origin: right;
    }
    .base::after {
      bottom: 0;
      width: 100%;
      height: 50vh;
      background: linear-gradient(to top, #e00, rgba(238, 0, 0, 0));
      transform: rotateX(90deg);
      transform-origin: bottom;
    }
    .container {
      position: absolute;
      display: flex;
      transform-style: preserve-3d;
    }
    .container.horizontal {
      left: -45vh;
      flex-direction: row;
      width: calc(90vh + 100%);
      height: 100%;
    }
    .container.vertical {
      top: -45vh;
      flex-direction: column;
      width: 100%;
      height: calc(90vh + 100%);
    }
    .container::before,
    .container::after {
      content: "";
    }
    .container.horizontal::before,
    .container.horizontal::after {
      max-width: calc(100% - 45vh);
      min-width: 45vh;
      height: 100%;
    }
    .container.vertical::before,
    .container.vertical::after {
      width: 100%;
      max-height: calc(100% - 45vh);
      min-height: 45vh;
    }
    .block {
      position: relative;
      visibility: hidden;
      flex-grow: 1;
      background-color: currentColor;
      transform: translateZ(6vh);
      transform-style: preserve-3d;
    }
    .block.horizontal {
      height: 100%;
    }
    .block.vertical {
      width: 100%;
    }
    .block.floating {
      position: absolute;
      display: none;
      visibility: visible;
    }
    .block.floating.horizontal {
      width: calc(100% - 90vh);
      animation: left 2s linear alternate infinite both;
    }
    .block.floating.vertical {
      height: calc(100% - 90vh);
      animation: top 2s linear alternate infinite both;
    }
    body {
      counter-reset: points;
    }
    .points {
      display: none;
    }
    .points::after {
      content: counter(points);
    }
    @keyframes opacity {
      0% { opacity: 1; }
      25% { opacity: 1; }
      50% { opacity: 0; }
      75% { opacity: 0; }
      100% { opacity: 1; }
    }
    @keyframes sky {
      from { transform: none; }
      to { transform: translateY(-880vh); }
    }
    @keyframes left {
      from { left: 0; }
      to { left: 90vh; }
    }
    @keyframes top {
      from { top: 0; }
      to { top: 90vh; }
    }
    @keyframes color {
      0% { color: #f00; }
      19% { color: #ff0; }
      31% { color: #0f0; }
      43% { color: #0ff; }
      62% { color: #00f; }
      81% { color: #f0f; }
      100% { color: #f00; }
    }
  </style>
</head>
<body>
  <!-- Интерфейс -->
  <div id="header">
    <div id="info">
      <span id="username">@User</span>
      <div class="balance">
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="Ticket">
        <span id="ticketCount">0</span>
      </div>
      <div class="balance">
        <img src="https://raw.githubusercontent.com/qnexst/404token/main/star.png" alt="Points">
        <span id="pointCount">0</span>
      </div>
    </div>
  </div>
  
  <!-- Временной индикатор (появляется после старта) -->
  <div id="timeBarContainer">
    <div id="timeBar"></div>
  </div>
  
  <div id="backContainer">
    <button id="backBtn" onclick="goBack()">Back</button>
  </div>
  
  <!-- Меню игры -->
  <div id="gameWrapper">
    <button id="startBtn" onclick="startGame()">Start (1 Ticket)</button>
    <!-- Контейнер для Pure CSS STACK игры -->
    <div id="cssGameContainer" style="display: none;">
      <!-- Копия разметки Pure CSS STACK игры из вашего примера -->
      <form class="screen" novalidate>
        <input id="start" type="checkbox" tabindex="-1">
        <input id="end" type="checkbox" tabindex="-1">
        <input id="last" type="checkbox" tabindex="-1">
        <div class="sky">
          <div></div>
          <div></div>
        </div>
        <div class="base">
          <input type="checkbox" tabindex="-1" required>
          <div class="container horizontal">
            <div class="block floating horizontal"></div>
            <div class="block horizontal">
              <input type="checkbox" tabindex="-1">
              <div class="container vertical">
                <div class="block floating vertical"></div>
                <div class="block vertical">
                  <input type="checkbox" tabindex="-1">
                  <div class="container horizontal">
                    <div class="block floating horizontal"></div>
                    <div class="block horizontal">
                      <input type="checkbox" tabindex="-1">
                      <div class="container vertical">
                        <div class="block floating vertical"></div>
                        <div class="block vertical">
                          <input type="checkbox" tabindex="-1">
                          <div class="container horizontal">
                            <div class="block floating horizontal"></div>
                            <div class="block horizontal">
                              <input type="checkbox" tabindex="-1">
                              <div class="container vertical">
                                <div class="block floating vertical"></div>
                                <div class="block vertical">
                                  <input type="checkbox" tabindex="-1">
                                  <div class="container horizontal">
                                    <div class="block floating horizontal"></div>
                                    <div class="block horizontal">
                                      <input type="checkbox" tabindex="-1">
                                      <div class="container vertical">
                                        <div class="block floating vertical"></div>
                                        <div class="block vertical">
                                          <input type="checkbox" tabindex="-1">
                                          <div class="container horizontal">
                                            <div class="block floating horizontal"></div>
                                            <div class="block horizontal">
                                              <input type="checkbox" tabindex="-1">
                                              <div class="container vertical">
                                                <div class="block floating vertical"></div>
                                                <div class="block vertical">
                                                  <input type="checkbox" tabindex="-1">
                                                  <div class="container horizontal">
                                                    <div class="block floating horizontal"></div>
                                                    <div class="block horizontal">
                                                      <input type="checkbox" tabindex="-1">
                                                      <div class="container vertical">
                                                        <div class="block floating vertical"></div>
                                                        <div class="block vertical">
                                                          <input type="checkbox" tabindex="-1">
                                                          <div class="container horizontal">
                                                            <div class="block floating horizontal"></div>
                                                            <div class="block horizontal">
                                                              <input type="checkbox" tabindex="-1">
                                                              <div class="container vertical">
                                                                <div class="block floating vertical"></div>
                                                                <div class="block vertical">
                                                                  <input type="checkbox" tabindex="-1">
                                                                  <div class="container horizontal">
                                                                    <div class="block floating horizontal"></div>
                                                                    <div class="block horizontal">
                                                                      <input type="checkbox" tabindex="-1">
                                                                      <div class="container vertical">
                                                                        <div class="block floating vertical"></div>
                                                                        <div class="block vertical">
                                                                          <input type="checkbox" tabindex="-1">
                                                                          <div class="container horizontal">
                                                                            <div class="block floating horizontal"></div>
                                                                            <div class="block horizontal">
                                                                              <input type="checkbox" tabindex="-1">
                                                                              <div class="container vertical">
                                                                                <div class="block floating vertical"></div>
                                                                                <div class="block vertical">
                                                                                  <input type="checkbox" tabindex="-1">
                                                                                  <div class="container horizontal">
                                                                                    <div class="block floating horizontal"></div>
                                                                                    <div class="block horizontal">
                                                                                      <input type="checkbox" tabindex="-1">
                                                                                      <div class="container vertical">
                                                                                        <div class="block floating vertical"></div>
                                                                                        <div class="block vertical">
                                                                                          <input type="checkbox" tabindex="-1">
                                                                                          <div class="container horizontal">
                                                                                            <div class="block floating horizontal"></div>
                                                                                            <div class="block horizontal">
                                                                                              <input type="checkbox" tabindex="-1">
                                                                                              <div class="container vertical">
                                                                                                <div class="block floating vertical"></div>
                                                                                                <div class="block vertical">
                                                                                                  <input type="checkbox" tabindex="-1">
                                                                                                  <div class="container horizontal">
                                                                                                    <div class="block floating horizontal"></div>
                                                                                                    <div class="block horizontal">
                                                                                                      <input type="checkbox" tabindex="-1">
                                                                                                      <div class="container vertical">
                                                                                                        <div class="block floating vertical"></div>
                                                                                                        <div class="block vertical">
                                                                                                          <input type="checkbox" tabindex="-1">
                                                                                                          <div class="container horizontal">
                                                                                                            <div class="block floating horizontal"></div>
                                                                                                            <div class="block horizontal">
                                                                                                              <input type="checkbox" tabindex="-1">
                                                                                                              <div class="container vertical">
                                                                                                                <div class="block floating vertical"></div>
                                                                                                                <div class="block vertical">
                                                                                                                  <input type="checkbox" tabindex="-1">
                                                                                                                  <div class="container horizontal">
                                                                                                                    <div class="block floating horizontal"></div>
                                                                                                                    <div class="block horizontal">
                                                                                                                      <input type="checkbox" tabindex="-1">
                                                                                                                      <div class="container vertical">
                                                                                                                        <div class="block floating vertical"></div>
                                                                                                                        <div class="block vertical">
                                                                                                                          <input type="checkbox" tabindex="-1">
                                                                                                                          <div class="container horizontal">
                                                                                                                            <div class="block floating horizontal"></div>
                                                                                                                            <div class="block horizontal">
                                                                                                                              <input type="checkbox" tabindex="-1">
                                                                                                                              <div class="container vertical">
                                                                                                                                <div class="block floating vertical"></div>
                                                                                                                                <div class="block vertical">
                                                                                                                                  <input type="checkbox" tabindex="-1">
                                                                                                                                  <div class="container horizontal">
                                                                                                                                    <div class="block floating horizontal"></div>
                                                                                                                                    <div class="block horizontal">
                                                                                                                                      <input type="checkbox" tabindex="-1">
                                                                                                                                      <div class="container vertical">
                                                                                                                                        <div class="block floating vertical"></div>
                                                                                                                                        <div class="block vertical">
                                                                                                                                          <input type="checkbox" tabindex="-1">
                                                                                                                                          <div class="container horizontal">
                                                                                                                                            <div class="block floating horizontal"></div>
                                                                                                                                            <div class="block horizontal">
                                                                                                                                              <label class="last" for="last" tabindex="-1"></label>
                                                                                                                                              <div class="container vertical">
                                                                                                                                                <div class="block floating vertical"></div>
                                                                                                                                                <div class="block vertical">
                                                                                                                                                  <label class="end horizontal" for="end"></label>
                                                                                                                                                  <label class="end vertical" for="end"></label>
                                                                                                                                                </div>
                                                                                                                                              </div>
                                                                                                                                            </div>
                                                                                                                                          </div>
                                                                                                                                        </div>
                                                                                                                                      </div>
                                                                                                                                    </div>
                                                                                                                                  </div>
                                                                                                                                </div>
                                                                                                                              </div>
                                                                                                                            </div>
                                                                                                                          </div>
                                                                                                                        </div>
                                                                                                                      </div>
                                                                                                                    </div>
                                                                                                                  </div>
                                                                                                                </div>
                                                                                                              </div>
                                                                                                            </div>
                                                                                                          </div>
                                                                                                        </div>
                                                                                                      </div>
                                                                                                    </div>
                                                                                                  </div>
                                                                                                </div>
                                                                                              </div>
                                                                                            </div>
                                                                                          </div>
                                                                                        </div>
                                                                                      </div>
                                                                                    </div>
                                                                                  </div>
                                                                                </div>
                                                                              </div>
                                                                            </div>
                                                                          </div>
                                                                        </div>
                                                                      </div>
                                                                    </div>
                                                                  </div>
                                                                </div>
                                                              </div>
                                                            </div>
                                                          </div>
                                                        </div>
                                                      </div>
                                                    </div>
                                                  </div>
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Дополнительный счётчик Pure CSS игры (если используется) -->
  <div id="counter">0</div>
  
  <!-- Модальное окно для окончания игры/уведомлений -->
  <div id="end">
    <div class="modal">
      <h2 id="endTitle"></h2>
      <p id="endMessage"></p>
      <button id="endBtn">OK</button>
    </div>
  </div>
  
  <!-- Звуки -->
  <audio id="bgSound" src="background.mp3" loop></audio>
  <audio id="moveSound" src="move.mp3"></audio>
  <audio id="deathSound" src="death.mp3"></audio>
  
  <script>
    /* 1. Firebase и Telegram */
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev-ex",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  
    let tg = null;
    if (window.Telegram && window.Telegram.WebApp) {
      tg = window.Telegram.WebApp;
      tg.expand();
    }
  
    let currentUser = null;
    let userRef = null;
    let localUserData = { tickets: 0, points: 0 };
    let dataLoaded = false;
    setTimeout(() => { dataLoaded = true; }, 3000);
  
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      currentUser = tg.initDataUnsafe.user;
      document.getElementById('username').textContent = '@' + currentUser.username;
      userRef = db.ref('users/' + currentUser.username);
      userRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          userRef.set({ tickets: 5, points: 0 });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData.tickets = data.tickets || 0;
        localUserData.points = data.points || 0;
        updateHeader();
        dataLoaded = true;
      });
    } else {
      currentUser = { username: 'TestUser' };
      document.getElementById('username').textContent = '@TestUser';
      userRef = db.ref('users/TestUser');
      userRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          userRef.set({ tickets: 5, points: 0 });
        }
      });
      userRef.on('value', snapshot => {
        const data = snapshot.val() || {};
        localUserData.tickets = data.tickets || 0;
        localUserData.points = data.points || 0;
        updateHeader();
        dataLoaded = true;
      });
    }
  
    function updateHeader() {
      document.getElementById('ticketCount').textContent = localUserData.tickets;
      document.getElementById('pointCount').textContent = localUserData.points;
    }
  
    function goBack() {
      window.location.href = 'index.html';
    }
  
    let modalType = "gameOver";
    document.getElementById('endBtn').addEventListener('click', function() {
      if (modalType === "gameOver") {
        goToIndex();
      } else if (modalType === "noTickets") {
        document.getElementById('end').style.visibility = 'hidden';
      }
    });
    function goToIndex() {
      window.location.href = 'index.html';
    }
  
    /* 2. Игровой код (Pure CSS STACK) */
    let gameEnded = false;
    let gameStartTime = null;
    const gameDuration = 300000; // 5 минут
  
    function initGameInterface() {
      gameStartTime = performance.now();
      document.getElementById('timeBarContainer').style.display = 'block';
    }
  
    // Функция завершения игры: воспроизводится звук смерти, итоговые очки записываются в базу, появляется модальное окно
    function endGame() {
      if (gameEnded) return;
      gameEnded = true;
      document.getElementById('deathSound').play().catch(err => console.log(err));
      // Попробуем получить очки из счетчика (Pure CSS может подсчитывать очки через counter)
      let score = 0;
      let pointsEl = document.querySelector('.points');
      if (pointsEl) {
        score = getComputedStyle(pointsEl, '::after').content;
        score = parseInt(score.replace(/"/g, '')) || 0;
      }
      localUserData.points += score;
      if (userRef) userRef.update({ points: localUserData.points });
      modalType = "gameOver";
      document.getElementById('endTitle').textContent = 'Game Over!';
      document.getElementById('endMessage').textContent = 'Your score: ' + score;
      document.getElementById('end').style.visibility = 'visible';
    }
  
    function showNoTicketsModal() {
      modalType = "noTickets";
      document.getElementById('endTitle').textContent = 'Not enough tickets!';
      document.getElementById('endMessage').textContent = 'Please come back later.';
      document.getElementById('end').style.visibility = 'visible';
    }
  
    /* 3. Главный игровой цикл для таймера */
    function animate(timestamp) {
      requestAnimationFrame(animate);
      if (!gameStartTime) return;
      let elapsed = timestamp - gameStartTime;
      let remaining = gameDuration - elapsed;
      let timeBar = document.getElementById('timeBar');
      if (remaining <= 0) {
        timeBar.style.width = "0%";
        if (!gameEnded) {
          endGame();
        }
      } else {
        timeBar.style.width = (remaining / gameDuration * 100) + "%";
      }
    }
    requestAnimationFrame(animate);
  
    /* 4. Функция старта игры */
    document.body.addEventListener('click', () => {
      const bgSound = document.getElementById('bgSound');
      if (bgSound.paused) {
        bgSound.play().catch(err => console.log(err));
      }
    }, { once: true });
  
    function startGame() {
      if (!dataLoaded || localUserData.tickets < 1) {
        showNoTicketsModal();
        return;
      }
      localUserData.tickets--;
      if (userRef) userRef.update({ tickets: localUserData.tickets });
      updateHeader();
      // Скрываем меню: header, Back, Start
      document.getElementById('header').style.display = 'none';
      document.getElementById('backContainer').style.display = 'none';
      document.getElementById('startBtn').style.display = 'none';
      // Показываем игровое поле (Pure CSS игра) и таймер
      document.getElementById('gameWrapper').style.display = 'block';
      document.getElementById('cssGameContainer').style.display = 'block';
      document.getElementById('timeBarContainer').style.display = 'block';
      // Записываем время старта
      gameStartTime = performance.now();
      initGameInterface();
      // ВАЖНО: чтобы запустить анимации Pure CSS игры, автоматически ставим чекбокс "start"
      document.getElementById('start').checked = true;
    }
  </script>
</body>
</html>
