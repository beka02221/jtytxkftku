<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>The Stack + Tickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <!-- Telegram Web App API (если требуется) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <!-- THREE.js, GSAP (для Stack) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/latest/TweenLite.min.js"></script>

  <style>
    /* Сброс и общий фон */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: #00103c;
      font-family: sans-serif;
      overflow: hidden;
    }

    /* Контейнер для всего */
    #container {
      width: 100%; height: 100%;
      position: relative;
    }

    /* Header с билеты/очки/ник */
    #header {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 50px;
      background: #6d4fba;
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    #info {
      display: flex;
      gap: 20px;
      font-size: 10px;
      color: #fff;
      align-items: center;
    }
    .balance {
      display: flex; align-items: center; gap: 4px;
    }
    .balance img {
      width: 16px; height: 16px;
    }

    /* Кнопка Back */
    #backContainer {
      position: absolute;
      top: 50px; left: 10px;
      z-index: 1000;
    }
    #backBtn {
      font-size: 10px;
      padding: 5px 10px;
      background: #06B6D1;
      color: #262626;
      border: none; border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }

    /* Кнопка Start (1 Ticket) */
    #startContainer {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 1100;
    }
    #startBtn {
      font-size: 14px;
      padding: 10px 20px;
      background: #06B6D1;
      color: #262626;
      border: none; border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }

    /* Основная игра (The Stack) */
    #gameCanvas {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: none; /* скрыт до старта */
    }

    /* Модальное окно "нет билетов" */
    #modalNoTickets {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.7);
      z-index: 2000;
      visibility: hidden;
    }
    #modalNoTickets.active { visibility: visible; }
    #modalNoTickets .modal-content {
      background: #222;
      border: 2px solid #0f0;
      border-radius: 8px;
      padding: 20px;
      width: 80%; max-width: 400px;
      text-align: center;
      color: #FF00FF;
      font-size: 14px;
    }
    #modalNoTickets .modal-content button {
      margin-top: 10px;
      font-size: 12px;
      padding: 6px 12px;
      background: #06B6D1;
      color: #262626;
      border: none; border-radius: 4px;
      cursor: pointer;
      box-shadow: 0 3px #6b6b6b;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- 1) Header (Telegram/Firebase) -->
    <div id="header">
      <div id="info">
        <span id="username">@User</span>
        <div class="balance">
          <img src="https://raw.githubusercontent.com/qnexst/404token/main/ticket.png" alt="Ticket">
          <span id="ticketCount">0</span>
        </div>
        <div class="balance">
          <img src="https://raw.githubusercontent.com/qnexst/404token/main/star.png" alt="Points">
          <span id="pointCount">0</span>
        </div>
      </div>
    </div>

    <!-- 2) Кнопка Back -->
    <div id="backContainer">
      <button id="backBtn">Back</button>
    </div>

    <!-- 3) Кнопка Start (1 Ticket) -->
    <div id="startContainer">
      <button id="startBtn">Start (1 Ticket)</button>
    </div>

    <!-- 4) Модальное окно "нет билетов" -->
    <div id="modalNoTickets">
      <div class="modal-content">
        <h3>Not enough tickets!</h3>
        <p>Please come back later.</p>
        <button id="closeNoTicketsBtn">OK</button>
      </div>
    </div>

    <!-- 5) Canvas (The Stack) -->
    <div id="gameCanvas"></div>
  </div>

  <!-- Firebase/Telegram JS, логика -->
  <script>
    /* ---------- Firebase config ---------- */
    const firebaseConfig = {
      apiKey: "AIzaSyB90ev-ex",
      authDomain: "test-with-likes.firebaseapp.com",
      databaseURL: "https://test-with-likes-default-rtdb.firebaseio.com",
      projectId: "test-with-likes",
      storageBucket: "test-with-likes.appspot.com",
      messagingSenderId: "764738820142",
      appId: "1:764738820142:web:b22c6608a30e46cdcea7bf",
      measurementId: "G-WJNF0HSN9P"
    };
    firebase.initializeApp(firebaseConfig);

    let db = firebase.database();

    // Telegram init
    let tgApp = null;
    if (window.Telegram && window.Telegram.WebApp) {
      tgApp = window.Telegram.WebApp;
      tgApp.expand();
    }

    let currentUser = null;
    let userRef = null;
    let localUserData = { tickets: 0, points: 0 };
    let dataLoaded = false;
    setTimeout(() => { dataLoaded = true; }, 3000); // 3 сек. запас

    /* Элементы */
    const usernameElem = document.getElementById('username');
    const ticketCountElem = document.getElementById('ticketCount');
    const pointCountElem = document.getElementById('pointCount');
    const backBtn = document.getElementById('backBtn');
    const startBtn = document.getElementById('startBtn');
    const modalNoTickets = document.getElementById('modalNoTickets');
    const closeNoTicketsBtn = document.getElementById('closeNoTicketsBtn');
    const gameCanvas = document.getElementById('gameCanvas');

    /* Back */
    backBtn.addEventListener('click', () => {
      window.location.href = 'index.html';
    });

    /* "Not enough tickets" модал */
    closeNoTicketsBtn.addEventListener('click', () => {
      modalNoTickets.classList.remove('active');
    });

    /* Telegram user detection */
    if (tgApp && tgApp.initDataUnsafe && tgApp.initDataUnsafe.user) {
      currentUser = tgApp.initDataUnsafe.user;
      usernameElem.textContent = '@' + currentUser.username;
      userRef = db.ref('users/' + currentUser.username);
      userRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          userRef.set({ tickets: 5, points: 0 });
        }
      });
      userRef.on('value', snapshot => {
        let data = snapshot.val() || {};
        localUserData.tickets = data.tickets || 0;
        localUserData.points = data.points || 0;
        updateHeader();
        dataLoaded = true;
      });
    } else {
      // Тест user
      currentUser = { username: 'TestUser' };
      usernameElem.textContent = '@TestUser';
      userRef = db.ref('users/TestUser');
      userRef.once('value').then(snapshot => {
        if (!snapshot.exists()) {
          userRef.set({ tickets: 5, points: 0 });
        }
      });
      userRef.on('value', snapshot => {
        let data = snapshot.val() || {};
        localUserData.tickets = data.tickets || 0;
        localUserData.points = data.points || 0;
        updateHeader();
        dataLoaded = true;
      });
    }

    function updateHeader() {
      ticketCountElem.textContent = localUserData.tickets;
      pointCountElem.textContent = localUserData.points;
    }

    /* Start Button */
    startBtn.addEventListener('click', () => {
      // Проверяем dataLoaded + tickets
      if (!dataLoaded || localUserData.tickets<1) {
        modalNoTickets.classList.add('active');
        return;
      }
      // Списываем 1 билет
      localUserData.tickets--;
      if (userRef) userRef.update({ tickets: localUserData.tickets });
      updateHeader();
      // Прячем header, back, startBtn
      document.getElementById('header').style.display = 'none';
      document.getElementById('backContainer').style.display = 'none';
      document.getElementById('startContainer').style.display = 'none';
      // Показываем Canvas
      gameCanvas.style.display = 'block';
      // Запускаем StackGame
      initStackGame();
    });


    /* ---------- ЛОГИКА StackGame ---------- */
    let scene, camera, renderer;
    let blocks = [];
    let activeBlock = null;
    let lastBlock = null;
    let dimension = 10;
    let blockHeight = 2;
    let indexCount = 0;
    let isGameOver = false;
    let score = 0;

    function initStackGame() {
      // Сбрасываем глобальные
      isGameOver=false;
      score=0;
      blocks=[]; indexCount=0;

      // Создаём Three.js сцену
      scene = new THREE.Scene();
      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.setClearColor("#D0CBC7", 1);
      gameCanvas.innerHTML = ""; // чистим
      gameCanvas.appendChild(renderer.domElement);

      let aspect = window.innerWidth / window.innerHeight;
      let d = 20;
      camera = new THREE.OrthographicCamera(-d*aspect, d*aspect, d, -d, -100, 1000);
      camera.position.set(2, 2, 2);
      camera.lookAt(new THREE.Vector3(0,0,0));
      
      let light = new THREE.DirectionalLight(0xffffff, 0.5);
      light.position.set(0, 499, 0);
      scene.add(light);

      let softLight = new THREE.AmbientLight(0xffffff, 0.4);
      scene.add(softLight);

      // Первый блок (статический)
      let baseBlock = createBlock(10,2,10,0,0,0,"STOPPED");
      blocks.push(baseBlock);
      scene.add(baseBlock.mesh);
      lastBlock=baseBlock;

      // Второй блок (активный?)
      activeBlock = createBlock(10,2,10,0,2,0,"ACTIVE");
      blocks.push(activeBlock);
      scene.add(activeBlock.mesh);

      document.addEventListener('keydown', onActionKey);
      document.addEventListener('click', onActionClick);
      animate();
    }

    function createBlock(w,h,d,x,y,z,state) {
      indexCount++;
      let geometry = new THREE.BoxGeometry(w,h,d);
      geometry.applyMatrix(new THREE.Matrix4().makeTranslation(w/2,h/2,d/2));
      let color = 0x333344;
      let material = new THREE.MeshToonMaterial({color});
      let mesh = new THREE.Mesh(geometry, material);
      mesh.position.set(x,y,z);

      return {
        mesh,
        dimension: { width:w, height:h, depth:d },
        position: { x, y, z },
        state,
        index: indexCount,
        plane: (indexCount%2 ? "x" : "z"),
        direction: (indexCount>1 ? -0.1-indexCount*0.005 : 0),
        speed: (indexCount>1 ? -0.1-indexCount*0.005 : 0)
      };
    }

    function placeBlock() {
      // Проверяем overlap
      if (!activeBlock || !lastBlock) return;
      let plane = activeBlock.plane;
      let overlapDimension = plane=="x" ? "width":"depth";

      let overlap = lastBlock.dimension[overlapDimension] -
        Math.abs(activeBlock.position[plane] - lastBlock.position[plane]);
      if (overlap <= 0) {
        // GAME OVER
        gameOver();
      } else {
        // Успешно, обновляем score:
        score++;
        // Вычитаем overlap, перестраиваем
        activeBlock.state="STOPPED";
        // создаём новый activeBlock
        lastBlock=activeBlock;
        activeBlock = createBlock(lastBlock.dimension.width,2,lastBlock.dimension.depth, lastBlock.position.x, lastBlock.position.y+2, lastBlock.position.z, "ACTIVE");
        scene.add(activeBlock.mesh);
        blocks.push(activeBlock);
      }
    }

    function gameOver() {
      isGameOver=true;
      // При gameOver прибавляем score к Firebase points
      localUserData.points += score;
      if (userRef) userRef.update({ points: localUserData.points });
      // Переходим на index.html
      window.location.href = 'index.html';
    }

    function onActionKey(e) {
      if (e.keyCode==32) doAction();
    }
    function onActionClick(e) {
      doAction();
    }
    function doAction() {
      if (isGameOver) return;
      placeBlock();
    }

    function animate() {
      requestAnimationFrame(animate);
      renderer.render(scene, camera);
      // Двигаем activeBlock
      if (!isGameOver && activeBlock && activeBlock.state=="ACTIVE") {
        let plane = activeBlock.plane;
        let val = activeBlock.position[plane];
        if (val>12 || val<-12) activeBlock.direction*=-1;
        activeBlock.position[plane]+= activeBlock.direction;
        activeBlock.mesh.position[plane]= activeBlock.position[plane];
      }
    }
  </script>
</body>
</html>
